
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="../kernel/" rel="prev"/>
<link href="../hardware/" rel="next"/>
<link href="../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.4.3, mkdocs-material-9.1.11" name="generator"/>
<title>Tiny embedded system with BusyBox - Embedded Systems Linux Development Notes</title>
<link href="../../assets/stylesheets/main.85bb2934.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body dir="ltr">
<script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#tiny-embedded-system-with-busybox">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="Embedded Systems Linux Development Notes" class="md-header__button md-logo" data-md-component="logo" href="../.." title="Embedded Systems Linux Development Notes">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            Embedded Systems Linux Development Notes
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Tiny embedded system with BusyBox
            
          </span>
</div>
</div>
</div>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="Embedded Systems Linux Development Notes" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="Embedded Systems Linux Development Notes">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
    Embedded Systems Linux Development Notes
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../..">
        Overview
      </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          QEMU variant
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
          QEMU variant
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../qemu/virtualbox/">
        Host VM
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../qemu/toolchain/">
        Building a cross-compile toolchain
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../qemu/bootloader/">
        Bootloader - U-Boot
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../qemu/kernel/">
        Linux Kernel
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../qemu/tinysystem/">
        Tiny embedded system with BusyBox
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../qemu/hardware/">
        Accessing Hardware Devices
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../qemu/blockfs/">
        Block Filesystems
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../qemu/thirdparty/">
        Third-party libraries and apps
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../qemu/buildroot/">
        Buildroot
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../qemu/appdev/">
        App - Development
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../qemu/debugging/">
        App - Remote debug
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../qemu/debootstrap/">
        debootstrap
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          BeagleBone Black variant
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
          BeagleBone Black variant
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../virtualbox/">
        Host VM
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../toolchain/">
        Building a cross-compile toolchain
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../bootloader/">
        Bootloader - U-Boot
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../kernel/">
        Linux Kernel
      </a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
          Tiny embedded system with BusyBox
          <span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
        Tiny embedded system with BusyBox
      </a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#objectives">
    Objectives
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#required-tools">
    Required tools
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#overview">
    Overview
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#kernel-configuration">
    Kernel configuration
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#nfs-server">
    NFS server
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#booting-the-system">
    Booting the system
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#root-filesystem-with-busybox">
    Root filesystem with BusyBox
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#virtual-filesystems">
    Virtual filesystems
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#system-configuration-and-startup">
    System configuration and startup
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#switching-to-shared-libraries">
    Switching to shared libraries
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#implement-a-web-interface-for-your-device">
    Implement a web interface for your device
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#backup-and-restore">
    Backup and restore
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#boot-with-initramfs">
    Boot with initramfs
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#licensing">
    Licensing
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../hardware/">
        Accessing Hardware Devices
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../blockfs/">
        Block Filesystems
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../thirdparty/">
        Third-party libraries and apps
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../buildroot/">
        Buildroot
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../integration/">
        System integration
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../appdev/">
        App - Development
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          Knowledge Base
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
          Knowledge Base
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../kb/git-hash/">
        git commit hash expansion
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kb/menuconfig/">
        menuconfig
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kb/processors/">
        Processors
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../copying/">
        Copying this document
      </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#objectives">
    Objectives
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#required-tools">
    Required tools
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#overview">
    Overview
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#kernel-configuration">
    Kernel configuration
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#nfs-server">
    NFS server
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#booting-the-system">
    Booting the system
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#root-filesystem-with-busybox">
    Root filesystem with BusyBox
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#virtual-filesystems">
    Virtual filesystems
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#system-configuration-and-startup">
    System configuration and startup
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#switching-to-shared-libraries">
    Switching to shared libraries
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#implement-a-web-interface-for-your-device">
    Implement a web interface for your device
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#backup-and-restore">
    Backup and restore
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#boot-with-initramfs">
    Boot with initramfs
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#licensing">
    Licensing
  </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="tiny-embedded-system-with-busybox"><span class="enumerate-headings-plugin enumerate-heading-plugin">18.</span> Tiny embedded system with BusyBox</h1>
<h2 id="objectives"><span class="enumerate-headings-plugin enumerate-heading-plugin">18.1</span> Objectives</h2>
<ul>
<li>
<p>Make a tiny yet full-featured embedded system.</p>
</li>
<li>
<p>Be able to configure and build a Linux kernel that boots on a directory on your workstation, shared through the network by <em>NFS</em>.</p>
</li>
<li>
<p>Be able to create and configure a minimalistic root filesystem from scratch (<em>ex nihilo</em>, out of nothing, entirely hand made...) for your target board.</p>
</li>
<li>
<p>Understand how small and simple an embedded Linux system can be.</p>
</li>
<li>
<p>Be able to install <em>BusyBox</em> on this filesystem.</p>
</li>
<li>
<p>Be able to create a simple startup script based on <code>/sbin/init</code>.</p>
</li>
<li>
<p>Be able to set up a simple web interface for the target.</p>
</li>
</ul>
<h2 id="required-tools"><span class="enumerate-headings-plugin enumerate-heading-plugin">18.2</span> Required tools</h2>
<ul>
<li>
<p>Our <a href="../toolchain/"><em>cross-compile toolchain</em></a></p>
</li>
<li>
<p>Ubuntu packages:</p>
<p><code>nfs-kernel-server</code></p>
<p>plus those from the previous labs.</p>
</li>
<li>
<p><a href="https://busybox.net/"><em>BusyBox</em></a>, either as:</p>
<ul>
<li>
<p><a href="https://git.busybox.net/busybox/"><em>git</em> repository</a> tag <code>1_35_0</code></p>
</li>
<li>
<p><a href="https://git.busybox.net/busybox/snapshot/busybox-1_35_0.tar.bz2">Source code archive for release <code>1_35_0</code></a></p>
</li>
</ul>
</li>
</ul>
<h2 id="overview"><span class="enumerate-headings-plugin enumerate-heading-plugin">18.3</span> Overview</h2>
<p>While developing a <em>root filesystem</em> for a device, a developer needs to make frequent changes to the filesystem contents, like modifying scripts or adding newly compiled programs.</p>
<p>It isn’t practical at all to reflash the root filesystem on the target every time a change is made.<br/>
Fortunately, it is possible to set up networking between the development workstation and the target. Then, workstation files can be accessed by the target through the network, using NFS.</p>
<p>Unless you test a boot sequence, you no longer need to reboot the target to test the impact of script or application updates.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-0-1"><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">$ </span><span class="nv">LAB_PATH</span><span class="o">=</span><span class="s2">"</span><span class="nv">$HOME</span><span class="s2">/embedded-linux-bbb-labs/tinysystem"</span>
</span></code></pre></div>
<h2 id="kernel-configuration"><span class="enumerate-headings-plugin enumerate-heading-plugin">18.4</span> Kernel configuration</h2>
<p>We'll re-use the kernel sources from the <a href="../kernel/">kernel lab</a>.</p>
<p>In the kernel configuration (see: <a href="../../kb/menuconfig/"><code>menuconfig</code></a>) verify that you have all the options needed for booting the system using a root filesystem mounted over NFS. Also enable the automatic mount of <code>devtmpfs</code>.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-1-1"><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/../kernel/linux"</span>
</span><span id="__span-1-2"><a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="gp">$ </span>cp<span class="w"> </span>../kernel.config<span class="w"> </span>.config
</span><span id="__span-1-3"><a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="gp">$ </span>make<span class="w"> </span>menuconfig
</span></code></pre></div>
<p>In <code>File systems</code>:</p>
<ul>
<li>
<p>Enable <code>Network File Systems</code> (<code>NETWORK_FILESYSTEMS</code>), which should enable also the <em>client</em> for <em>v2</em> and <em>v3</em>.<br/>
  Inside this menu entry:</p>
<ul>
<li>Enable <code>Root file system on NFS</code> (<code>ROOT_NFS</code>).</li>
</ul>
</li>
</ul>
<p>In <code>Device Drivers</code> → <code>Generic Driver Options</code>:</p>
<ul>
<li>Enable <code>Maintain a devtmpfs filesystem to mount at /dev</code> (<code>CONFIG_DEVTMPFS_MOUNT</code>).</li>
</ul>
<p>Everything should already be as expected. If necessary, backup the new configuration and rebuild the kernel:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-2-1"><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="gp">$ </span>cp<span class="w"> </span>.config<span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/kernel-busybox.config"</span>
</span><span id="__span-2-2"><a href="#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="gp">$ </span>make
</span></code></pre></div>
<h2 id="nfs-server"><span class="enumerate-headings-plugin enumerate-heading-plugin">18.5</span> NFS server</h2>
<p>A NFS server is provided by the <code>nfs-kernel-server</code> package:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-3-1"><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="gp">$ </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>nfs-kernel-server
</span></code></pre></div>
<p>Create a <code>nfsroot</code> directory in the current lab directory. We're going to use this folder as our NFS <em>root</em> folder.<br/>
If we were to add it directly, we would need to specify the whole path when requesting files from it, which might become verbose, and exposes our private paths to the public.
Instead, we can create a <em>symbolic link</em> at <code>/srv/nfs/</code>, and we can assign it the same <code>tftp</code> group of the previous labs:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-4-1"><a href="#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="gp">$ </span>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/nfsroot"</span>
</span><span id="__span-4-2"><a href="#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="gp">$ </span>sudo<span class="w"> </span>rm<span class="w"> </span>-rf<span class="w"> </span>/srv/nfs
</span><span id="__span-4-3"><a href="#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="gp">$ </span>sudo<span class="w"> </span>ln<span class="w"> </span>-snv<span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/nfsroot"</span><span class="w"> </span>/srv/nfs
</span><span id="__span-4-4"><a href="#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="go">'/srv/nfs' -&gt; '/home/me/embedded-linux-bbb-labs/tinysystem/nfsroot'</span>
</span><span id="__span-4-5"><a href="#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="gp">$ </span>sudo<span class="w"> </span>chown<span class="w"> </span>-R<span class="w"> </span>tftp:tftp<span class="w"> </span>/srv/nfs
</span></code></pre></div>
<p>Once installed, edit the <code>/etc/exports</code> file (as <em>root</em>) to export our <code>nfsroot</code> to the whole <code>192.168.0.x</code> subnet, with some specific options:</p>
<div class="language-text highlight"><span class="filename">File: /etc/exports - line to append</span><pre><span></span><code><span id="__span-5-1"><a href="#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a>/srv/nfs 192.168.0.0/255.255.255.0(rw,no_root_squash,no_subtree_check)
</span></code></pre></div>
<p>A quick way is by appending that line to the file via a shell command.
In our example we use <code>tee</code> (we cannot <code>sudo echo "text" &gt;&gt; file</code>!):</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-6-1"><a href="#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="gp">$ </span><span class="nv">NET_IP</span><span class="o">=</span><span class="s2">"192.168.0.0"</span>
</span><span id="__span-6-2"><a href="#__codelineno-6-2" id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="gp">$ </span><span class="nv">NET_MASK</span><span class="o">=</span><span class="s2">"255.255.255.0"</span>
</span><span id="__span-6-3"><a href="#__codelineno-6-3" id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="gp">$ </span><span class="nv">line</span><span class="o">=</span><span class="s2">"</span><span class="nv">$NFS_ROOT</span><span class="s2"> </span><span class="nv">$NET_IP</span><span class="s2">/</span><span class="nv">$NET_MASK</span><span class="s2">(rw,no_root_squash,no_subtree_check)"</span>
</span><span id="__span-6-4"><a href="#__codelineno-6-4" id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="gp">$ </span><span class="nb">echo</span><span class="w"> </span><span class="nv">$line</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span>/etc/exports
</span><span id="__span-6-5"><a href="#__codelineno-6-5" id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="go">/srv/nfs 192.168.0.0/255.255.255.0(rw,no_root_squash,no_subtree_check)</span>
</span></code></pre></div>
<p>Make sure that the path and the options are on the same line. Also make sure that there is <strong>no space</strong> between the IP address and the NFS options, otherwise default options will be used for this IP address, causing your root filesystem to be read-only.</p>
<p>Then, restart the NFS server with the new configuration:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-7-1"><a href="#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="gp">$ </span>sudo<span class="w"> </span>exportfs<span class="w"> </span>-ar
</span><span id="__span-7-2"><a href="#__codelineno-7-2" id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="gp">$ </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>nfs-kernel-server
</span></code></pre></div>
<h2 id="booting-the-system"><span class="enumerate-headings-plugin enumerate-heading-plugin">18.6</span> Booting the system</h2>
<p>Let's connect <code>picocomBBB</code> and run our <em>U-Boot</em> on the board.<br/>
Press any key as soon as the board boots, to stop <em>U-Boot</em> and enter its prompt.</p>
<blockquote>
<p>A separate shell is suggested for <code>picocomBBB</code> instances from now on.</p>
</blockquote>
<div class="language-console highlight"><span class="filename">picocomBBB - U-Boot</span><pre><span></span><code><span id="__span-8-1"><a href="#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="gp">$ </span>picocomBBB
</span><span id="__span-8-2"><a href="#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="go">    ...</span>
</span><span id="__span-8-3"><a href="#__codelineno-8-3" id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="go">Terminal ready</span>
</span><span id="__span-8-4"><a href="#__codelineno-8-4" id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="go">    ...</span>
</span><span id="__span-8-5"><a href="#__codelineno-8-5" id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="go">Hit any key to stop autoboot:  0</span>
</span><span id="__span-8-6"><a href="#__codelineno-8-6" id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="go">=&gt;</span>
</span></code></pre></div>
<p>Before booting the kernel, we need to tell it that the root filesystem should be mounted over NFS, by setting some kernel parameters.<br/>
So, add the required settings to the <code>bootargs</code> environment variable (on a single long line!), and save it permanently:</p>
<div class="language-text highlight"><span class="filename">picocomBBB - U-Boot</span><pre><span></span><code><span id="__span-9-1"><a href="#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a>=&gt; setenv netmask 255.255.255.0
</span><span id="__span-9-2"><a href="#__codelineno-9-2" id="__codelineno-9-2" name="__codelineno-9-2"></a>=&gt; setenv servernfs /srv/nfs
</span><span id="__span-9-3"><a href="#__codelineno-9-3" id="__codelineno-9-3" name="__codelineno-9-3"></a>=&gt; setenv netif eth0
</span><span id="__span-9-4"><a href="#__codelineno-9-4" id="__codelineno-9-4" name="__codelineno-9-4"></a>=&gt; setenv bootargs_nfs "console=ttyS0,115200n8  root=/dev/nfs  ip=$ipaddr::$serverip:$netmask::$netif  nfsroot=$serverip:$servernfs,nfsvers=3,tcp  rw"
</span><span id="__span-9-5"><a href="#__codelineno-9-5" id="__codelineno-9-5" name="__codelineno-9-5"></a>=&gt; setenv bootargs $bootargs_nfs
</span><span id="__span-9-6"><a href="#__codelineno-9-6" id="__codelineno-9-6" name="__codelineno-9-6"></a>=&gt; printenv bootargs
</span><span id="__span-9-7"><a href="#__codelineno-9-7" id="__codelineno-9-7" name="__codelineno-9-7"></a>bootargs=console=ttyS0,115200n8 root=/dev/nfs ip=192.168.0.69::192.168.0.15:255.255.255.0::eth0 nfsroot=192.168.0.15:/srv/nfs,nfsvers=3,tcp rw
</span><span id="__span-9-8"><a href="#__codelineno-9-8" id="__codelineno-9-8" name="__codelineno-9-8"></a>=&gt; saveenv
</span></code></pre></div>
<ul>
<li>
<p><code>console</code>: the debug console.</p>
</li>
<li>
<p><code>root</code>: mounting to the standard virtual device for NFS.</p>
</li>
<li>
<p><code>ip</code>: a detailed string with all the network parameters, for the maximum portability.</p>
</li>
<li>
<p><code>nfsroot</code>: the path to the NFS folder on the server, as seen form the net, with the specified protocol.</p>
</li>
<li>
<p><code>rw</code>: read and write permissions.</p>
</li>
</ul>
<p>Now, reboot your system. The kernel should be able to mount the root filesystem over NFS (it might take some time to get there).</p>
<div class="language-text highlight"><span class="filename">picocomBBB - U-Boot &amp; Kernel</span><pre><span></span><code><span id="__span-10-1"><a href="#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a>=&gt; reset
</span><span id="__span-10-2"><a href="#__codelineno-10-2" id="__codelineno-10-2" name="__codelineno-10-2"></a>    ...
</span><span id="__span-10-3"><a href="#__codelineno-10-3" id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="hll">VFS: Mounted root (nfs filesystem) on device 0:16.
</span></span><span id="__span-10-4"><a href="#__codelineno-10-4" id="__codelineno-10-4" name="__codelineno-10-4"></a>    ...
</span></code></pre></div>
<p>If the kernel fails to mount the NFS filesystem, look carefully at the error messages in the console.<br/>
If this doesn’t give any clue, you can also have a look at the NFS server logs in <code>/var/log/syslog</code>.</p>
<p>However, at this stage, the kernel should stop because of the following issue:</p>
<div class="language-text highlight"><span class="filename">picocomBBB - Kernel</span><pre><span></span><code><span id="__span-11-1"><a href="#__codelineno-11-1" id="__codelineno-11-1" name="__codelineno-11-1"></a>    ...
</span><span id="__span-11-2"><a href="#__codelineno-11-2" id="__codelineno-11-2" name="__codelineno-11-2"></a>VFS: Mounted root (nfs filesystem) on device 0:16.
</span><span id="__span-11-3"><a href="#__codelineno-11-3" id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="hll">devtmpfs: error mounting -2
</span></span><span id="__span-11-4"><a href="#__codelineno-11-4" id="__codelineno-11-4" name="__codelineno-11-4"></a>    ...
</span><span id="__span-11-5"><a href="#__codelineno-11-5" id="__codelineno-11-5" name="__codelineno-11-5"></a>---[ end Kernel panic - not syncing: No working init found.  Try passing init= option to kernel. See Linux Documentation/admin-guide/init.rst for guidance. ]---
</span></code></pre></div>
<p>This happens because the kernel is trying to mount the devtmpfs filesystem in <code>/dev/</code> in the root filesystem.
This virtual filesystem contains device files for all the devices known to the kernel, and with <code>CONFIG_DEVTMPFS_MOUNT</code>, our kernel tries to automatically mount <code>devtmpfs</code> on <code>/dev</code>.</p>
<p>To address this, just create a <code>dev</code> directory under <code>nfsroot</code>:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-12-1"><a href="#__codelineno-12-1" id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="gp">$ </span>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/nfsroot/dev/"</span>
</span></code></pre></div>
<p>Now reset the board. The kernel should complain for the last time, saying that it can’t find an <code>init</code> application:</p>
<div class="language-text highlight"><span class="filename">picocomBBB - Kernel</span><pre><span></span><code><span id="__span-13-1"><a href="#__codelineno-13-1" id="__codelineno-13-1" name="__codelineno-13-1"></a>    ...
</span><span id="__span-13-2"><a href="#__codelineno-13-2" id="__codelineno-13-2" name="__codelineno-13-2"></a>VFS: Mounted root (nfs filesystem) on device 0:16.
</span><span id="__span-13-3"><a href="#__codelineno-13-3" id="__codelineno-13-3" name="__codelineno-13-3"></a>devtmpfs: mounted
</span><span id="__span-13-4"><a href="#__codelineno-13-4" id="__codelineno-13-4" name="__codelineno-13-4"></a>    ...
</span><span id="__span-13-5"><a href="#__codelineno-13-5" id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="hll">---[ end Kernel panic - not syncing: No working init found.  Try passing init= option to kernel. See Linux Documentation/admin-guide/init.rst for guidance. ]---
</span></span></code></pre></div>
<p>Obviously, our <em>root</em> filesystem being mostly empty, there isn’t such an application yet.
In the next paragraph, you will add <em>BusyBox</em> to your root filesystem, and finally make it usable.</p>
<h2 id="root-filesystem-with-busybox"><span class="enumerate-headings-plugin enumerate-heading-plugin">18.7</span> Root filesystem with BusyBox</h2>
<p>Download the sources of <em>BusyBox</em> release <code>1.35.0</code>:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-14-1"><a href="#__codelineno-14-1" id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span><span class="nv">$LAB_PATH</span>
</span><span id="__span-14-2"><a href="#__codelineno-14-2" id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="gp">$ </span><span class="nv">label</span><span class="o">=</span><span class="s2">"1_35_0"</span>
</span><span id="__span-14-3"><a href="#__codelineno-14-3" id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="gp">$ </span>git<span class="w"> </span>clone<span class="w"> </span>https://git.busybox.net/busybox
</span><span id="__span-14-4"><a href="#__codelineno-14-4" id="__codelineno-14-4" name="__codelineno-14-4"></a><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span>busybox/
</span><span id="__span-14-5"><a href="#__codelineno-14-5" id="__codelineno-14-5" name="__codelineno-14-5"></a><span class="gp">$ </span>git<span class="w"> </span>checkout<span class="w"> </span>-b<span class="w"> </span>embedded-linux-bbb<span class="w"> </span><span class="nv">$label</span>
</span></code></pre></div>
<p>Alternatively, you can get a source code archive:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-15-1"><a href="#__codelineno-15-1" id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span><span class="nv">$LAB_PATH</span>
</span><span id="__span-15-2"><a href="#__codelineno-15-2" id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="gp">$ </span><span class="nv">label</span><span class="o">=</span><span class="s2">"1_35_0"</span>
</span><span id="__span-15-3"><a href="#__codelineno-15-3" id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="gp">$ </span>wget<span class="w"> </span><span class="s2">"https://git.busybox.net/busybox/snapshot/busybox-</span><span class="si">${</span><span class="nv">label</span><span class="si">}</span><span class="s2">.tar.bz2"</span>
</span><span id="__span-15-4"><a href="#__codelineno-15-4" id="__codelineno-15-4" name="__codelineno-15-4"></a><span class="gp">$ </span>tar<span class="w"> </span>xfv<span class="w"> </span><span class="s2">"busybox-</span><span class="si">${</span><span class="nv">label</span><span class="si">}</span><span class="s2">.tar.bz2"</span>
</span><span id="__span-15-5"><a href="#__codelineno-15-5" id="__codelineno-15-5" name="__codelineno-15-5"></a><span class="gp">$ </span>mv<span class="w"> </span>busybox*/<span class="w"> </span>busybox
</span><span id="__span-15-6"><a href="#__codelineno-15-6" id="__codelineno-15-6" name="__codelineno-15-6"></a><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span>busybox/
</span></code></pre></div>
<p>Now, configure <em>BusyBox</em> with the configuration file provided in the <code>data/</code> directory.<br/>
Then, you can run <code>make menuconfig</code> to further customize the configuration.
At least, keep the setting that builds a static <em>BusyBox</em>. Compiling it statically in the first place makes it easy to set up the system, because there are no dependencies. Later on, we will set up shared libraries and recompile <em>BusyBox</em>.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-16-1"><a href="#__codelineno-16-1" id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="gp">$ </span>cp<span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/data/busybox-1.35.config"</span><span class="w"> </span>.config
</span><span id="__span-16-2"><a href="#__codelineno-16-2" id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="gp">$ </span>make<span class="w"> </span>menuconfig
</span></code></pre></div>
<p>Build BusyBox using the toolchain that you used to build the kernel.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-17-1"><a href="#__codelineno-17-1" id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="gp">$ </span><span class="nv">TC_NAME</span><span class="o">=</span><span class="s2">"arm-training-linux-uclibcgnueabihf"</span>
</span><span id="__span-17-2"><a href="#__codelineno-17-2" id="__codelineno-17-2" name="__codelineno-17-2"></a><span class="gp">$ </span><span class="nv">TC_BASE</span><span class="o">=</span><span class="s2">"</span><span class="nv">$HOME</span><span class="s2">/x-tools/</span><span class="nv">$TC_NAME</span><span class="s2">"</span>
</span><span id="__span-17-3"><a href="#__codelineno-17-3" id="__codelineno-17-3" name="__codelineno-17-3"></a><span class="gp">$ </span><span class="nb">export</span><span class="w"> </span><span class="nv">PATH</span><span class="o">=</span><span class="s2">"</span><span class="nv">$TC_BASE</span><span class="s2">/bin:</span><span class="nv">$PATH</span><span class="s2">"</span>
</span><span id="__span-17-4"><a href="#__codelineno-17-4" id="__codelineno-17-4" name="__codelineno-17-4"></a><span class="gp">$ </span><span class="nb">export</span><span class="w"> </span><span class="nv">CROSS_COMPILE</span><span class="o">=</span>arm-linux-
</span><span id="__span-17-5"><a href="#__codelineno-17-5" id="__codelineno-17-5" name="__codelineno-17-5"></a><span class="gp">$ </span><span class="nb">export</span><span class="w"> </span><span class="nv">MAKEFLAGS</span><span class="o">=</span>-j<span class="k">$(</span>nproc<span class="k">)</span>
</span><span id="__span-17-6"><a href="#__codelineno-17-6" id="__codelineno-17-6" name="__codelineno-17-6"></a><span class="gp">$ </span>make
</span></code></pre></div>
<p>Going back to the <em>BusyBox</em> configuration interface, check the installation directory. Set it to the path to your <code>nfsroot</code> directory if necessary.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-18-1"><a href="#__codelineno-18-1" id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="gp">$ </span>make<span class="w"> </span>menuconfig
</span></code></pre></div>
<p><code>Settings</code> → <code>Install Options</code> → <code>Destination path for 'make install'</code> (<code>PREFIX</code>) = <code>../nfsroot</code></p>
<p>Now run <code>make install</code> to install <em>BusyBox</em> in this directory.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-19-1"><a href="#__codelineno-19-1" id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="gp">$ </span>cp<span class="w"> </span>.config<span class="w"> </span>../busybox-static.config
</span><span id="__span-19-2"><a href="#__codelineno-19-2" id="__codelineno-19-2" name="__codelineno-19-2"></a><span class="gp">$ </span>make<span class="w"> </span>install
</span></code></pre></div>
<p>Try to boot your new system on the board. You should now reach a command line prompt, allowing you to execute the commands of your choice.</p>
<div class="language-text highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-20-1"><a href="#__codelineno-20-1" id="__codelineno-20-1" name="__codelineno-20-1"></a>    ...
</span><span id="__span-20-2"><a href="#__codelineno-20-2" id="__codelineno-20-2" name="__codelineno-20-2"></a>can't run '/etc/init.d/rcS': No such file or directory
</span><span id="__span-20-3"><a href="#__codelineno-20-3" id="__codelineno-20-3" name="__codelineno-20-3"></a>
</span><span id="__span-20-4"><a href="#__codelineno-20-4" id="__codelineno-20-4" name="__codelineno-20-4"></a><span class="hll">Please press Enter to activate this console.
</span></span></code></pre></div>
<p>You can press <span class="keys"><kbd class="key-enter">Enter</kbd></span> to enter a <em>root</em> login shell.
Ignore any warning messages for now.</p>
<h2 id="virtual-filesystems"><span class="enumerate-headings-plugin enumerate-heading-plugin">18.8</span> Virtual filesystems</h2>
<p>Within the target shell, run the <code>ps</code> command. You can see that it complains that the <code>/proc</code> directory does not exist. The <code>ps</code> command and other process-related commands use the <code>proc</code> <em>virtual filesystem</em> to
get their information from the kernel.</p>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-21-1"><a href="#__codelineno-21-1" id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="gp"># </span>ps
</span><span id="__span-21-2"><a href="#__codelineno-21-2" id="__codelineno-21-2" name="__codelineno-21-2"></a><span class="go">  PID USER       VSZ STAT COMMAND</span>
</span><span id="__span-21-3"><a href="#__codelineno-21-3" id="__codelineno-21-3" name="__codelineno-21-3"></a><span class="hll"><span class="go">ps: can't open '/proc': No such file or directory</span>
</span></span></code></pre></div>
<p>From the command line of the target, create the <code>proc</code>, <code>sys</code> and <code>etc</code> directories in your
<em>root</em> filesystem:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-22-1"><a href="#__codelineno-22-1" id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/nfsroot/"</span>
</span><span id="__span-22-2"><a href="#__codelineno-22-2" id="__codelineno-22-2" name="__codelineno-22-2"></a><span class="gp">$ </span>mkdir<span class="w"> </span>proc<span class="w"> </span>sys<span class="w"> </span>etc
</span></code></pre></div>
<p>Now mount the <code>proc</code> virtual filesystem. Now that <code>/proc</code> is available, test again the <code>ps</code> command.</p>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-23-1"><a href="#__codelineno-23-1" id="__codelineno-23-1" name="__codelineno-23-1"></a><span class="gp"># </span>mount<span class="w"> </span>-t<span class="w"> </span>proc<span class="w"> </span>proc<span class="w"> </span>/proc
</span><span id="__span-23-2"><a href="#__codelineno-23-2" id="__codelineno-23-2" name="__codelineno-23-2"></a><span class="gp"># </span>ps
</span><span id="__span-23-3"><a href="#__codelineno-23-3" id="__codelineno-23-3" name="__codelineno-23-3"></a><span class="go">  PID USER       VSZ STAT COMMAND</span>
</span><span id="__span-23-4"><a href="#__codelineno-23-4" id="__codelineno-23-4" name="__codelineno-23-4"></a><span class="go">    1 0          512 S    /sbin/init</span>
</span><span id="__span-23-5"><a href="#__codelineno-23-5" id="__codelineno-23-5" name="__codelineno-23-5"></a><span class="go">    2 0            0 SW   [kthreadd]</span>
</span><span id="__span-23-6"><a href="#__codelineno-23-6" id="__codelineno-23-6" name="__codelineno-23-6"></a><span class="go">    3 0            0 IW&lt;  [rcu_gp]</span>
</span><span id="__span-23-7"><a href="#__codelineno-23-7" id="__codelineno-23-7" name="__codelineno-23-7"></a><span class="go">    4 0            0 IW&lt;  [rcu_par_gp]</span>
</span><span id="__span-23-8"><a href="#__codelineno-23-8" id="__codelineno-23-8" name="__codelineno-23-8"></a><span class="go">    5 0            0 IW&lt;  [netns]</span>
</span><span id="__span-23-9"><a href="#__codelineno-23-9" id="__codelineno-23-9" name="__codelineno-23-9"></a><span class="go">    ...</span>
</span></code></pre></div>
<p>Note that you can also now <em>halt</em> your target with the <code>halt</code> command, thanks to <code>proc</code> being mounted.<br/>
The <code>halt</code> command can find the list of mounted filesystems in <code>/proc/mounts</code>, and <em>unmount</em> them in a clean way before shutting down.</p>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-24-1"><a href="#__codelineno-24-1" id="__codelineno-24-1" name="__codelineno-24-1"></a><span class="gp"># </span>halt
</span><span id="__span-24-2"><a href="#__codelineno-24-2" id="__codelineno-24-2" name="__codelineno-24-2"></a><span class="go">starting pid 88, tty '': 'umount -a -r'</span>
</span><span id="__span-24-3"><a href="#__codelineno-24-3" id="__codelineno-24-3" name="__codelineno-24-3"></a><span class="go">umount: devtmpfs busy - remounted read-only</span>
</span><span id="__span-24-4"><a href="#__codelineno-24-4" id="__codelineno-24-4" name="__codelineno-24-4"></a><span class="go">starting pid 89, tty '': 'swapoff -a'</span>
</span><span id="__span-24-5"><a href="#__codelineno-24-5" id="__codelineno-24-5" name="__codelineno-24-5"></a><span class="go">swapoff: can't open '/etc/fstab': No such file or directory</span>
</span><span id="__span-24-6"><a href="#__codelineno-24-6" id="__codelineno-24-6" name="__codelineno-24-6"></a><span class="go">The system is going down NOW!</span>
</span><span id="__span-24-7"><a href="#__codelineno-24-7" id="__codelineno-24-7" name="__codelineno-24-7"></a><span class="go">Sent SIGTERM to all processes</span>
</span><span id="__span-24-8"><a href="#__codelineno-24-8" id="__codelineno-24-8" name="__codelineno-24-8"></a><span class="go">Sent SIGKILL to all processes</span>
</span><span id="__span-24-9"><a href="#__codelineno-24-9" id="__codelineno-24-9" name="__codelineno-24-9"></a><span class="go">Requesting system halt</span>
</span><span id="__span-24-10"><a href="#__codelineno-24-10" id="__codelineno-24-10" name="__codelineno-24-10"></a><span class="go">reboot: System halted</span>
</span></code></pre></div>
<p>You can now disconnect and turn off the board, this time more safely.</p>
<h2 id="system-configuration-and-startup"><span class="enumerate-headings-plugin enumerate-heading-plugin">18.9</span> System configuration and startup</h2>
<p>The first user space program that gets executed by the kernel is <code>/sbin/init</code>, whose configuration
file is <code>/etc/inittab</code>.</p>
<p>In the <em>BusyBox</em> sources, read details about <code>/etc/inittab</code> in the <code>examples/inittab</code> file (press <span class="keys"><kbd class="key-q">Q</kbd></span> to quit from <code>less</code>). Let's create it from the example template; we'll tweak it soon.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-25-1"><a href="#__codelineno-25-1" id="__codelineno-25-1" name="__codelineno-25-1"></a><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/nfsroot/"</span>
</span><span id="__span-25-2"><a href="#__codelineno-25-2" id="__codelineno-25-2" name="__codelineno-25-2"></a><span class="gp">$ </span>less<span class="w"> </span>../busybox/examples/inittab
</span><span id="__span-25-3"><a href="#__codelineno-25-3" id="__codelineno-25-3" name="__codelineno-25-3"></a><span class="gp">$ </span>cp<span class="w"> </span>../busybox/examples/inittab<span class="w"> </span>etc/inittab
</span><span id="__span-25-4"><a href="#__codelineno-25-4" id="__codelineno-25-4" name="__codelineno-25-4"></a><span class="gp">$ </span>nano<span class="w"> </span>etc/inittab
</span></code></pre></div>
<p>Comment out any <em>getty respawn</em> from <code>etc/inittab</code>, otherwise those shells would keep respawning in our emulated board. Save (<span class="keys"><kbd class="key-control">Ctrl</kbd><span>+</span><kbd class="key-o">O</kbd></span>) and exit (<span class="keys"><kbd class="key-control">Ctrl</kbd><span>+</span><kbd class="key-x">X</kbd></span>).</p>
<div class="language-sh highlight"><span class="filename">File: $LAB_PATH/nfsroot/etc/inittab - respawning getty commented out</span><pre><span></span><code><span id="__span-26-1"><a href="#__codelineno-26-1" id="__codelineno-26-1" name="__codelineno-26-1"></a><span class="w">    </span>...
</span><span id="__span-26-2"><a href="#__codelineno-26-2" id="__codelineno-26-2" name="__codelineno-26-2"></a><span class="c1"># /sbin/getty invocations for selected ttys</span>
</span><span id="__span-26-3"><a href="#__codelineno-26-3" id="__codelineno-26-3" name="__codelineno-26-3"></a><span class="hll"><span class="c1">#tty4::respawn:/sbin/getty 38400 tty5</span>
</span></span><span id="__span-26-4"><a href="#__codelineno-26-4" id="__codelineno-26-4" name="__codelineno-26-4"></a><span class="hll"><span class="c1">#tty5::respawn:/sbin/getty 38400 tty6</span>
</span></span><span id="__span-26-5"><a href="#__codelineno-26-5" id="__codelineno-26-5" name="__codelineno-26-5"></a><span class="w">    </span>...
</span></code></pre></div>
<p>If you enter the login shell after startup, you should get an annoying message:</p>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-27-1"><a href="#__codelineno-27-1" id="__codelineno-27-1" name="__codelineno-27-1"></a><span class="go">Please press Enter to activate this console.</span>
</span><span id="__span-27-2"><a href="#__codelineno-27-2" id="__codelineno-27-2" name="__codelineno-27-2"></a><span class="go">starting pid 59, tty '': '-/bin/sh'</span>
</span><span id="__span-27-3"><a href="#__codelineno-27-3" id="__codelineno-27-3" name="__codelineno-27-3"></a>
</span><span id="__span-27-4"><a href="#__codelineno-27-4" id="__codelineno-27-4" name="__codelineno-27-4"></a>
</span><span id="__span-27-5"><a href="#__codelineno-27-5" id="__codelineno-27-5" name="__codelineno-27-5"></a><span class="go">BusyBox v1.35.0 (2023-05-02 22:18:33 CEST) built-in shell (ash)</span>
</span><span id="__span-27-6"><a href="#__codelineno-27-6" id="__codelineno-27-6" name="__codelineno-27-6"></a><span class="go">Enter 'help' for a list of built-in commands.</span>
</span><span id="__span-27-7"><a href="#__codelineno-27-7" id="__codelineno-27-7" name="__codelineno-27-7"></a>
</span><span id="__span-27-8"><a href="#__codelineno-27-8" id="__codelineno-27-8" name="__codelineno-27-8"></a><span class="hll"><span class="go">-/bin/sh: can't access tty; job control turned off</span>
</span></span><span id="__span-27-9"><a href="#__codelineno-27-9" id="__codelineno-27-9" name="__codelineno-27-9"></a><span class="gp">#</span>
</span></code></pre></div>
<p>Without <em>job control</em>, we cannot manage jobs, like termination via <span class="keys"><kbd class="key-control">Ctrl</kbd><span>+</span><kbd class="key-c">C</kbd></span>.<br/>
A quick way is to force <code>ttyS0</code> (the emulated board debug serial port) as the default login shell:</p>
<div class="language-sh highlight"><span class="filename">File: $LAB_PATH/nfsroot/etc/inittab - forced login shell device</span><pre><span></span><code><span id="__span-28-1"><a href="#__codelineno-28-1" id="__codelineno-28-1" name="__codelineno-28-1"></a><span class="w">    </span>...
</span><span id="__span-28-2"><a href="#__codelineno-28-2" id="__codelineno-28-2" name="__codelineno-28-2"></a><span class="c1"># Start an "askfirst" shell on the console (whatever that may be)</span>
</span><span id="__span-28-3"><a href="#__codelineno-28-3" id="__codelineno-28-3" name="__codelineno-28-3"></a><span class="hll">ttyS0::askfirst:-/bin/sh
</span></span><span id="__span-28-4"><a href="#__codelineno-28-4" id="__codelineno-28-4" name="__codelineno-28-4"></a><span class="w">    </span>...
</span></code></pre></div>
<blockquote>
<p><strong>TODO</strong>: Use some command line tools to comment out the above lines.</p>
</blockquote>
<p>Create the standard <code>/etc/init.d/rcS</code> startup script, to mount the <code>/proc</code> and <code>/sys</code> filesystems.</p>
<div class="language-sh highlight"><span class="filename">File: $LAB_PATH/nfsroot/etc/init.d/rcS</span><pre><span></span><code><span id="__span-29-1"><a href="#__codelineno-29-1" id="__codelineno-29-1" name="__codelineno-29-1"></a><span class="ch">#!/bin/sh</span>
</span><span id="__span-29-2"><a href="#__codelineno-29-2" id="__codelineno-29-2" name="__codelineno-29-2"></a>mount<span class="w"> </span>-t<span class="w"> </span>proc<span class="w"> </span>proc<span class="w"> </span>/proc
</span><span id="__span-29-3"><a href="#__codelineno-29-3" id="__codelineno-29-3" name="__codelineno-29-3"></a>mount<span class="w"> </span>-t<span class="w"> </span>sysfs<span class="w"> </span>sys<span class="w"> </span>/sys
</span></code></pre></div>
<p>Quick typing from the shell:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-30-1"><a href="#__codelineno-30-1" id="__codelineno-30-1" name="__codelineno-30-1"></a><span class="gp">$ </span>mkdir<span class="w"> </span>-p<span class="w"> </span>etc/init.d/
</span><span id="__span-30-2"><a href="#__codelineno-30-2" id="__codelineno-30-2" name="__codelineno-30-2"></a><span class="gp">$ </span>cat<span class="w"> </span>&gt;<span class="w"> </span>etc/init.d/rcS<span class="w"> </span>&lt;&lt;<span class="s1">'EOF'</span>
</span><span id="__span-30-3"><a href="#__codelineno-30-3" id="__codelineno-30-3" name="__codelineno-30-3"></a><span class="gp">#</span>!/bin/sh
</span><span id="__span-30-4"><a href="#__codelineno-30-4" id="__codelineno-30-4" name="__codelineno-30-4"></a><span class="go">mount -t proc proc /proc</span>
</span><span id="__span-30-5"><a href="#__codelineno-30-5" id="__codelineno-30-5" name="__codelineno-30-5"></a><span class="go">mount -t sysfs sys /sys</span>
</span><span id="__span-30-6"><a href="#__codelineno-30-6" id="__codelineno-30-6" name="__codelineno-30-6"></a><span class="go">EOF</span>
</span><span id="__span-30-7"><a href="#__codelineno-30-7" id="__codelineno-30-7" name="__codelineno-30-7"></a><span class="gp">$ </span>chmod<span class="w"> </span>+x<span class="w"> </span>etc/init.d/rcS
</span></code></pre></div>
<p>Try again by restarting the board, and you can notice that those warning messages are now gone.</p>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-31-1"><a href="#__codelineno-31-1" id="__codelineno-31-1" name="__codelineno-31-1"></a><span class="go">VFS: Mounted root (nfs filesystem) on device 0:16.</span>
</span><span id="__span-31-2"><a href="#__codelineno-31-2" id="__codelineno-31-2" name="__codelineno-31-2"></a><span class="go">devtmpfs: mounted</span>
</span><span id="__span-31-3"><a href="#__codelineno-31-3" id="__codelineno-31-3" name="__codelineno-31-3"></a><span class="go">Freeing unused kernel image (initmem) memory: 1024K</span>
</span><span id="__span-31-4"><a href="#__codelineno-31-4" id="__codelineno-31-4" name="__codelineno-31-4"></a><span class="go">Run /sbin/init as init process</span>
</span><span id="__span-31-5"><a href="#__codelineno-31-5" id="__codelineno-31-5" name="__codelineno-31-5"></a><span class="go">starting pid 77, tty '': '/etc/init.d/rcS'</span>
</span><span id="__span-31-6"><a href="#__codelineno-31-6" id="__codelineno-31-6" name="__codelineno-31-6"></a>
</span><span id="__span-31-7"><a href="#__codelineno-31-7" id="__codelineno-31-7" name="__codelineno-31-7"></a><span class="go">Please press Enter to activate this console.</span>
</span><span id="__span-31-8"><a href="#__codelineno-31-8" id="__codelineno-31-8" name="__codelineno-31-8"></a><span class="go">starting pid 80, tty '/dev/ttyS0': '-/bin/sh'</span>
</span><span id="__span-31-9"><a href="#__codelineno-31-9" id="__codelineno-31-9" name="__codelineno-31-9"></a>
</span><span id="__span-31-10"><a href="#__codelineno-31-10" id="__codelineno-31-10" name="__codelineno-31-10"></a>
</span><span id="__span-31-11"><a href="#__codelineno-31-11" id="__codelineno-31-11" name="__codelineno-31-11"></a><span class="go">BusyBox v1.35.0 (2023-05-02 22:25:02 CEST) built-in shell (ash)</span>
</span><span id="__span-31-12"><a href="#__codelineno-31-12" id="__codelineno-31-12" name="__codelineno-31-12"></a><span class="go">Enter 'help' for a list of built-in commands.</span>
</span><span id="__span-31-13"><a href="#__codelineno-31-13" id="__codelineno-31-13" name="__codelineno-31-13"></a>
</span><span id="__span-31-14"><a href="#__codelineno-31-14" id="__codelineno-31-14" name="__codelineno-31-14"></a><span class="gp">#</span>
</span></code></pre></div>
<p>You can keep the board running for the next paragraphs.
We're going to change files on-the-fly; those changes can be accessed directly from the board via NFS.</p>
<p>You might want to backup the current <code>nfsroot</code>. We're going to use <code>cpio</code> to preserve <em>symlinks</em>.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-32-1"><a href="#__codelineno-32-1" id="__codelineno-32-1" name="__codelineno-32-1"></a><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span><span class="nv">$LAB_PATH</span>/nfsroot/
</span><span id="__span-32-2"><a href="#__codelineno-32-2" id="__codelineno-32-2" name="__codelineno-32-2"></a><span class="gp">$ </span>find<span class="w"> </span>.<span class="w"> </span>-depth<span class="w"> </span>-print0<span class="w"> </span><span class="p">|</span><span class="w"> </span>cpio<span class="w"> </span>-ocv0<span class="w"> </span><span class="p">|</span><span class="w"> </span>xz<span class="w"> </span>&gt;<span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/nfsroot-static.cpio.xz"</span>
</span></code></pre></div>
<h2 id="switching-to-shared-libraries"><span class="enumerate-headings-plugin enumerate-heading-plugin">18.10</span> Switching to shared libraries</h2>
<p>Take the <code>hello.c</code> program supplied in the lab <code>data</code> directory. Cross-compile it for ARM, dynamically-linked with the libraries (just use our <code>arm-linux</code> toolchain), and run it on the target.<br/>
You should face a very misleading <code>not found</code> error, which is not because the <code>hello</code> executable is not found, but because something else was not found while trying to execute this executable.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-33-1"><a href="#__codelineno-33-1" id="__codelineno-33-1" name="__codelineno-33-1"></a><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span><span class="nv">$LAB_PATH</span>/data/
</span><span id="__span-33-2"><a href="#__codelineno-33-2" id="__codelineno-33-2" name="__codelineno-33-2"></a><span class="gp">$ </span>arm-linux-gcc<span class="w"> </span>-o<span class="w"> </span>hello<span class="w"> </span>hello.c
</span><span id="__span-33-3"><a href="#__codelineno-33-3" id="__codelineno-33-3" name="__codelineno-33-3"></a><span class="gp">$ </span>cp<span class="w"> </span>hello<span class="w"> </span>../nfsroot/bin/
</span></code></pre></div>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-34-1"><a href="#__codelineno-34-1" id="__codelineno-34-1" name="__codelineno-34-1"></a><span class="gp"># </span>hello
</span><span id="__span-34-2"><a href="#__codelineno-34-2" id="__codelineno-34-2" name="__codelineno-34-2"></a><span class="go">-/bin/sh: hello: not found</span>
</span></code></pre></div>
<p>It’s missing the <code>ld-uClibc.so.0</code> executable, which is the dynamic linker required to execute any program compiled with shared libraries.<br/>
Using the <code>find</code> command, look for any library files in the toolchain install directory, and copy them to the <code>lib/</code> directories on the target.
We're going to use a <em>regex</em> to find all the matches for possible <em>shared object</em> file name extensions.<br/>
Also copy any binary executables (like <code>ldd</code>) to their respective fodlers.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-35-1"><a href="#__codelineno-35-1" id="__codelineno-35-1" name="__codelineno-35-1"></a><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span><span class="s2">"</span><span class="nv">$TC_BASE</span><span class="s2">/</span><span class="nv">$TC_NAME</span><span class="s2">/sysroot/"</span>
</span><span id="__span-35-2"><a href="#__codelineno-35-2" id="__codelineno-35-2" name="__codelineno-35-2"></a><span class="gp">$ </span><span class="nv">so_regex</span><span class="o">=</span><span class="s2">".+\.so\(\.[0-9]+\)*"</span>
</span><span id="__span-35-3"><a href="#__codelineno-35-3" id="__codelineno-35-3" name="__codelineno-35-3"></a><span class="gp">$ </span>find<span class="w"> </span>.<span class="w"> </span>-regex<span class="w"> </span><span class="nv">$so_regex</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sort
</span><span id="__span-35-4"><a href="#__codelineno-35-4" id="__codelineno-35-4" name="__codelineno-35-4"></a><span class="go">./lib/ld-uClibc-1.0.39.so</span>
</span><span id="__span-35-5"><a href="#__codelineno-35-5" id="__codelineno-35-5" name="__codelineno-35-5"></a><span class="go">./lib/ld-uClibc.so.0</span>
</span><span id="__span-35-6"><a href="#__codelineno-35-6" id="__codelineno-35-6" name="__codelineno-35-6"></a><span class="go">./lib/ld-uClibc.so.1</span>
</span><span id="__span-35-7"><a href="#__codelineno-35-7" id="__codelineno-35-7" name="__codelineno-35-7"></a><span class="go">./lib/libatomic.so</span>
</span><span id="__span-35-8"><a href="#__codelineno-35-8" id="__codelineno-35-8" name="__codelineno-35-8"></a><span class="go">./lib/libatomic.so.1</span>
</span><span id="__span-35-9"><a href="#__codelineno-35-9" id="__codelineno-35-9" name="__codelineno-35-9"></a><span class="go">./lib/libatomic.so.1.2.0</span>
</span><span id="__span-35-10"><a href="#__codelineno-35-10" id="__codelineno-35-10" name="__codelineno-35-10"></a><span class="go">./lib/libc.so.0</span>
</span><span id="__span-35-11"><a href="#__codelineno-35-11" id="__codelineno-35-11" name="__codelineno-35-11"></a><span class="go">./lib/libc.so.1</span>
</span><span id="__span-35-12"><a href="#__codelineno-35-12" id="__codelineno-35-12" name="__codelineno-35-12"></a><span class="go">./lib/libgcc_s.so</span>
</span><span id="__span-35-13"><a href="#__codelineno-35-13" id="__codelineno-35-13" name="__codelineno-35-13"></a><span class="go">./lib/libgcc_s.so.1</span>
</span><span id="__span-35-14"><a href="#__codelineno-35-14" id="__codelineno-35-14" name="__codelineno-35-14"></a><span class="go">./lib/libitm.so</span>
</span><span id="__span-35-15"><a href="#__codelineno-35-15" id="__codelineno-35-15" name="__codelineno-35-15"></a><span class="go">./lib/libitm.so.1</span>
</span><span id="__span-35-16"><a href="#__codelineno-35-16" id="__codelineno-35-16" name="__codelineno-35-16"></a><span class="go">./lib/libitm.so.1.0.0</span>
</span><span id="__span-35-17"><a href="#__codelineno-35-17" id="__codelineno-35-17" name="__codelineno-35-17"></a><span class="go">./lib/libstdc++.so</span>
</span><span id="__span-35-18"><a href="#__codelineno-35-18" id="__codelineno-35-18" name="__codelineno-35-18"></a><span class="go">./lib/libstdc++.so.6</span>
</span><span id="__span-35-19"><a href="#__codelineno-35-19" id="__codelineno-35-19" name="__codelineno-35-19"></a><span class="go">./lib/libstdc++.so.6.0.29</span>
</span><span id="__span-35-20"><a href="#__codelineno-35-20" id="__codelineno-35-20" name="__codelineno-35-20"></a><span class="go">./lib/libthread_db-1.0.39.so</span>
</span><span id="__span-35-21"><a href="#__codelineno-35-21" id="__codelineno-35-21" name="__codelineno-35-21"></a><span class="go">./lib/libthread_db.so.1</span>
</span><span id="__span-35-22"><a href="#__codelineno-35-22" id="__codelineno-35-22" name="__codelineno-35-22"></a><span class="go">./lib/libuClibc-1.0.39.so</span>
</span><span id="__span-35-23"><a href="#__codelineno-35-23" id="__codelineno-35-23" name="__codelineno-35-23"></a><span class="go">./usr/lib/libc.so</span>
</span><span id="__span-35-24"><a href="#__codelineno-35-24" id="__codelineno-35-24" name="__codelineno-35-24"></a><span class="go">./usr/lib/libthread_db.so</span>
</span><span id="__span-35-25"><a href="#__codelineno-35-25" id="__codelineno-35-25" name="__codelineno-35-25"></a><span class="gp">$ </span>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/nfsroot/lib/"</span>
</span><span id="__span-35-26"><a href="#__codelineno-35-26" id="__codelineno-35-26" name="__codelineno-35-26"></a><span class="gp">$ </span>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/nfsroot/usr/lib/"</span>
</span><span id="__span-35-27"><a href="#__codelineno-35-27" id="__codelineno-35-27" name="__codelineno-35-27"></a><span class="gp">$ </span>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/nfsroot/sbin/"</span>
</span><span id="__span-35-28"><a href="#__codelineno-35-28" id="__codelineno-35-28" name="__codelineno-35-28"></a><span class="gp">$ </span>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/nfsroot/usr/sbin/"</span>
</span><span id="__span-35-29"><a href="#__codelineno-35-29" id="__codelineno-35-29" name="__codelineno-35-29"></a><span class="gp">$ </span>cp<span class="w"> </span>lib/libc.so*<span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/nfsroot/lib/"</span>
</span><span id="__span-35-30"><a href="#__codelineno-35-30" id="__codelineno-35-30" name="__codelineno-35-30"></a><span class="gp">$ </span>cp<span class="w"> </span>lib/ld-uClibc.so*<span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/nfsroot/lib/"</span>
</span><span id="__span-35-31"><a href="#__codelineno-35-31" id="__codelineno-35-31" name="__codelineno-35-31"></a><span class="gp">$ </span>cp<span class="w"> </span>usr/bin/ldd<span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/nfsroot/usr/bin/"</span>
</span></code></pre></div>
<p>Now <code>hello</code> works as expected, and you can also execute <code>ldd</code> against it to see the library dependencies:</p>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-36-1"><a href="#__codelineno-36-1" id="__codelineno-36-1" name="__codelineno-36-1"></a><span class="gp"># </span>hello
</span><span id="__span-36-2"><a href="#__codelineno-36-2" id="__codelineno-36-2" name="__codelineno-36-2"></a><span class="go">Hello world!</span>
</span><span id="__span-36-3"><a href="#__codelineno-36-3" id="__codelineno-36-3" name="__codelineno-36-3"></a><span class="gp"># </span>ldd<span class="w"> </span>bin/hello
</span><span id="__span-36-4"><a href="#__codelineno-36-4" id="__codelineno-36-4" name="__codelineno-36-4"></a><span class="go">        libc.so.0 =&gt; /lib/libc.so.0 (0xb6f04000)</span>
</span><span id="__span-36-5"><a href="#__codelineno-36-5" id="__codelineno-36-5" name="__codelineno-36-5"></a><span class="go">        ld-uClibc.so.1 =&gt; /lib/ld-uClibc.so.0 (0xb6f8b000)</span>
</span><span id="__span-36-6"><a href="#__codelineno-36-6" id="__codelineno-36-6" name="__codelineno-36-6"></a><span class="gp"># </span>ldd<span class="w"> </span>bin/busybox
</span><span id="__span-36-7"><a href="#__codelineno-36-7" id="__codelineno-36-7" name="__codelineno-36-7"></a><span class="go">        not a dynamic executable</span>
</span></code></pre></div>
<blockquote>
<p>If you still get the same error message, work, just try again a few seconds later.
Such a delay can be needed because the NFS client can take a little time (at most 30-60 seconds) before seeing the changes made on the NFS server.</p>
</blockquote>
<p>Once the small test program works, we're going to recompile <em>BusyBox</em> without the <em>static</em> compilation option, so that <em>BusyBox</em> takes advantages of the shared libraries that are now present on the target.<br/>
Before doing that, measure the size of the busybox executable.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-37-1"><a href="#__codelineno-37-1" id="__codelineno-37-1" name="__codelineno-37-1"></a><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span><span class="nv">$LAB_PATH</span>
</span><span id="__span-37-2"><a href="#__codelineno-37-2" id="__codelineno-37-2" name="__codelineno-37-2"></a><span class="gp">$ </span>du<span class="w"> </span>-h<span class="w"> </span>nfsroot/bin/busybox
</span><span id="__span-37-3"><a href="#__codelineno-37-3" id="__codelineno-37-3" name="__codelineno-37-3"></a><span class="go">356K    nfsroot/bin/busybox</span>
</span><span id="__span-37-4"><a href="#__codelineno-37-4" id="__codelineno-37-4" name="__codelineno-37-4"></a><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span>busybox/
</span><span id="__span-37-5"><a href="#__codelineno-37-5" id="__codelineno-37-5" name="__codelineno-37-5"></a><span class="gp">$ </span>make<span class="w"> </span>menuconfig
</span></code></pre></div>
<p>In <code>Settings</code>:</p>
<ul>
<li>Disable <code>Build static binary (no shared libs)</code> (<code>STATIC</code>)</li>
</ul>
<p>Now <code>halt</code> and quit <em>QEMU</em>, backup the new configuration, and build <em>BusyBox</em> again.<br>
As you will see, the executable is now smaller, because it's using shared libraries.</br></p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-38-1"><a href="#__codelineno-38-1" id="__codelineno-38-1" name="__codelineno-38-1"></a><span class="gp">$ </span>cp<span class="w"> </span>.config<span class="w"> </span>../busybox-dynamic.config
</span><span id="__span-38-2"><a href="#__codelineno-38-2" id="__codelineno-38-2" name="__codelineno-38-2"></a><span class="gp">$ </span>make<span class="w"> </span>clean
</span><span id="__span-38-3"><a href="#__codelineno-38-3" id="__codelineno-38-3" name="__codelineno-38-3"></a><span class="gp">$ </span>make<span class="w"> </span>install
</span><span id="__span-38-4"><a href="#__codelineno-38-4" id="__codelineno-38-4" name="__codelineno-38-4"></a><span class="gp">$ </span>du<span class="w"> </span>-h<span class="w"> </span>../nfsroot/bin/busybox
</span><span id="__span-38-5"><a href="#__codelineno-38-5" id="__codelineno-38-5" name="__codelineno-38-5"></a><span class="go">212K    ../nfsroot/bin/busybox</span>
</span></code></pre></div>
<p>Restart the board, reaching the <em>BusyBox</em> shell successfully.<br/>
You can confirm that the current <code>busybox</code> executable depends on shared libraries:</p>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-39-1"><a href="#__codelineno-39-1" id="__codelineno-39-1" name="__codelineno-39-1"></a><span class="gp"># </span>ldd<span class="w"> </span>bin/busybox
</span><span id="__span-39-2"><a href="#__codelineno-39-2" id="__codelineno-39-2" name="__codelineno-39-2"></a><span class="go">        libc.so.0 =&gt; /lib/libc.so.0 (0xb6eb0000)</span>
</span><span id="__span-39-3"><a href="#__codelineno-39-3" id="__codelineno-39-3" name="__codelineno-39-3"></a><span class="go">        ld-uClibc.so.1 =&gt; /lib/ld-uClibc.so.0 (0xb6f37000)</span>
</span></code></pre></div>
<h2 id="implement-a-web-interface-for-your-device"><span class="enumerate-headings-plugin enumerate-heading-plugin">18.11</span> Implement a web interface for your device</h2>
<p>Replicate <code>$LAB_PATH/data/www/</code> to the <code>/www</code> directory in your target <em>root</em> filesystem.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-40-1"><a href="#__codelineno-40-1" id="__codelineno-40-1" name="__codelineno-40-1"></a><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span><span class="nv">$LAB_PATH</span>
</span><span id="__span-40-2"><a href="#__codelineno-40-2" id="__codelineno-40-2" name="__codelineno-40-2"></a><span class="gp">$ </span>cp<span class="w"> </span>-r<span class="w"> </span>data/www/<span class="w"> </span>nfsroot/
</span></code></pre></div>
<p>Then, run the <em>BusyBox</em> <em>http server</em> from the <em>BusyBox</em> shell; it will automatically background itself.</p>
<div class="language-text highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-41-1"><a href="#__codelineno-41-1" id="__codelineno-41-1" name="__codelineno-41-1"></a># /usr/sbin/httpd -h /www/
</span></code></pre></div>
<p>Now, test that your web interface works well by opening
<a href="http://192.168.0.69/index.html">http://192.168.0.69/index.html</a>
within the host machine (<em>Lubuntu</em> VM).</p>
<p>See how the dynamic pages are implemented. Very simple, isn’t it?</p>
<blockquote>
<p>If you use a proxy, configure your host browser so that it doesn’t go through the proxy to connect to the target IP address, or simply disable proxy usage.</p>
</blockquote>
<p>Finish by adding the command that starts the web server to your startup script, so that it is always started on your target.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-42-1"><a href="#__codelineno-42-1" id="__codelineno-42-1" name="__codelineno-42-1"></a><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/nfsroot/"</span>
</span><span id="__span-42-2"><a href="#__codelineno-42-2" id="__codelineno-42-2" name="__codelineno-42-2"></a><span class="gp">$ </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"/usr/sbin/httpd -h /www/"</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>etc/init.d/rcS
</span></code></pre></div>
<p>You can <code>reboot</code> <em>BusyBox</em> and see that the web server was started automatically (press <span class="keys"><kbd class="key-control">Ctrl</kbd><span>+</span><kbd class="key-c">C</kbd></span> to quit <code>top</code>). You can then <code>halt</code> the board.</p>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-43-1"><a href="#__codelineno-43-1" id="__codelineno-43-1" name="__codelineno-43-1"></a><span class="gp"># </span>top
</span><span id="__span-43-2"><a href="#__codelineno-43-2" id="__codelineno-43-2" name="__codelineno-43-2"></a><span class="go">Mem: 14136K used, 104336K free, 0K shrd, 0K buff, 868K cached</span>
</span><span id="__span-43-3"><a href="#__codelineno-43-3" id="__codelineno-43-3" name="__codelineno-43-3"></a><span class="go">CPU:  0.5% usr  1.5% sys  0.0% nic 97.9% idle  0.0% io  0.0% irq  0.0% sirq</span>
</span><span id="__span-43-4"><a href="#__codelineno-43-4" id="__codelineno-43-4" name="__codelineno-43-4"></a><span class="go">Load average: 0.00 0.00 0.00 1/59 66</span>
</span><span id="__span-43-5"><a href="#__codelineno-43-5" id="__codelineno-43-5" name="__codelineno-43-5"></a><span class="go">  PID  PPID USER     STAT   VSZ %VSZ CPU %CPU COMMAND</span>
</span><span id="__span-43-6"><a href="#__codelineno-43-6" id="__codelineno-43-6" name="__codelineno-43-6"></a><span class="go">   66    62 0        R     1016  0.8   0  1.7 top</span>
</span><span id="__span-43-7"><a href="#__codelineno-43-7" id="__codelineno-43-7" name="__codelineno-43-7"></a><span class="go">   31     2 0        IW       0  0.0   0  0.3 [kworker/0:1-eve]</span>
</span><span id="__span-43-8"><a href="#__codelineno-43-8" id="__codelineno-43-8" name="__codelineno-43-8"></a><span class="go">    1     0 0        S     1016  0.8   0  0.0 /sbin/init</span>
</span><span id="__span-43-9"><a href="#__codelineno-43-9" id="__codelineno-43-9" name="__codelineno-43-9"></a><span class="go">   63     1 0        S     1016  0.8   0  0.0 /sbin/init</span>
</span><span id="__span-43-10"><a href="#__codelineno-43-10" id="__codelineno-43-10" name="__codelineno-43-10"></a><span class="go">   64     1 0        S     1016  0.8   0  0.0 /sbin/init</span>
</span><span id="__span-43-11"><a href="#__codelineno-43-11" id="__codelineno-43-11" name="__codelineno-43-11"></a><span class="go">   65     1 0        S     1016  0.8   0  0.0 /sbin/init</span>
</span><span id="__span-43-12"><a href="#__codelineno-43-12" id="__codelineno-43-12" name="__codelineno-43-12"></a><span class="go">   62     1 0        S     1012  0.8   0  0.0 -/bin/sh</span>
</span><span id="__span-43-13"><a href="#__codelineno-43-13" id="__codelineno-43-13" name="__codelineno-43-13"></a><span class="hll"><span class="go">   61     1 0        S     1008  0.8   0  0.0 /usr/sbin/httpd -h /www/</span>
</span></span><span id="__span-43-14"><a href="#__codelineno-43-14" id="__codelineno-43-14" name="__codelineno-43-14"></a><span class="go">    8     2 0        IW       0  0.0   0  0.0 [kworker/u8:0-nf]</span>
</span><span id="__span-43-15"><a href="#__codelineno-43-15" id="__codelineno-43-15" name="__codelineno-43-15"></a><span class="go">   10     2 0        SW       0  0.0   0  0.0 [ksoftirqd/0]</span>
</span><span id="__span-43-16"><a href="#__codelineno-43-16" id="__codelineno-43-16" name="__codelineno-43-16"></a><span class="go">   11     2 0        IW       0  0.0   0  0.0 [rcu_sched]</span>
</span><span id="__span-43-17"><a href="#__codelineno-43-17" id="__codelineno-43-17" name="__codelineno-43-17"></a><span class="go">   55     2 0        IW&lt;      0  0.0   0  0.0 [kworker/u9:2-xp]</span>
</span><span id="__span-43-18"><a href="#__codelineno-43-18" id="__codelineno-43-18" name="__codelineno-43-18"></a><span class="go">   41     2 0        IW&lt;      0  0.0   0  0.0 [kworker/u9:0-xp]</span>
</span><span id="__span-43-19"><a href="#__codelineno-43-19" id="__codelineno-43-19" name="__codelineno-43-19"></a><span class="go">   46     2 0        IW       0  0.0   0  0.0 [kworker/0:2-eve]</span>
</span><span id="__span-43-20"><a href="#__codelineno-43-20" id="__codelineno-43-20" name="__codelineno-43-20"></a><span class="go">   29     2 0        SW       0  0.0   0  0.0 [kdevtmpfs]</span>
</span><span id="__span-43-21"><a href="#__codelineno-43-21" id="__codelineno-43-21" name="__codelineno-43-21"></a><span class="go">   35     2 0        SW       0  0.0   0  0.0 [kcompactd0]</span>
</span><span id="__span-43-22"><a href="#__codelineno-43-22" id="__codelineno-43-22" name="__codelineno-43-22"></a><span class="go">   43     2 0        IW       0  0.0   0  0.0 [kworker/u8:2-ev]</span>
</span><span id="__span-43-23"><a href="#__codelineno-43-23" id="__codelineno-43-23" name="__codelineno-43-23"></a><span class="go">    2     0 0        SW       0  0.0   0  0.0 [kthreadd]</span>
</span><span id="__span-43-24"><a href="#__codelineno-43-24" id="__codelineno-43-24" name="__codelineno-43-24"></a><span class="go">   38     2 0        IW       0  0.0   0  0.0 [kworker/u8:1-nf]</span>
</span><span id="__span-43-25"><a href="#__codelineno-43-25" id="__codelineno-43-25" name="__codelineno-43-25"></a><span class="go">    6     2 0        IW       0  0.0   0  0.0 [kworker/0:0-eve]</span>
</span></code></pre></div>
<h2 id="backup-and-restore"><span class="enumerate-headings-plugin enumerate-heading-plugin">18.12</span> Backup and restore</h2>
<p>Everything looks fine now, so you're free to make a backup archive of the dynamic <code>nfsroot</code>:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-44-1"><a href="#__codelineno-44-1" id="__codelineno-44-1" name="__codelineno-44-1"></a><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/nfsroot/"</span>
</span><span id="__span-44-2"><a href="#__codelineno-44-2" id="__codelineno-44-2" name="__codelineno-44-2"></a><span class="gp">$ </span>find<span class="w"> </span>.<span class="w"> </span>-depth<span class="w"> </span>-print0<span class="w"> </span><span class="p">|</span><span class="w"> </span>cpio<span class="w"> </span>-ocv0<span class="w"> </span><span class="p">|</span><span class="w"> </span>xz<span class="w"> </span>&gt;<span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/nfsroot-dynamic.cpio.xz"</span>
</span></code></pre></div>
<p>In case you wish to restore the snapshot:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-45-1"><a href="#__codelineno-45-1" id="__codelineno-45-1" name="__codelineno-45-1"></a><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span><span class="nv">$LAB_PATH</span>
</span><span id="__span-45-2"><a href="#__codelineno-45-2" id="__codelineno-45-2" name="__codelineno-45-2"></a><span class="gp">$ </span>rm<span class="w"> </span>-rf<span class="w"> </span>nfsroot/
</span><span id="__span-45-3"><a href="#__codelineno-45-3" id="__codelineno-45-3" name="__codelineno-45-3"></a><span class="gp">$ </span>mkdir<span class="w"> </span>-p<span class="w"> </span>nfsroot/
</span><span id="__span-45-4"><a href="#__codelineno-45-4" id="__codelineno-45-4" name="__codelineno-45-4"></a><span class="gp">$ </span>xzcat<span class="w"> </span>nfsroot-dynamic.cpio.xz<span class="w"> </span><span class="p">|</span><span class="w"> </span>cpio<span class="w"> </span>-iduv<span class="w"> </span>-D<span class="w"> </span>nfsroot/
</span></code></pre></div>
<h2 id="boot-with-initramfs"><span class="enumerate-headings-plugin enumerate-heading-plugin">18.13</span> Boot with <em>initramfs</em></h2>
<p>It's usual to run an <em>initramfs</em> instead of a boot from NFS: the <em>initramfs</em> copies data from the SD card into RAM, and executes a preliminary boot from there.</p>
<blockquote>
<p>FYI: <a href="https://landley.net/writing/rootfs-howto.html">https://landley.net/writing/rootfs-howto.html</a></p>
</blockquote>
<p>Configure your kernel to include the contents of the <code>nfsroot</code> directory as an <em>initramfs</em> image archive file <code>/initrd.cpio.gz</code>.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-46-1"><a href="#__codelineno-46-1" id="__codelineno-46-1" name="__codelineno-46-1"></a><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/../kernel/linux/"</span>
</span><span id="__span-46-2"><a href="#__codelineno-46-2" id="__codelineno-46-2" name="__codelineno-46-2"></a><span class="gp">$ </span><span class="nb">export</span><span class="w"> </span><span class="nv">ARCH</span><span class="o">=</span>arm
</span><span id="__span-46-3"><a href="#__codelineno-46-3" id="__codelineno-46-3" name="__codelineno-46-3"></a><span class="gp">$ </span>make<span class="w"> </span>menuconfig
</span><span id="__span-46-4"><a href="#__codelineno-46-4" id="__codelineno-46-4" name="__codelineno-46-4"></a><span class="gp">$ </span>cp<span class="w"> </span>.config<span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/kernel-initramfs.config"</span>
</span></code></pre></div>
<p>In <code>General setup</code>:</p>
<ul>
<li>
<p>Enable <code>Initial RAM filesystem and RAM disk (initramfs/initrd) support</code> (<code>BLK_DEV_INITRD</code>)</p>
</li>
<li>
<p>Set <code>Initramfs source file(s)</code> (<code>INITRAMFS_SOURCE</code>) = <code>../../tinysystem/nfsroot</code>.</p>
</li>
<li>
<p>Enable <code>Support initial ramdisk/ramfs compressed using gzip</code> (<code>RD_GZIP</code>).</p>
</li>
</ul>
<p>Now <code>&lt;Save&gt;</code> the <code>.config</code> and save a backup copy.</p>
<p>Before building and running the updated kernel, in the toplevel directory you have to create an <code>/init</code> link pointing to <code>/sbin/init</code>.
This is required because the kernel will try to execute the <code>/init</code> executable — we simply redirect it to the standard one.<br/>
You can then archive your <em>initrams</em> image archive.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-47-1"><a href="#__codelineno-47-1" id="__codelineno-47-1" name="__codelineno-47-1"></a><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/nfsroot/"</span>
</span><span id="__span-47-2"><a href="#__codelineno-47-2" id="__codelineno-47-2" name="__codelineno-47-2"></a><span class="gp">$ </span>ln<span class="w"> </span>-s<span class="w"> </span>sbin/init<span class="w"> </span>init
</span></code></pre></div>
<p>You should also mount <code>devtmpfs</code> from the <code>/etc/init.d/rcS</code> script, because it cannot be mounted automatically by the kernel when booting from an <em>initramfs</em>.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-48-1"><a href="#__codelineno-48-1" id="__codelineno-48-1" name="__codelineno-48-1"></a><span class="gp">$ </span>cat<span class="w"> </span>&gt;<span class="w"> </span>etc/init.d/rcS<span class="w"> </span>&lt;&lt;<span class="s1">'EOF'</span>
</span><span id="__span-48-2"><a href="#__codelineno-48-2" id="__codelineno-48-2" name="__codelineno-48-2"></a><span class="gp">#</span>!/bin/sh
</span><span id="__span-48-3"><a href="#__codelineno-48-3" id="__codelineno-48-3" name="__codelineno-48-3"></a><span class="go">mount -t proc proc /proc</span>
</span><span id="__span-48-4"><a href="#__codelineno-48-4" id="__codelineno-48-4" name="__codelineno-48-4"></a><span class="go">mount -t sysfs sys /sys</span>
</span><span id="__span-48-5"><a href="#__codelineno-48-5" id="__codelineno-48-5" name="__codelineno-48-5"></a><span class="go">mount -t devtmpfs dev /dev</span>
</span><span id="__span-48-6"><a href="#__codelineno-48-6" id="__codelineno-48-6" name="__codelineno-48-6"></a><span class="go">/usr/sbin/httpd -h /www/</span>
</span><span id="__span-48-7"><a href="#__codelineno-48-7" id="__codelineno-48-7" name="__codelineno-48-7"></a><span class="go">EOF</span>
</span></code></pre></div>
<p>You can now rebuild the kernel, <code>make</code> will take care of the changes to rebuild.<br/>
Copy the newly generated kernel image to the TFTP server. You can see the difference in size between the two <code>zImage</code> versions, since <em>initramfs</em> includes our <code>nfsroot</code>.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-49-1"><a href="#__codelineno-49-1" id="__codelineno-49-1" name="__codelineno-49-1"></a><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/../kernel/linux/"</span>
</span><span id="__span-49-2"><a href="#__codelineno-49-2" id="__codelineno-49-2" name="__codelineno-49-2"></a><span class="gp">$ </span>make
</span><span id="__span-49-3"><a href="#__codelineno-49-3" id="__codelineno-49-3" name="__codelineno-49-3"></a><span class="go">    ...</span>
</span><span id="__span-49-4"><a href="#__codelineno-49-4" id="__codelineno-49-4" name="__codelineno-49-4"></a><span class="go">  Kernel: arch/arm/boot/zImage is ready</span>
</span><span id="__span-49-5"><a href="#__codelineno-49-5" id="__codelineno-49-5" name="__codelineno-49-5"></a><span class="gp">$ </span>mv<span class="w"> </span>/srv/tftp/zImage<span class="w"> </span>/srv/tftp/zImage-without-initramfs
</span><span id="__span-49-6"><a href="#__codelineno-49-6" id="__codelineno-49-6" name="__codelineno-49-6"></a><span class="gp">$ </span>cp<span class="w"> </span>arch/arm/boot/zImage<span class="w"> </span>/srv/tftp/zImage-with-initramfs
</span><span id="__span-49-7"><a href="#__codelineno-49-7" id="__codelineno-49-7" name="__codelineno-49-7"></a><span class="gp">$ </span>cp<span class="w"> </span>arch/arm/boot/zImage<span class="w"> </span>/srv/tftp/zImage
</span><span id="__span-49-8"><a href="#__codelineno-49-8" id="__codelineno-49-8" name="__codelineno-49-8"></a><span class="gp">$ </span>du<span class="w"> </span>-h<span class="w"> </span>/srv/tftp/zImage*
</span><span id="__span-49-9"><a href="#__codelineno-49-9" id="__codelineno-49-9" name="__codelineno-49-9"></a><span class="go">5.4M    /srv/tftp/zImage</span>
</span><span id="__span-49-10"><a href="#__codelineno-49-10" id="__codelineno-49-10" name="__codelineno-49-10"></a><span class="go">5.4M    /srv/tftp/zImage-with-initramfs</span>
</span><span id="__span-49-11"><a href="#__codelineno-49-11" id="__codelineno-49-11" name="__codelineno-49-11"></a><span class="go">4.7M    /srv/tftp/zImage-without-initramfs</span>
</span></code></pre></div>
<p>You can now reboot your board, which this time is booting the kernel from <em>initramfs</em> instead of NFS.<br/>
You won’t need to modify your <code>root=/srv/nfs</code> setting in the kernel command line (<code>bootargs</code>), because it will just be ignored for an <em>initramfs</em>.</p>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-50-1"><a href="#__codelineno-50-1" id="__codelineno-50-1" name="__codelineno-50-1"></a><span class="go">    ...</span>
</span><span id="__span-50-2"><a href="#__codelineno-50-2" id="__codelineno-50-2" name="__codelineno-50-2"></a><span class="hll"><span class="go">Freeing unused kernel image (initmem) memory: 2048K</span>
</span></span><span id="__span-50-3"><a href="#__codelineno-50-3" id="__codelineno-50-3" name="__codelineno-50-3"></a><span class="hll"><span class="go">Run /init as init process</span>
</span></span><span id="__span-50-4"><a href="#__codelineno-50-4" id="__codelineno-50-4" name="__codelineno-50-4"></a>
</span><span id="__span-50-5"><a href="#__codelineno-50-5" id="__codelineno-50-5" name="__codelineno-50-5"></a><span class="go">Please press Enter to activate this console.</span>
</span></code></pre></div>
<p>Let's archive the current state for the future.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-51-1"><a href="#__codelineno-51-1" id="__codelineno-51-1" name="__codelineno-51-1"></a><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/nfsroot/"</span>
</span><span id="__span-51-2"><a href="#__codelineno-51-2" id="__codelineno-51-2" name="__codelineno-51-2"></a><span class="gp">$ </span>find<span class="w"> </span>.<span class="w"> </span>-depth<span class="w"> </span>-print0<span class="w"> </span><span class="p">|</span><span class="w"> </span>cpio<span class="w"> </span>-ocv0<span class="w"> </span><span class="p">|</span><span class="w"> </span>xz<span class="w"> </span>&gt;<span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/nfsroot-initramfs.cpio.xz"</span>
</span><span id="__span-51-3"><a href="#__codelineno-51-3" id="__codelineno-51-3" name="__codelineno-51-3"></a><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span>/srv/tftp
</span><span id="__span-51-4"><a href="#__codelineno-51-4" id="__codelineno-51-4" name="__codelineno-51-4"></a><span class="gp">$ </span>tar<span class="w"> </span>cfJv<span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/zImage-initramfs.tar.xz"</span><span class="w"> </span>zImage
</span></code></pre></div>
<p>In case you wish to restore the snapshot:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-52-1"><a href="#__codelineno-52-1" id="__codelineno-52-1" name="__codelineno-52-1"></a><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span><span class="nv">$LAB_PATH</span>
</span><span id="__span-52-2"><a href="#__codelineno-52-2" id="__codelineno-52-2" name="__codelineno-52-2"></a><span class="gp">$ </span>rm<span class="w"> </span>-rf<span class="w"> </span>nfsroot/
</span><span id="__span-52-3"><a href="#__codelineno-52-3" id="__codelineno-52-3" name="__codelineno-52-3"></a><span class="gp">$ </span>mkdir<span class="w"> </span>-p<span class="w"> </span>nfsroot/
</span><span id="__span-52-4"><a href="#__codelineno-52-4" id="__codelineno-52-4" name="__codelineno-52-4"></a><span class="gp">$ </span>xzcat<span class="w"> </span>nfsroot-initramfs.cpio.xz<span class="w"> </span><span class="p">|</span><span class="w"> </span>cpio<span class="w"> </span>-iduv<span class="w"> </span>-D<span class="w"> </span>nfsroot/
</span><span id="__span-52-5"><a href="#__codelineno-52-5" id="__codelineno-52-5" name="__codelineno-52-5"></a><span class="gp">$ </span>tar<span class="w"> </span>xfv<span class="w"> </span>zImage-initramfs.tar.xz
</span><span id="__span-52-6"><a href="#__codelineno-52-6" id="__codelineno-52-6" name="__codelineno-52-6"></a><span class="gp">$ </span>mv<span class="w"> </span>zImage<span class="w"> </span>/srv/tftp
</span></code></pre></div>
<p>Now go back to booting the system through NFS, which is more convenient for these labs: an <em>initiramfs</em> requires to be rebuilt for each change in your <em>root</em> filesystem, while NFS does it automatically.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-53-1"><a href="#__codelineno-53-1" id="__codelineno-53-1" name="__codelineno-53-1"></a><span class="gp">$ </span>cp<span class="w"> </span>/srv/tftp/zImage-without-initramfs<span class="w"> </span>/srv/tftp/zImage
</span></code></pre></div>
<p>At reboot it should complain about <code>/dev</code> being busy, as we're trying to mount it twice with the updated <code>rcS</code> script; just ignore this message.</p>
<h2 id="licensing"><span class="enumerate-headings-plugin enumerate-heading-plugin">18.14</span> Licensing</h2>
<p>This document is an extension to: <a href="https://bootlin.com/doc/training/embedded-linux-bbb/"><em>Embedded Linux System Development - Practical Labs - BeagleBone Black Variant</em></a>
 — © 2004-2023, <em>Bootlin</em> <a href="https://bootlin.com">https://bootlin.com/</a>, <a href="(https://creativecommons.org/licenses/by-sa/3.0/)"><code>CC-BY-SA-3.0</code></a> license.</p>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
<script src="../../assets/javascripts/bundle.fac441b0.min.js"></script>
</body>
</html>