
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="../tinysystem/" rel="prev"/>
<link href="../blockfs/" rel="next"/>
<link href="../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.4.3, mkdocs-material-9.1.11" name="generator"/>
<title>Accessing Hardware Devices - Embedded Systems Linux Development Notes</title>
<link href="../../assets/stylesheets/main.85bb2934.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body dir="ltr">
<script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#accessing-hardware-devices">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="Embedded Systems Linux Development Notes" class="md-header__button md-logo" data-md-component="logo" href="../.." title="Embedded Systems Linux Development Notes">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            Embedded Systems Linux Development Notes
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Accessing Hardware Devices
            
          </span>
</div>
</div>
</div>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="Embedded Systems Linux Development Notes" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="Embedded Systems Linux Development Notes">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
    Embedded Systems Linux Development Notes
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../..">
        Overview
      </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          QEMU variant
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
          QEMU variant
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../qemu/virtualbox/">
        Host VM
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../qemu/toolchain/">
        Building a cross-compile toolchain
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../qemu/bootloader/">
        Bootloader - U-Boot
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../qemu/kernel/">
        Linux Kernel
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../qemu/tinysystem/">
        Tiny embedded system with BusyBox
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../qemu/hardware/">
        Accessing Hardware Devices
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../qemu/blockfs/">
        Block Filesystems
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../qemu/thirdparty/">
        Third-party libraries and apps
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../qemu/buildroot/">
        Buildroot
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../qemu/appdev/">
        App - Development
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../qemu/debugging/">
        App - Remote debug
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../qemu/debootstrap/">
        debootstrap
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          BeagleBone Black variant
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
          BeagleBone Black variant
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../virtualbox/">
        Host VM
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../toolchain/">
        Building a cross-compile toolchain
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../bootloader/">
        Bootloader - U-Boot
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../kernel/">
        Linux Kernel
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../tinysystem/">
        Tiny embedded system with BusyBox
      </a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
          Accessing Hardware Devices
          <span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
        Accessing Hardware Devices
      </a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#objectives">
    Objectives
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#setup">
    Setup
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#exploring-dev">
    Exploring /dev
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#exploring-sys">
    Exploring /sys
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#driving-gpios">
    Driving GPIOs
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#driving-leds">
    Driving LEDs
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#managing-i2c-bus-and-devices">
    Managing I2C bus and devices
  </a>
<nav aria-label="Managing I2C bus and devices" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#enabling-i2c-bus">
    Enabling I2C bus
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#customizing-device-tree">
    Customizing Device Tree
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#adding-i2c-device">
    Adding I2C device
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#plugging-an-audio-usb-headset">
    Plugging an audio USB headset
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#in-tree-kernel-modules">
    In-tree kernel modules
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#out-of-tree-kernel-modules">
    Out-of-tree kernel modules
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#declaring-i2c-device">
    Declaring I2C device
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#setting-board-model-name">
    Setting board model name
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#committing-kernel-tree-changes">
    Committing kernel tree changes
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#backup-and-restore">
    Backup and restore
  </a>
<nav aria-label="Backup and restore" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#git-bundle">
    git bundle
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#licensing">
    Licensing
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../blockfs/">
        Block Filesystems
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../thirdparty/">
        Third-party libraries and apps
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../buildroot/">
        Buildroot
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../integration/">
        System integration
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../appdev/">
        App - Development
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          Knowledge Base
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
          Knowledge Base
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../kb/git-hash/">
        git commit hash expansion
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kb/menuconfig/">
        menuconfig
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../kb/processors/">
        Processors
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../copying/">
        Copying this document
      </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#objectives">
    Objectives
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#setup">
    Setup
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#exploring-dev">
    Exploring /dev
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#exploring-sys">
    Exploring /sys
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#driving-gpios">
    Driving GPIOs
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#driving-leds">
    Driving LEDs
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#managing-i2c-bus-and-devices">
    Managing I2C bus and devices
  </a>
<nav aria-label="Managing I2C bus and devices" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#enabling-i2c-bus">
    Enabling I2C bus
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#customizing-device-tree">
    Customizing Device Tree
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#adding-i2c-device">
    Adding I2C device
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#plugging-an-audio-usb-headset">
    Plugging an audio USB headset
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#in-tree-kernel-modules">
    In-tree kernel modules
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#out-of-tree-kernel-modules">
    Out-of-tree kernel modules
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#declaring-i2c-device">
    Declaring I2C device
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#setting-board-model-name">
    Setting board model name
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#committing-kernel-tree-changes">
    Committing kernel tree changes
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#backup-and-restore">
    Backup and restore
  </a>
<nav aria-label="Backup and restore" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#git-bundle">
    git bundle
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#licensing">
    Licensing
  </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="accessing-hardware-devices"><span class="enumerate-headings-plugin enumerate-heading-plugin">19.</span> Accessing Hardware Devices</h1>
<h2 id="objectives"><span class="enumerate-headings-plugin enumerate-heading-plugin">19.1</span> Objectives</h2>
<ul>
<li>Learn how to access hardware devices.</li>
</ul>
<h2 id="setup"><span class="enumerate-headings-plugin enumerate-heading-plugin">19.2</span> Setup</h2>
<p>Go to the <code>$HOME/embedded-linux-bbb-labs/hardware/</code> directory, which provides useful files for
this lab.<br/>
However, we will go on booting the system through NFS, using the root filesystem built by the
previous lab.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-0-1"><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="gp">$ </span><span class="nv">LAB_PATH</span><span class="o">=</span><span class="s2">"</span><span class="nv">$HOME</span><span class="s2">/embedded-linux-bbb-labs/hardware"</span>
</span><span id="__span-0-2"><a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span><span class="nv">$LAB_PATH</span>
</span></code></pre></div>
<h2 id="exploring-dev"><span class="enumerate-headings-plugin enumerate-heading-plugin">19.3</span> Exploring <code>/dev</code></h2>
<p>Start by exploring <code>/dev/</code> on your target system.</p>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-1-1"><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="gp"># </span>ls<span class="w"> </span>/dev/
</span><span id="__span-1-2"><a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="go">bus              ram1             tty26            tty59</span>
</span><span id="__span-1-3"><a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="go">console          ram10            tty27            tty6</span>
</span><span id="__span-1-4"><a href="#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="go">cpu_dma_latency  ram11            tty28            tty60</span>
</span><span id="__span-1-5"><a href="#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="go">full             ram12            tty29            tty61</span>
</span><span id="__span-1-6"><a href="#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="go">gpiochip0        ram13            tty3             tty62</span>
</span><span id="__span-1-7"><a href="#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="go">gpiochip1        ram14            tty30            tty63</span>
</span><span id="__span-1-8"><a href="#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="go">gpiochip2        ram15            tty31            tty7</span>
</span><span id="__span-1-9"><a href="#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="go">gpiochip3        ram2             tty32            tty8</span>
</span><span id="__span-1-10"><a href="#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="go">hwrng            ram3             tty33            tty9</span>
</span><span id="__span-1-11"><a href="#__codelineno-1-11" id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="go">i2c-0            ram4             tty34            ttyS0</span>
</span><span id="__span-1-12"><a href="#__codelineno-1-12" id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="go">i2c-2            ram5             tty35            ttyS1</span>
</span><span id="__span-1-13"><a href="#__codelineno-1-13" id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="go">kmsg             ram6             tty36            ttyS2</span>
</span><span id="__span-1-14"><a href="#__codelineno-1-14" id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="go">loop-control     ram7             tty37            ttyS3</span>
</span><span id="__span-1-15"><a href="#__codelineno-1-15" id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="go">loop0            ram8             tty38            ttyS4</span>
</span><span id="__span-1-16"><a href="#__codelineno-1-16" id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="go">loop1            ram9             tty39            ttyS5</span>
</span><span id="__span-1-17"><a href="#__codelineno-1-17" id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="go">loop2            random           tty4             ubi_ctrl</span>
</span><span id="__span-1-18"><a href="#__codelineno-1-18" id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="go">loop3            tty              tty40            urandom</span>
</span><span id="__span-1-19"><a href="#__codelineno-1-19" id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="go">loop4            tty0             tty41            vcs</span>
</span><span id="__span-1-20"><a href="#__codelineno-1-20" id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="go">loop5            tty1             tty42            vcs1</span>
</span><span id="__span-1-21"><a href="#__codelineno-1-21" id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="go">loop6            tty10            tty43            vcs2</span>
</span><span id="__span-1-22"><a href="#__codelineno-1-22" id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="go">loop7            tty11            tty44            vcs3</span>
</span><span id="__span-1-23"><a href="#__codelineno-1-23" id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="go">mem              tty12            tty45            vcs4</span>
</span><span id="__span-1-24"><a href="#__codelineno-1-24" id="__codelineno-1-24" name="__codelineno-1-24"></a><span class="go">mmcblk0          tty13            tty46            vcsa</span>
</span><span id="__span-1-25"><a href="#__codelineno-1-25" id="__codelineno-1-25" name="__codelineno-1-25"></a><span class="go">mmcblk0p1        tty14            tty47            vcsa1</span>
</span><span id="__span-1-26"><a href="#__codelineno-1-26" id="__codelineno-1-26" name="__codelineno-1-26"></a><span class="go">mmcblk0p2        tty15            tty48            vcsa2</span>
</span><span id="__span-1-27"><a href="#__codelineno-1-27" id="__codelineno-1-27" name="__codelineno-1-27"></a><span class="go">mmcblk0p3        tty16            tty49            vcsa3</span>
</span><span id="__span-1-28"><a href="#__codelineno-1-28" id="__codelineno-1-28" name="__codelineno-1-28"></a><span class="go">mmcblk1          tty17            tty5             vcsa4</span>
</span><span id="__span-1-29"><a href="#__codelineno-1-29" id="__codelineno-1-29" name="__codelineno-1-29"></a><span class="go">mmcblk1boot0     tty18            tty50            vcsu</span>
</span><span id="__span-1-30"><a href="#__codelineno-1-30" id="__codelineno-1-30" name="__codelineno-1-30"></a><span class="go">mmcblk1boot1     tty19            tty51            vcsu1</span>
</span><span id="__span-1-31"><a href="#__codelineno-1-31" id="__codelineno-1-31" name="__codelineno-1-31"></a><span class="go">mmcblk1p1        tty2             tty52            vcsu2</span>
</span><span id="__span-1-32"><a href="#__codelineno-1-32" id="__codelineno-1-32" name="__codelineno-1-32"></a><span class="go">mmcblk1rpmb      tty20            tty53            vcsu3</span>
</span><span id="__span-1-33"><a href="#__codelineno-1-33" id="__codelineno-1-33" name="__codelineno-1-33"></a><span class="go">null             tty21            tty54            vcsu4</span>
</span><span id="__span-1-34"><a href="#__codelineno-1-34" id="__codelineno-1-34" name="__codelineno-1-34"></a><span class="go">port             tty22            tty55            vga_arbiter</span>
</span><span id="__span-1-35"><a href="#__codelineno-1-35" id="__codelineno-1-35" name="__codelineno-1-35"></a><span class="go">ptmx             tty23            tty56            zero</span>
</span><span id="__span-1-36"><a href="#__codelineno-1-36" id="__codelineno-1-36" name="__codelineno-1-36"></a><span class="go">ptp0             tty24            tty57</span>
</span><span id="__span-1-37"><a href="#__codelineno-1-37" id="__codelineno-1-37" name="__codelineno-1-37"></a><span class="go">ram0             tty25            tty58</span>
</span></code></pre></div>
<p>Here are a few noteworthy device files that you will see:</p>
<ul>
<li>
<p><em>Terminal devices</em>: devices starting with <code>tty</code>.<br/>
  Terminals are user interfaces taking text as input and producing text as output, and are typically used by interactive shells.<br/>
  In particular, you will find console which matches the device specified through <code>console=</code> in the kernel command line (<em>U-Boot</em>'s <code>bootargs</code>).<br/>
  You will also find the <code>ttyS0</code> device file we used for the emulated debug serial port.</p>
</li>
<li>
<p><em>Pseudo-terminal devices</em>: devices starting with <code>pty</code>, used when you connect through SSH for example.<br/>
  Those are virtual devices, but there are so many in <code>/dev/</code> that we wanted to give a description here.</p>
</li>
<li>
<p><em>MMC devices and partitions</em>: devices starting with <code>mmcblk</code>.<br/>
  You should here recognize the MMC devices on your system, and the associated partitions.</p>
</li>
<li>
<p>If you have a real board (not <em>QEMU</em>) and a USB pen drive, you could plug it in, and if your
kernel was built with USB host and mass storage support, you should see a new <code>sda</code> device
appear, together with the <code>sda<b><i>X</i></b></code> devices for its partitions.</p>
</li>
</ul>
<p>Don't hesitate to explore <code>/dev/</code> on your workstation too!</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-2-1"><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="gp">$ </span>ls<span class="w"> </span>/dev/
</span><span id="__span-2-2"><a href="#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="go">autofs           loop1         rtc0      tty2   tty47      ttyS15   vboxguest</span>
</span><span id="__span-2-3"><a href="#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="go">block            loop10        sda       tty20  tty48      ttyS16   vboxuser</span>
</span><span id="__span-2-4"><a href="#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="go">bsg              loop11        sda1      tty21  tty49      ttyS17   vcs</span>
</span><span id="__span-2-5"><a href="#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="go">btrfs-control    loop12        sdb       tty22  tty5       ttyS18   vcs1</span>
</span><span id="__span-2-6"><a href="#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="go">bus              loop13        sdb1      tty23  tty50      ttyS19   vcs2</span>
</span><span id="__span-2-7"><a href="#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="go">cdrom            loop14        sdc       tty24  tty51      ttyS2    vcs3</span>
</span><span id="__span-2-8"><a href="#__codelineno-2-8" id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="go">char             loop2         sg0       tty25  tty52      ttyS20   vcs4</span>
</span><span id="__span-2-9"><a href="#__codelineno-2-9" id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="go">console          loop3         sg1       tty26  tty53      ttyS21   vcs5</span>
</span><span id="__span-2-10"><a href="#__codelineno-2-10" id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="go">core             loop4         sg2       tty27  tty54      ttyS22   vcs6</span>
</span><span id="__span-2-11"><a href="#__codelineno-2-11" id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="go">cpu              loop5         sg3       tty28  tty55      ttyS23   vcsa</span>
</span><span id="__span-2-12"><a href="#__codelineno-2-12" id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="go">cpu_dma_latency  loop6         shm       tty29  tty56      ttyS24   vcsa1</span>
</span><span id="__span-2-13"><a href="#__codelineno-2-13" id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="go">cuse             loop7         snapshot  tty3   tty57      ttyS25   vcsa2</span>
</span><span id="__span-2-14"><a href="#__codelineno-2-14" id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="go">disk             loop8         snd       tty30  tty58      ttyS26   vcsa3</span>
</span><span id="__span-2-15"><a href="#__codelineno-2-15" id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="go">dma_heap         loop9         sr0       tty31  tty59      ttyS27   vcsa4</span>
</span><span id="__span-2-16"><a href="#__codelineno-2-16" id="__codelineno-2-16" name="__codelineno-2-16"></a><span class="go">dri              loop-control  stderr    tty32  tty6       ttyS28   vcsa5</span>
</span><span id="__span-2-17"><a href="#__codelineno-2-17" id="__codelineno-2-17" name="__codelineno-2-17"></a><span class="go">ecryptfs         mapper        stdin     tty33  tty60      ttyS29   vcsa6</span>
</span><span id="__span-2-18"><a href="#__codelineno-2-18" id="__codelineno-2-18" name="__codelineno-2-18"></a><span class="go">fb0              mcelog        stdout    tty34  tty61      ttyS3    vcsu</span>
</span><span id="__span-2-19"><a href="#__codelineno-2-19" id="__codelineno-2-19" name="__codelineno-2-19"></a><span class="go">fd               mem           tty       tty35  tty62      ttyS30   vcsu1</span>
</span><span id="__span-2-20"><a href="#__codelineno-2-20" id="__codelineno-2-20" name="__codelineno-2-20"></a><span class="go">full             mqueue        tty0      tty36  tty63      ttyS31   vcsu2</span>
</span><span id="__span-2-21"><a href="#__codelineno-2-21" id="__codelineno-2-21" name="__codelineno-2-21"></a><span class="go">fuse             net           tty1      tty37  tty7       ttyS4    vcsu3</span>
</span><span id="__span-2-22"><a href="#__codelineno-2-22" id="__codelineno-2-22" name="__codelineno-2-22"></a><span class="go">hidraw0          null          tty10     tty38  tty8       ttyS5    vcsu4</span>
</span><span id="__span-2-23"><a href="#__codelineno-2-23" id="__codelineno-2-23" name="__codelineno-2-23"></a><span class="go">hpet             nvram         tty11     tty39  tty9       ttyS6    vcsu5</span>
</span><span id="__span-2-24"><a href="#__codelineno-2-24" id="__codelineno-2-24" name="__codelineno-2-24"></a><span class="go">hugepages        port          tty12     tty4   ttyprintk  ttyS7    vcsu6</span>
</span><span id="__span-2-25"><a href="#__codelineno-2-25" id="__codelineno-2-25" name="__codelineno-2-25"></a><span class="go">hwrng            ppp           tty13     tty40  ttyS0      ttyS8    vfio</span>
</span><span id="__span-2-26"><a href="#__codelineno-2-26" id="__codelineno-2-26" name="__codelineno-2-26"></a><span class="go">i2c-0            psaux         tty14     tty41  ttyS1      ttyS9    vga_arbiter</span>
</span><span id="__span-2-27"><a href="#__codelineno-2-27" id="__codelineno-2-27" name="__codelineno-2-27"></a><span class="go">initctl          ptmx          tty15     tty42  ttyS10     udmabuf  vhci</span>
</span><span id="__span-2-28"><a href="#__codelineno-2-28" id="__codelineno-2-28" name="__codelineno-2-28"></a><span class="go">input            pts           tty16     tty43  ttyS11     uhid     vhost-net</span>
</span><span id="__span-2-29"><a href="#__codelineno-2-29" id="__codelineno-2-29" name="__codelineno-2-29"></a><span class="go">kmsg             random        tty17     tty44  ttyS12     uinput   vhost-vsock</span>
</span><span id="__span-2-30"><a href="#__codelineno-2-30" id="__codelineno-2-30" name="__codelineno-2-30"></a><span class="go">log              rfkill        tty18     tty45  ttyS13     urandom  zero</span>
</span><span id="__span-2-31"><a href="#__codelineno-2-31" id="__codelineno-2-31" name="__codelineno-2-31"></a><span class="go">loop0            rtc           tty19     tty46  ttyS14     userio   zfs</span>
</span></code></pre></div>
<h2 id="exploring-sys"><span class="enumerate-headings-plugin enumerate-heading-plugin">19.4</span> Exploring <code>/sys</code></h2>
<p>The next thing you can explore is the <em>sysfs</em> filesystem.</p>
<p>A good place to start is <code>/sys/class/</code>, which exposes devices classified by the kernel frameworks which manage them.</p>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-3-1"><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="gp"># </span>ls<span class="w"> </span>/sys/class/
</span><span id="__span-3-2"><a href="#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="go">ata_device    extcon        mdio_bus      power_supply  scsi_host</span>
</span><span id="__span-3-3"><a href="#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="go">ata_link      firmware      mem           pps           spi_master</span>
</span><span id="__span-3-4"><a href="#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="go">ata_port      gpio          misc          ptp           thermal</span>
</span><span id="__span-3-5"><a href="#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="go">backlight     graphics      mmc_host      pwm           tty</span>
</span><span id="__span-3-6"><a href="#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="go">bdi           i2c-adapter   mtd           regulator     ubi</span>
</span><span id="__span-3-7"><a href="#__codelineno-3-7" id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="go">block         i2c-dev       net           remoteproc    udc</span>
</span><span id="__span-3-8"><a href="#__codelineno-3-8" id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="go">devcoredump   input         pci_bus       rtc           vc</span>
</span><span id="__span-3-9"><a href="#__codelineno-3-9" id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="go">devlink       iommu         pci_epc       scsi_device   vtconsole</span>
</span><span id="__span-3-10"><a href="#__codelineno-3-10" id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="go">dma           lcd           phy           scsi_disk     wakeup</span>
</span></code></pre></div>
<p>For example, go to <code>/sys/class/net/</code>, and you will see all the networking interfaces on your system, whether they are internal, external or virtual ones.</p>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-4-1"><a href="#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="gp"># </span>ls<span class="w"> </span>/sys/class/net/
</span><span id="__span-4-2"><a href="#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="go">eth0  lo    sit0  usb0</span>
</span></code></pre></div>
<p>Find which subdirectory corresponds to the network connection to your host system, and then check device properties such as:</p>
<ul>
<li>
<p><code>speed</code>: will show you whether this is a gigabit or hundred megabit interface.</p>
</li>
<li>
<p><code>address</code>: will show the device MAC address. No need to get it from a complex command!</p>
</li>
<li>
<p><code>statistics/rx_bytes</code> will show you how many bytes were received on this interface.</p>
</li>
</ul>
<p>Don't hesitate to look for further interesting properties by yourself!</p>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-5-1"><a href="#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="gp"># </span>ls<span class="w"> </span>/sys/class/net/eth0/
</span><span id="__span-5-2"><a href="#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="go">addr_assign_type      flags                 phys_port_name</span>
</span><span id="__span-5-3"><a href="#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="go">addr_len              gro_flush_timeout     phys_switch_id</span>
</span><span id="__span-5-4"><a href="#__codelineno-5-4" id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="go">address               ifalias               power</span>
</span><span id="__span-5-5"><a href="#__codelineno-5-5" id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="go">broadcast             ifindex               proto_down</span>
</span><span id="__span-5-6"><a href="#__codelineno-5-6" id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="go">carrier               iflink                queues</span>
</span><span id="__span-5-7"><a href="#__codelineno-5-7" id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="go">carrier_changes       link_mode             speed</span>
</span><span id="__span-5-8"><a href="#__codelineno-5-8" id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="go">carrier_down_count    mtu                   statistics</span>
</span><span id="__span-5-9"><a href="#__codelineno-5-9" id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="go">carrier_up_count      name_assign_type      subsystem</span>
</span><span id="__span-5-10"><a href="#__codelineno-5-10" id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="go">dev_id                napi_defer_hard_irqs  testing</span>
</span><span id="__span-5-11"><a href="#__codelineno-5-11" id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="go">dev_port              netdev_group          threaded</span>
</span><span id="__span-5-12"><a href="#__codelineno-5-12" id="__codelineno-5-12" name="__codelineno-5-12"></a><span class="go">device                operstate             tx_queue_len</span>
</span><span id="__span-5-13"><a href="#__codelineno-5-13" id="__codelineno-5-13" name="__codelineno-5-13"></a><span class="go">dormant               phydev                type</span>
</span><span id="__span-5-14"><a href="#__codelineno-5-14" id="__codelineno-5-14" name="__codelineno-5-14"></a><span class="go">duplex                phys_port_id          uevent</span>
</span><span id="__span-5-15"><a href="#__codelineno-5-15" id="__codelineno-5-15" name="__codelineno-5-15"></a><span class="gp"># </span>cat<span class="w"> </span>/sys/class/net/eth0/speed
</span><span id="__span-5-16"><a href="#__codelineno-5-16" id="__codelineno-5-16" name="__codelineno-5-16"></a><span class="go">100</span>
</span><span id="__span-5-17"><a href="#__codelineno-5-17" id="__codelineno-5-17" name="__codelineno-5-17"></a><span class="gp"># </span>cat<span class="w"> </span>/sys/class/net/eth0/address
</span><span id="__span-5-18"><a href="#__codelineno-5-18" id="__codelineno-5-18" name="__codelineno-5-18"></a><span class="go">54:4a:16:be:9e:ae</span>
</span><span id="__span-5-19"><a href="#__codelineno-5-19" id="__codelineno-5-19" name="__codelineno-5-19"></a><span class="gp"># </span>cat<span class="w"> </span>/sys/class/net/eth0/statistics/rx_bytes
</span><span id="__span-5-20"><a href="#__codelineno-5-20" id="__codelineno-5-20" name="__codelineno-5-20"></a><span class="go">925186</span>
</span></code></pre></div>
<p>You can also check whether <code>/sys/class/thermal/</code> exists and is not empty on your system.
That's the thermal framework, and it allows to access temperature measures from the thermal sensors on your system.</p>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-6-1"><a href="#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="gp"># </span>ls<span class="w"> </span>/sys/class/thermal/
</span></code></pre></div>
<p>Next, you can now explore all the buses (virtual or physical) available on your system, by checking the contents of <code>/sys/bus/</code>.
In particular, go to <code>/sys/bus/mmc/devices/</code> to see all the MMC devices on your system.<br/>
Go inside the directory for the first device and check several files (for example):</p>
<ul>
<li>
<p><code>serial</code>: the serial number for your device.</p>
</li>
<li>
<p><code>preferred_erase_size</code>: the preferred erase block for your device. It's recommended that partitions start at multiples of this size.</p>
</li>
<li>
<p><code>name</code>: the product name for your device. You could display it in a user interface or log file, for example.</p>
</li>
</ul>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-7-1"><a href="#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="gp"># </span>ls<span class="w"> </span>/sys/bus/
</span><span id="__span-7-2"><a href="#__codelineno-7-2" id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="go">clockevents   genpd         mipi-dsi      pci-epf       soc</span>
</span><span id="__span-7-3"><a href="#__codelineno-7-3" id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="go">clocksource   gpio          mmc           platform      spi</span>
</span><span id="__span-7-4"><a href="#__codelineno-7-4" id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="go">container     hid           mmc_rpmb      scsi          usb</span>
</span><span id="__span-7-5"><a href="#__codelineno-7-5" id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="go">cpu           i2c           nvmem         sdio          virtio</span>
</span><span id="__span-7-6"><a href="#__codelineno-7-6" id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="go">event_source  mdio_bus      pci           serial        workqueue</span>
</span><span id="__span-7-7"><a href="#__codelineno-7-7" id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="gp"># </span>ls<span class="w"> </span>/sys/bus/mmc/devices/
</span><span id="__span-7-8"><a href="#__codelineno-7-8" id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="go">mmc0:0001  mmc1:0001</span>
</span><span id="__span-7-9"><a href="#__codelineno-7-9" id="__codelineno-7-9" name="__codelineno-7-9"></a><span class="gp"># </span>ls<span class="w"> </span>/sys/bus/mmc/devices/mmc0:0001/
</span><span id="__span-7-10"><a href="#__codelineno-7-10" id="__codelineno-7-10" name="__codelineno-7-10"></a><span class="go">block                 hwrev                 scr</span>
</span><span id="__span-7-11"><a href="#__codelineno-7-11" id="__codelineno-7-11" name="__codelineno-7-11"></a><span class="go">cid                   manfid                serial</span>
</span><span id="__span-7-12"><a href="#__codelineno-7-12" id="__codelineno-7-12" name="__codelineno-7-12"></a><span class="go">csd                   name                  ssr</span>
</span><span id="__span-7-13"><a href="#__codelineno-7-13" id="__codelineno-7-13" name="__codelineno-7-13"></a><span class="go">date                  ocr                   subsystem</span>
</span><span id="__span-7-14"><a href="#__codelineno-7-14" id="__codelineno-7-14" name="__codelineno-7-14"></a><span class="go">driver                oemid                 type</span>
</span><span id="__span-7-15"><a href="#__codelineno-7-15" id="__codelineno-7-15" name="__codelineno-7-15"></a><span class="go">dsr                   power                 uevent</span>
</span><span id="__span-7-16"><a href="#__codelineno-7-16" id="__codelineno-7-16" name="__codelineno-7-16"></a><span class="go">erase_size            preferred_erase_size</span>
</span><span id="__span-7-17"><a href="#__codelineno-7-17" id="__codelineno-7-17" name="__codelineno-7-17"></a><span class="go">fwrev                 rca</span>
</span><span id="__span-7-18"><a href="#__codelineno-7-18" id="__codelineno-7-18" name="__codelineno-7-18"></a><span class="gp"># </span>cat<span class="w"> </span>/sys/bus/mmc/devices/mmc0:0001/serial
</span><span id="__span-7-19"><a href="#__codelineno-7-19" id="__codelineno-7-19" name="__codelineno-7-19"></a><span class="go">0x000015f1</span>
</span><span id="__span-7-20"><a href="#__codelineno-7-20" id="__codelineno-7-20" name="__codelineno-7-20"></a><span class="gp"># </span>cat<span class="w"> </span>/sys/bus/mmc/devices/mmc0:0001/preferred_erase_size
</span><span id="__span-7-21"><a href="#__codelineno-7-21" id="__codelineno-7-21" name="__codelineno-7-21"></a><span class="go">4194304</span>
</span><span id="__span-7-22"><a href="#__codelineno-7-22" id="__codelineno-7-22" name="__codelineno-7-22"></a><span class="gp"># </span>cat<span class="w"> </span>/sys/bus/mmc/devices/mmc0:0001/name
</span><span id="__span-7-23"><a href="#__codelineno-7-23" id="__codelineno-7-23" name="__codelineno-7-23"></a><span class="go">SD16G</span>
</span></code></pre></div>
<p>Don't hesitate to spend more time exploring <code>/sys/</code> on your system!</p>
<h2 id="driving-gpios"><span class="enumerate-headings-plugin enumerate-heading-plugin">19.5</span> Driving GPIOs</h2>
<p>At this stage, we can only explore GPIOs through the legacy interface in <code>/sys/class/gpio/</code>, because the <code>libgpiod</code> interface commands are provided through a dedicated project which we have to build separately, and <em>BusyBox</em> does not provide a re-implementation for the <code>libgpiod</code> tools.
In a later lab, we will build <code>libgpiod</code> tools which use the modern <code>/dev/gpiochipX</code> interface.</p>
<p>The first thing to do is to enable this legacy interface by enabling <code>CONFIG_GPIO_SYSFS</code> in the kernel configuration.
Also make sure <em>debugfs</em> is enabled (<code>CONFIG_DEBUG_FS</code> and <code>CONFIG_DEBUG_FS_ALLOW_ALL</code>).</p>
<p>After rebooting the new kernel, the first thing to do is to mount the <em>debugfs</em> filesystem.<br/>
Then, you can check information about available GPIOs banks and which GPIOs are already in use.</p>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-8-1"><a href="#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="gp"># </span>mount<span class="w"> </span>-t<span class="w"> </span>debugfs<span class="w"> </span>debugfs<span class="w"> </span>/sys/kernel/debug/
</span><span id="__span-8-2"><a href="#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="gp"># </span>cat<span class="w"> </span>/sys/kernel/debug/gpio
</span><span id="__span-8-3"><a href="#__codelineno-8-3" id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="hll"><span class="go">gpiochip0: GPIOs 0-31, parent: platform/4804c000.gpio, gpio-0-31:</span>
</span></span><span id="__span-8-4"><a href="#__codelineno-8-4" id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="go"> gpio-0   (P8_25 [mmc1_dat0]   )</span>
</span><span id="__span-8-5"><a href="#__codelineno-8-5" id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="go"> gpio-1   ([mmc1_dat1]         )</span>
</span><span id="__span-8-6"><a href="#__codelineno-8-6" id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="go">    ...</span>
</span><span id="__span-8-7"><a href="#__codelineno-8-7" id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="go"> gpio-30  (P8_21 [emmc]        )</span>
</span><span id="__span-8-8"><a href="#__codelineno-8-8" id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="go"> gpio-31  (P8_20 [emmc]        )</span>
</span><span id="__span-8-9"><a href="#__codelineno-8-9" id="__codelineno-8-9" name="__codelineno-8-9"></a>
</span><span id="__span-8-10"><a href="#__codelineno-8-10" id="__codelineno-8-10" name="__codelineno-8-10"></a><span class="hll"><span class="go">gpiochip1: GPIOs 32-63, parent: platform/481ac000.gpio, gpio-32-63:</span>
</span></span><span id="__span-8-11"><a href="#__codelineno-8-11" id="__codelineno-8-11" name="__codelineno-8-11"></a><span class="go"> gpio-32  (P9_15B              )</span>
</span><span id="__span-8-12"><a href="#__codelineno-8-12" id="__codelineno-8-12" name="__codelineno-8-12"></a><span class="go"> gpio-33  (P8_18               )</span>
</span><span id="__span-8-13"><a href="#__codelineno-8-13" id="__codelineno-8-13" name="__codelineno-8-13"></a><span class="go">    ...</span>
</span><span id="__span-8-14"><a href="#__codelineno-8-14" id="__codelineno-8-14" name="__codelineno-8-14"></a><span class="go"> gpio-62  ([mmc0_clk]          )</span>
</span><span id="__span-8-15"><a href="#__codelineno-8-15" id="__codelineno-8-15" name="__codelineno-8-15"></a><span class="go"> gpio-63  ([mmc0_cmd]          )</span>
</span><span id="__span-8-16"><a href="#__codelineno-8-16" id="__codelineno-8-16" name="__codelineno-8-16"></a>
</span><span id="__span-8-17"><a href="#__codelineno-8-17" id="__codelineno-8-17" name="__codelineno-8-17"></a><span class="hll"><span class="go">gpiochip2: GPIOs 64-95, parent: platform/481ae000.gpio, gpio-64-95:</span>
</span></span><span id="__span-8-18"><a href="#__codelineno-8-18" id="__codelineno-8-18" name="__codelineno-8-18"></a><span class="go"> gpio-64  ([mii col]           )</span>
</span><span id="__span-8-19"><a href="#__codelineno-8-19" id="__codelineno-8-19" name="__codelineno-8-19"></a><span class="go"> gpio-65  ([mii crs]           )</span>
</span><span id="__span-8-20"><a href="#__codelineno-8-20" id="__codelineno-8-20" name="__codelineno-8-20"></a><span class="go">    ...</span>
</span><span id="__span-8-21"><a href="#__codelineno-8-21" id="__codelineno-8-21" name="__codelineno-8-21"></a><span class="go"> gpio-94  (NC                  )</span>
</span><span id="__span-8-22"><a href="#__codelineno-8-22" id="__codelineno-8-22" name="__codelineno-8-22"></a><span class="go"> gpio-95  (NC                  )</span>
</span><span id="__span-8-23"><a href="#__codelineno-8-23" id="__codelineno-8-23" name="__codelineno-8-23"></a><span class="hll"><span class="go">gpiochip3: GPIOs 96-127, parent: platform/44e07000.gpio, gpio-96-127:</span>
</span></span><span id="__span-8-24"><a href="#__codelineno-8-24" id="__codelineno-8-24" name="__codelineno-8-24"></a><span class="go"> gpio-96  ([mdio_data]         )</span>
</span><span id="__span-8-25"><a href="#__codelineno-8-25" id="__codelineno-8-25" name="__codelineno-8-25"></a><span class="go"> gpio-97  ([mdio_clk]          )</span>
</span><span id="__span-8-26"><a href="#__codelineno-8-26" id="__codelineno-8-26" name="__codelineno-8-26"></a><span class="go">    ...</span>
</span><span id="__span-8-27"><a href="#__codelineno-8-27" id="__codelineno-8-27" name="__codelineno-8-27"></a><span class="go"> gpio-126 (P9_11 [uart4_rxd]   )</span>
</span><span id="__span-8-28"><a href="#__codelineno-8-28" id="__codelineno-8-28" name="__codelineno-8-28"></a><span class="go"> gpio-127 (P9_13 [uart4_txd]   )</span>
</span></code></pre></div>
<p>We are going to use one of the free GPIOs on the expansion headers of the board, which is not already used by another device.</p>
<p><img alt="https://elinux.org/images/e/e2/BBB_I-O_pins_.png" src="../BBB_I-O_pins_.png"/></p>
<p>Take one of the M-M breadboard wires and:</p>
<ul>
<li>Connect one end to pin 12 of connector <em>P9</em>.</li>
<li>Connect the other end to pin 1 (<code>DGND</code>) of connector <em>P9</em>.</li>
</ul>
<p>If you check the description of the <em>P9</em> connector on the board
<a href="../BBB_SRM.pdf"><em>System Reference Manual</em></a>,
you can see that pin 12 is now called <code>GPIO1_28</code> instead of <code>GPIO_60</code> in the above diagram.
This pin is already configured as a GPIO by default  no need to change pin muxing to use this pin as a GPIO.</p>
<p>If you get back to the contents of <code>/sys/kernel/debug/gpio/</code>, you'll recognize the association between <code>gpio-28</code> on GPIO pin bank <code>0</code> (<code>gpiochip0</code>) and header pin <code>P9_12</code>.
That's very useful information, but you don't have this level of details for all boards, unfortunately.</p>
<p>We now have everything we need to drive this GPIO using the <em>legacy</em> interface.
First, let's enable it.</p>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-9-1"><a href="#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="gp"># </span><span class="nb">cd</span><span class="w"> </span>/sys/class/gpio/
</span><span id="__span-9-2"><a href="#__codelineno-9-2" id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="gp"># </span>ls<span class="w"> </span>-1
</span><span id="__span-9-3"><a href="#__codelineno-9-3" id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="go">export</span>
</span><span id="__span-9-4"><a href="#__codelineno-9-4" id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="go">gpiochip0</span>
</span><span id="__span-9-5"><a href="#__codelineno-9-5" id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="go">gpiochip32</span>
</span><span id="__span-9-6"><a href="#__codelineno-9-6" id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="go">gpiochip64</span>
</span><span id="__span-9-7"><a href="#__codelineno-9-7" id="__codelineno-9-7" name="__codelineno-9-7"></a><span class="go">gpiochip96</span>
</span><span id="__span-9-8"><a href="#__codelineno-9-8" id="__codelineno-9-8" name="__codelineno-9-8"></a><span class="go">unexport</span>
</span><span id="__span-9-9"><a href="#__codelineno-9-9" id="__codelineno-9-9" name="__codelineno-9-9"></a><span class="gp"># </span><span class="nb">echo</span><span class="w"> </span><span class="m">28</span><span class="w"> </span>&gt;<span class="w"> </span><span class="nb">export</span>
</span><span id="__span-9-10"><a href="#__codelineno-9-10" id="__codelineno-9-10" name="__codelineno-9-10"></a><span class="gp"># </span>ls<span class="w"> </span>-1
</span><span id="__span-9-11"><a href="#__codelineno-9-11" id="__codelineno-9-11" name="__codelineno-9-11"></a><span class="go">export</span>
</span><span id="__span-9-12"><a href="#__codelineno-9-12" id="__codelineno-9-12" name="__codelineno-9-12"></a><span class="hll"><span class="go">gpio28</span>
</span></span><span id="__span-9-13"><a href="#__codelineno-9-13" id="__codelineno-9-13" name="__codelineno-9-13"></a><span class="go">gpiochip0</span>
</span><span id="__span-9-14"><a href="#__codelineno-9-14" id="__codelineno-9-14" name="__codelineno-9-14"></a><span class="go">gpiochip32</span>
</span><span id="__span-9-15"><a href="#__codelineno-9-15" id="__codelineno-9-15" name="__codelineno-9-15"></a><span class="go">gpiochip64</span>
</span><span id="__span-9-16"><a href="#__codelineno-9-16" id="__codelineno-9-16" name="__codelineno-9-16"></a><span class="go">gpiochip96</span>
</span><span id="__span-9-17"><a href="#__codelineno-9-17" id="__codelineno-9-17" name="__codelineno-9-17"></a><span class="go">unexport</span>
</span></code></pre></div>
<p>If indeed the pin is still available, this should create a new <code>gpio28</code> file should appear in <code>/sys/class/gpio/</code>.</p>
<p>We can now configure this pin as input, and check its <code>value</code>.
You could use this GPIO to add a button switch to your board, for example.
The value should be <code>0</code> as the pin is connected to a ground level.</p>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-10-1"><a href="#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="gp"># </span><span class="nb">echo</span><span class="w"> </span><span class="k">in</span><span class="w"> </span>&gt;<span class="w"> </span>gpio28/direction
</span><span id="__span-10-2"><a href="#__codelineno-10-2" id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="gp"># </span>cat<span class="w"> </span>gpio28/value
</span><span id="__span-10-3"><a href="#__codelineno-10-3" id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="go">0</span>
</span></code></pre></div>
<p>Now, let's connect our GPIO pin to pin 3 (VDD 3.3 V) of connector P9. Check the above diagram if needed.
Let's check the <code>value</code> again. The value is <code>1</code> because our pin is connected to a 3.3 V level now.</p>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-11-1"><a href="#__codelineno-11-1" id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="gp"># </span>cat<span class="w"> </span>gpio28/value
</span><span id="__span-11-2"><a href="#__codelineno-11-2" id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="go">1</span>
</span></code></pre></div>
<p>Note that you could also configure the pin as output and set its value through the <code>value</code> file.
This way, you could add an external LED to your board, for example.</p>
<p>Before moving on to the next section, you can also check <code>/sys/kernel/debug/gpio/</code> again, and see that <code>gpio-28</code> is now in use, through the <em>sysfs</em> interface, and is configured as an input pin.</p>
<p>When you're done, you can see your GPIO free.</p>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-12-1"><a href="#__codelineno-12-1" id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="gp"># </span><span class="nb">echo</span><span class="w"> </span><span class="m">28</span><span class="w"> </span>&gt;<span class="w"> </span>unexport
</span></code></pre></div>
<h2 id="driving-leds"><span class="enumerate-headings-plugin enumerate-heading-plugin">19.6</span> Driving LEDs</h2>
<p>First, make sure your <em>kernel</em> is compiled with:</p>
<ul>
<li><code>LEDS_CLASS=y</code></li>
<li><code>LEDS_GPIO=y</code></li>
<li><code>LEDS_TRIGGER_TIMER=y</code></li>
</ul>
<div class="language-console highlight"><pre><span></span><code><span id="__span-13-1"><a href="#__codelineno-13-1" id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/../kernel/linux/"</span>
</span><span id="__span-13-2"><a href="#__codelineno-13-2" id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="gp">$ </span>cp<span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/../tinysystem/kernel-busybox.config"</span><span class="w"> </span>.config
</span><span id="__span-13-3"><a href="#__codelineno-13-3" id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="gp">$ </span>make<span class="w"> </span>menuconfig
</span><span id="__span-13-4"><a href="#__codelineno-13-4" id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="gp">$ </span>cp<span class="w"> </span>.config<span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/kernel-leds.config"</span>
</span><span id="__span-13-5"><a href="#__codelineno-13-5" id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="gp">$ </span><span class="nv">TC_NAME</span><span class="o">=</span><span class="s2">"arm-training-linux-uclibcgnueabihf"</span>
</span><span id="__span-13-6"><a href="#__codelineno-13-6" id="__codelineno-13-6" name="__codelineno-13-6"></a><span class="gp">$ </span><span class="nv">TC_BASE</span><span class="o">=</span><span class="s2">"</span><span class="nv">$HOME</span><span class="s2">/x-tools/</span><span class="nv">$TC_NAME</span><span class="s2">"</span>
</span><span id="__span-13-7"><a href="#__codelineno-13-7" id="__codelineno-13-7" name="__codelineno-13-7"></a><span class="gp">$ </span><span class="nb">export</span><span class="w"> </span><span class="nv">PATH</span><span class="o">=</span><span class="s2">"</span><span class="nv">$TC_BASE</span><span class="s2">/bin:</span><span class="nv">$PATH</span><span class="s2">"</span>
</span><span id="__span-13-8"><a href="#__codelineno-13-8" id="__codelineno-13-8" name="__codelineno-13-8"></a><span class="gp">$ </span><span class="nb">export</span><span class="w"> </span><span class="nv">CROSS_COMPILE</span><span class="o">=</span>arm-linux-
</span><span id="__span-13-9"><a href="#__codelineno-13-9" id="__codelineno-13-9" name="__codelineno-13-9"></a><span class="gp">$ </span><span class="nb">export</span><span class="w"> </span><span class="nv">MAKEFLAGS</span><span class="o">=</span>-j<span class="k">$(</span>nproc<span class="k">)</span>
</span><span id="__span-13-10"><a href="#__codelineno-13-10" id="__codelineno-13-10" name="__codelineno-13-10"></a><span class="gp">$ </span><span class="nb">export</span><span class="w"> </span><span class="nv">ARCH</span><span class="o">=</span>arm
</span><span id="__span-13-11"><a href="#__codelineno-13-11" id="__codelineno-13-11" name="__codelineno-13-11"></a><span class="gp">$ </span>make
</span><span id="__span-13-12"><a href="#__codelineno-13-12" id="__codelineno-13-12" name="__codelineno-13-12"></a><span class="gp">$ </span>cp<span class="w"> </span>arch/arm/boot/zImage<span class="w"> </span>/srv/tftp/zImage-with-LEDs
</span><span id="__span-13-13"><a href="#__codelineno-13-13" id="__codelineno-13-13" name="__codelineno-13-13"></a><span class="gp">$ </span>cp<span class="w"> </span>arch/arm/boot/zImage<span class="w"> </span>/srv/tftp/zImage
</span></code></pre></div>
<p>Then, go to <code>/sys/class/leds/</code> to see all the LEDs that you are allowed to control.</p>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-14-1"><a href="#__codelineno-14-1" id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="gp"># </span><span class="nb">cd</span><span class="w"> </span>/sys/class/leds/
</span><span id="__span-14-2"><a href="#__codelineno-14-2" id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="gp"># </span>ls<span class="w"> </span>-1
</span><span id="__span-14-3"><a href="#__codelineno-14-3" id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="hll"><span class="go">beaglebone:green:heartbeat</span>
</span></span><span id="__span-14-4"><a href="#__codelineno-14-4" id="__codelineno-14-4" name="__codelineno-14-4"></a><span class="go">beaglebone:green:mmc0</span>
</span><span id="__span-14-5"><a href="#__codelineno-14-5" id="__codelineno-14-5" name="__codelineno-14-5"></a><span class="go">beaglebone:green:usr2</span>
</span><span id="__span-14-6"><a href="#__codelineno-14-6" id="__codelineno-14-6" name="__codelineno-14-6"></a><span class="go">beaglebone:green:usr3</span>
</span><span id="__span-14-7"><a href="#__codelineno-14-7" id="__codelineno-14-7" name="__codelineno-14-7"></a><span class="go">mmc0::</span>
</span><span id="__span-14-8"><a href="#__codelineno-14-8" id="__codelineno-14-8" name="__codelineno-14-8"></a><span class="go">mmc1::</span>
</span></code></pre></div>
<p>Let's control the LED called <code>beaglebone:green:heartbeat</code>.<br/>
Go into the directory for this LED, and check its <code>trigger</code> (what routine is used to drive its value),</p>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-15-1"><a href="#__codelineno-15-1" id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="gp"># </span><span class="nb">cd</span><span class="w"> </span>beaglebone:green:heartbeat/
</span><span id="__span-15-2"><a href="#__codelineno-15-2" id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="gp"># </span><span class="nv">triggers</span><span class="o">=</span><span class="k">$(</span>cat<span class="w"> </span>trigger<span class="k">)</span>
</span><span id="__span-15-3"><a href="#__codelineno-15-3" id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="gp"># </span><span class="k">for</span><span class="w"> </span>t<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nv">$triggers</span><span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="nv">$t</span><span class="p">;</span><span class="w"> </span><span class="k">done</span>
</span><span id="__span-15-4"><a href="#__codelineno-15-4" id="__codelineno-15-4" name="__codelineno-15-4"></a><span class="hll"><span class="go">[none]</span>
</span></span><span id="__span-15-5"><a href="#__codelineno-15-5" id="__codelineno-15-5" name="__codelineno-15-5"></a><span class="go">kbd-scrolllock</span>
</span><span id="__span-15-6"><a href="#__codelineno-15-6" id="__codelineno-15-6" name="__codelineno-15-6"></a><span class="go">kbd-numlock</span>
</span><span id="__span-15-7"><a href="#__codelineno-15-7" id="__codelineno-15-7" name="__codelineno-15-7"></a><span class="go">kbd-capslock</span>
</span><span id="__span-15-8"><a href="#__codelineno-15-8" id="__codelineno-15-8" name="__codelineno-15-8"></a><span class="go">kbd-kanalock</span>
</span><span id="__span-15-9"><a href="#__codelineno-15-9" id="__codelineno-15-9" name="__codelineno-15-9"></a><span class="go">kbd-shiftlock</span>
</span><span id="__span-15-10"><a href="#__codelineno-15-10" id="__codelineno-15-10" name="__codelineno-15-10"></a><span class="go">kbd-altgrlock</span>
</span><span id="__span-15-11"><a href="#__codelineno-15-11" id="__codelineno-15-11" name="__codelineno-15-11"></a><span class="go">kbd-ctrllock</span>
</span><span id="__span-15-12"><a href="#__codelineno-15-12" id="__codelineno-15-12" name="__codelineno-15-12"></a><span class="go">kbd-altlock</span>
</span><span id="__span-15-13"><a href="#__codelineno-15-13" id="__codelineno-15-13" name="__codelineno-15-13"></a><span class="go">kbd-shiftllock</span>
</span><span id="__span-15-14"><a href="#__codelineno-15-14" id="__codelineno-15-14" name="__codelineno-15-14"></a><span class="go">kbd-shiftrlock</span>
</span><span id="__span-15-15"><a href="#__codelineno-15-15" id="__codelineno-15-15" name="__codelineno-15-15"></a><span class="go">kbd-ctrlllock</span>
</span><span id="__span-15-16"><a href="#__codelineno-15-16" id="__codelineno-15-16" name="__codelineno-15-16"></a><span class="go">kbd-ctrlrlock</span>
</span><span id="__span-15-17"><a href="#__codelineno-15-17" id="__codelineno-15-17" name="__codelineno-15-17"></a><span class="go">timer</span>
</span><span id="__span-15-18"><a href="#__codelineno-15-18" id="__codelineno-15-18" name="__codelineno-15-18"></a><span class="go">cpu</span>
</span><span id="__span-15-19"><a href="#__codelineno-15-19" id="__codelineno-15-19" name="__codelineno-15-19"></a><span class="go">cpu0</span>
</span><span id="__span-15-20"><a href="#__codelineno-15-20" id="__codelineno-15-20" name="__codelineno-15-20"></a><span class="go">mmc0</span>
</span><span id="__span-15-21"><a href="#__codelineno-15-21" id="__codelineno-15-21" name="__codelineno-15-21"></a><span class="go">mmc1</span>
</span></code></pre></div>
<p>As you can see, there are many triggers to choose from, the current being <code>none</code>.</p>
<p>You can directly control the LED without a trigger:</p>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-16-1"><a href="#__codelineno-16-1" id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="gp"># </span><span class="nb">echo</span><span class="w"> </span>none<span class="w"> </span>&gt;<span class="w"> </span>trigger
</span><span id="__span-16-2"><a href="#__codelineno-16-2" id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="gp"># </span><span class="nb">echo</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>&gt;<span class="w"> </span>brightness
</span><span id="__span-16-3"><a href="#__codelineno-16-3" id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="gp"># </span><span class="nb">echo</span><span class="w"> </span><span class="m">0</span><span class="w"> </span>&gt;<span class="w"> </span>brightness
</span></code></pre></div>
<p>You could also use the timer trigger to light the LED with specified time on and time off.</p>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-17-1"><a href="#__codelineno-17-1" id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="gp"># </span><span class="nb">echo</span><span class="w"> </span>timer<span class="w"> </span>&gt;<span class="w"> </span>trigger
</span><span id="__span-17-2"><a href="#__codelineno-17-2" id="__codelineno-17-2" name="__codelineno-17-2"></a><span class="gp"># </span><span class="nb">echo</span><span class="w"> </span><span class="m">10</span><span class="w"> </span>&gt;<span class="w"> </span>delay_on
</span><span id="__span-17-3"><a href="#__codelineno-17-3" id="__codelineno-17-3" name="__codelineno-17-3"></a><span class="gp"># </span><span class="nb">echo</span><span class="w"> </span><span class="m">200</span><span class="w"> </span>&gt;<span class="w"> </span>delay_off
</span></code></pre></div>
<p>You can disable all triggers by:</p>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-18-1"><a href="#__codelineno-18-1" id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="gp"># </span><span class="nb">echo</span><span class="w"> </span>none<span class="w"> </span>&gt;<span class="w"> </span>trigger
</span></code></pre></div>
<h2 id="managing-i2c-bus-and-devices"><span class="enumerate-headings-plugin enumerate-heading-plugin">19.7</span> Managing I2C bus and devices</h2>
<h3 id="enabling-i2c-bus"><span class="enumerate-headings-plugin enumerate-heading-plugin">19.7.1</span> Enabling I2C bus</h3>
<p>The next thing we want to do is connect a <em>Nintendo Nunchuk</em> joystick to an <em>I2C</em> bus on our board.
The I2C bus is very frequently used to connect all sorts of external devices. That's why we're covering it here.</p>
<p>As shown on the picture below, the BeagleBone Black has two I2C busses available on its expansion headers: <em>I2C1</em> and <em>I2C2</em>. Another one exists (<em>I2C0</em>), but it's not available on the external headers.</p>
<p><img alt="https://elinux.org/images/f/fe/2_I2C_Ports.PNG" src="../2_I2C_Ports.png"/></p>
<p>In this lab, we will try to use <em>I2C1</em> on <em>P9</em> pins 17 and 18, because it's more interesting to use than <em>I2C2</em>, which is already enabled by default.</p>
<p>So, let's see which I2C buses are already enabled:</p>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-19-1"><a href="#__codelineno-19-1" id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="gp"># </span>i2cdetect<span class="w"> </span>-l
</span><span id="__span-19-2"><a href="#__codelineno-19-2" id="__codelineno-19-2" name="__codelineno-19-2"></a><span class="go">i2c-2   i2c             OMAP I2C adapter                        I2C adapter</span>
</span><span id="__span-19-3"><a href="#__codelineno-19-3" id="__codelineno-19-3" name="__codelineno-19-3"></a><span class="go">i2c-0   i2c             OMAP I2C adapter                        I2C adapter</span>
</span></code></pre></div>
<p>Here you can see that I2C1 is missing.</p>
<p>As the bus numbering scheme in Linux doesn't always match the one on the datasheets, let's check the base addresses of the registers of these controllers:</p>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-20-1"><a href="#__codelineno-20-1" id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="gp"># </span>ls<span class="w"> </span>-l<span class="w"> </span>/sys/bus/i2c/devices/i2c-*
</span><span id="__span-20-2"><a href="#__codelineno-20-2" id="__codelineno-20-2" name="__codelineno-20-2"></a><span class="go">lrwxrwxrwx    1         0 Jan  1 01:15 /sys/bus/i2c/devices/i2c-0 -&gt; \</span>
</span><span id="__span-20-3"><a href="#__codelineno-20-3" id="__codelineno-20-3" name="__codelineno-20-3"></a><span class="go">../../../devices/platform/ocp/44c00000.interconnect/\</span>
</span><span id="__span-20-4"><a href="#__codelineno-20-4" id="__codelineno-20-4" name="__codelineno-20-4"></a><span class="go">44c00000.interconnect:segment@200000/44e0b000.target-module/44e0b000.i2c/i2c-0</span>
</span><span id="__span-20-5"><a href="#__codelineno-20-5" id="__codelineno-20-5" name="__codelineno-20-5"></a><span class="go">lrwxrwxrwx    1         0 Jan  1 01:15 /sys/bus/i2c/devices/i2c-2 -&gt; \</span>
</span><span id="__span-20-6"><a href="#__codelineno-20-6" id="__codelineno-20-6" name="__codelineno-20-6"></a><span class="go">../../../devices/platform/ocp/48000000.interconnect/\</span>
</span><span id="__span-20-7"><a href="#__codelineno-20-7" id="__codelineno-20-7" name="__codelineno-20-7"></a><span class="go">48000000.interconnect:segment@100000/4819c000.target-module/4819c000.i2c/i2c-2</span>
</span></code></pre></div>
<p>That's not completely straighforward, but you can suppose that:</p>
<ul>
<li><em>I2C0</em> is at address <code>0x44e0b000</code></li>
<li><em>I2C2</em> is at address <code>0x4819c000</code></li>
</ul>
<p>Now let's double check the addressings by looking at the <em>TI AM335x</em> SoC datasheet, in the <em>L4_WKUP Peripheral Memory Map</em> section:</p>
<ul>
<li><em>I2C0</em> is at address <code>0x44e0b000</code></li>
<li><em>I2C1</em> is at address <code>0x4802a000</code></li>
<li><em>I2C2</em> is at address <code>0x4819c000</code></li>
</ul>
<p>So, we are lucky that <code>i2c-0</code> in Linux corresponds to <em>I2C0</em> in the datasheet, and that <code>i2c-2</code> corresponds to <em>I2C2</em>. We're just missing <code>i2c-1</code>.</p>
<h3 id="customizing-device-tree"><span class="enumerate-headings-plugin enumerate-heading-plugin">19.7.2</span> Customizing Device Tree</h3>
<p>Fortunately, <em>I2C1</em> is already defined in the one of the <em>DTS</em> includes used by the <em>Device Tree</em> for our board. In our case, that's in <code>arch/arm/boot/dts/am33xx-l4.dtsi</code>.
Look by yourself in this file, and you will find its definition, but with <code>status = "disabled";</code>.
This means that this I2C controller is not enabled yet, and it's up to boards using it to do so.</p>
<p>We could modify the <code>arch/arm/boot/dts/am335x-boneblack.dts</code> file for our board, but that's not a very good idea as this file is maintained by the kernel developers.
The changes that you make could collide with future changes made by the maintainers for this file.</p>
<p>A more futureproof idea is to create a new Device Tree file which includes the standard one, and adds custom definitions. So, create a new <code>arch/arm/boot/dts/am335x-boneblack-custom.dts</code> file containing:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-21-1"><a href="#__codelineno-21-1" id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/../kernel/linux/"</span>
</span><span id="__span-21-2"><a href="#__codelineno-21-2" id="__codelineno-21-2" name="__codelineno-21-2"></a><span class="gp">$ </span>nano<span class="w"> </span>arch/arm/boot/dts/am335x-boneblack-custom.dts
</span></code></pre></div>
<div class="language-c highlight"><span class="filename">arch/arm/boot/dts/am335x-boneblack-custom.dts</span><pre><span></span><code><span id="__span-22-1"><a href="#__codelineno-22-1" id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="o">/</span><span class="n">dts</span><span class="o">-</span><span class="n">v1</span><span class="o">/</span><span class="p">;</span>
</span><span id="__span-22-2"><a href="#__codelineno-22-2" id="__codelineno-22-2" name="__codelineno-22-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">"am335x-boneblack.dts"</span>
</span><span id="__span-22-3"><a href="#__codelineno-22-3" id="__codelineno-22-3" name="__codelineno-22-3"></a>
</span><span id="__span-22-4"><a href="#__codelineno-22-4" id="__codelineno-22-4" name="__codelineno-22-4"></a><span class="o">&amp;</span><span class="n">i2c1</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-22-5"><a href="#__codelineno-22-5" id="__codelineno-22-5" name="__codelineno-22-5"></a><span class="w">        </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"okay"</span><span class="p">;</span>
</span><span id="__span-22-6"><a href="#__codelineno-22-6" id="__codelineno-22-6" name="__codelineno-22-6"></a><span class="p">};</span>
</span></code></pre></div>
<p>As you can see, it's also possible to include <code>dts</code> files, and not only <code>dtsi</code> ones.</p>
<p>Modify the <code>arch/arm/boot/dts/Makefile</code> file to add your custom Device Tree, and then have it compiled (<code>make dtbs</code>).</p>
<div class="language-make highlight"><span class="filename">arch/arm/boot/dts/Makefile</span><pre><span></span><code><span id="__span-23-1"><a href="#__codelineno-23-1" id="__codelineno-23-1" name="__codelineno-23-1"></a><span class="w">    </span>...
</span><span id="__span-23-2"><a href="#__codelineno-23-2" id="__codelineno-23-2" name="__codelineno-23-2"></a><span class="nv">dtb-$(CONFIG_SOC_AM33XX)</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-23-3"><a href="#__codelineno-23-3" id="__codelineno-23-3" name="__codelineno-23-3"></a><span class="w">        </span>am335x-baltos-ir2110.dtb<span class="w"> </span><span class="se">\</span>
</span><span id="__span-23-4"><a href="#__codelineno-23-4" id="__codelineno-23-4" name="__codelineno-23-4"></a><span class="w">        </span>am335x-baltos-ir3220.dtb<span class="w"> </span><span class="se">\</span>
</span><span id="__span-23-5"><a href="#__codelineno-23-5" id="__codelineno-23-5" name="__codelineno-23-5"></a><span class="w">        </span>am335x-baltos-ir5221.dtb<span class="w"> </span><span class="se">\</span>
</span><span id="__span-23-6"><a href="#__codelineno-23-6" id="__codelineno-23-6" name="__codelineno-23-6"></a><span class="w">        </span>am335x-base0033.dtb<span class="w"> </span><span class="se">\</span>
</span><span id="__span-23-7"><a href="#__codelineno-23-7" id="__codelineno-23-7" name="__codelineno-23-7"></a><span class="w">        </span>am335x-bone.dtb<span class="w"> </span><span class="se">\</span>
</span><span id="__span-23-8"><a href="#__codelineno-23-8" id="__codelineno-23-8" name="__codelineno-23-8"></a><span class="w">        </span>am335x-boneblack.dtb<span class="w"> </span><span class="se">\</span>
</span><span id="__span-23-9"><a href="#__codelineno-23-9" id="__codelineno-23-9" name="__codelineno-23-9"></a><span class="hll"><span class="w">        </span>am335x-boneblack-custom.dtb<span class="w"> </span><span class="se">\</span>
</span></span><span id="__span-23-10"><a href="#__codelineno-23-10" id="__codelineno-23-10" name="__codelineno-23-10"></a><span class="w">        </span>am335x-boneblack-wireless.dtb<span class="w"> </span><span class="se">\</span>
</span><span id="__span-23-11"><a href="#__codelineno-23-11" id="__codelineno-23-11" name="__codelineno-23-11"></a><span class="w">        </span>am335x-boneblue.dtb<span class="w"> </span><span class="se">\</span>
</span><span id="__span-23-12"><a href="#__codelineno-23-12" id="__codelineno-23-12" name="__codelineno-23-12"></a><span class="w">        </span>am335x-bonegreen.dtb<span class="w"> </span><span class="se">\</span>
</span><span id="__span-23-13"><a href="#__codelineno-23-13" id="__codelineno-23-13" name="__codelineno-23-13"></a><span class="w">    </span>...
</span></code></pre></div>
<p>Update the board and reboot.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-24-1"><a href="#__codelineno-24-1" id="__codelineno-24-1" name="__codelineno-24-1"></a><span class="gp">$ </span>make<span class="w"> </span>dtbs
</span><span id="__span-24-2"><a href="#__codelineno-24-2" id="__codelineno-24-2" name="__codelineno-24-2"></a><span class="go">  DTC     arch/arm/boot/dts/am335x-boneblack-custom.dtb</span>
</span><span id="__span-24-3"><a href="#__codelineno-24-3" id="__codelineno-24-3" name="__codelineno-24-3"></a><span class="gp">$ </span>cp<span class="w"> </span>arch/arm/boot/dts/am335x-boneblack-custom.dtb<span class="w"> </span>/srv/tftp/
</span></code></pre></div>
<div class="language-console highlight"><span class="filename">picocomBBB - U-Boot</span><pre><span></span><code><span id="__span-25-1"><a href="#__codelineno-25-1" id="__codelineno-25-1" name="__codelineno-25-1"></a><span class="go">    ...</span>
</span><span id="__span-25-2"><a href="#__codelineno-25-2" id="__codelineno-25-2" name="__codelineno-25-2"></a><span class="go">Hit any key to stop autoboot:  0</span>
</span><span id="__span-25-3"><a href="#__codelineno-25-3" id="__codelineno-25-3" name="__codelineno-25-3"></a><span class="go">=&gt; setenv bootcmd_tftp "tftp 0x81000000 zImage;  tftp 0x82000000 am335x-boneblack-custom.dtb;  bootz 0x81000000 - 0x82000000"</span>
</span><span id="__span-25-4"><a href="#__codelineno-25-4" id="__codelineno-25-4" name="__codelineno-25-4"></a><span class="go">=&gt; setenv bootcmd $bootcmd_tftp</span>
</span><span id="__span-25-5"><a href="#__codelineno-25-5" id="__codelineno-25-5" name="__codelineno-25-5"></a><span class="go">=&gt; saveenv</span>
</span><span id="__span-25-6"><a href="#__codelineno-25-6" id="__codelineno-25-6" name="__codelineno-25-6"></a><span class="go">=&gt; reset</span>
</span></code></pre></div>
<p>Back to the running system, we can now see that there is one more I2C bus:</p>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-26-1"><a href="#__codelineno-26-1" id="__codelineno-26-1" name="__codelineno-26-1"></a><span class="gp"># </span>i2cdetect<span class="w"> </span>-l
</span><span id="__span-26-2"><a href="#__codelineno-26-2" id="__codelineno-26-2" name="__codelineno-26-2"></a><span class="hll"><span class="go">i2c-1   i2c             OMAP I2C adapter                        I2C adapter</span>
</span></span><span id="__span-26-3"><a href="#__codelineno-26-3" id="__codelineno-26-3" name="__codelineno-26-3"></a><span class="go">i2c-2   i2c             OMAP I2C adapter                        I2C adapter</span>
</span><span id="__span-26-4"><a href="#__codelineno-26-4" id="__codelineno-26-4" name="__codelineno-26-4"></a><span class="go">i2c-0   i2c             OMAP I2C adapter                        I2C adapter</span>
</span></code></pre></div>
<p>Run the below command to confirm that the new bus has the same address as in the datasheet (<code>0x4802a000</code>):</p>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-27-1"><a href="#__codelineno-27-1" id="__codelineno-27-1" name="__codelineno-27-1"></a><span class="gp"># </span>ls<span class="w"> </span>-l<span class="w"> </span>/sys/bus/i2c/devices/i2c-1
</span><span id="__span-27-2"><a href="#__codelineno-27-2" id="__codelineno-27-2" name="__codelineno-27-2"></a><span class="go">lrwxrwxrwx    1         0 Jan  1 00:02 /sys/bus/i2c/devices/i2c-1 -&gt; \</span>
</span><span id="__span-27-3"><a href="#__codelineno-27-3" id="__codelineno-27-3" name="__codelineno-27-3"></a><span class="go">  ../../../devices/platform/ocp/48000000.interconnect/\</span>
</span><span id="__span-27-4"><a href="#__codelineno-27-4" id="__codelineno-27-4" name="__codelineno-27-4"></a><span class="go">  48000000.interconnect:segment@0/4802a000.target-module/4802a000.i2c/i2c-1</span>
</span></code></pre></div>
<p>Now, let's use <code>i2cdetect</code>'s capability to probe a bus for devices.
Let's start by the bus associated to <code>i2c-0</code>:</p>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-28-1"><a href="#__codelineno-28-1" id="__codelineno-28-1" name="__codelineno-28-1"></a><span class="gp"># </span>i2cdetect<span class="w"> </span>-y<span class="w"> </span>-r<span class="w"> </span><span class="m">0</span>
</span><span id="__span-28-2"><a href="#__codelineno-28-2" id="__codelineno-28-2" name="__codelineno-28-2"></a><span class="go">     0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f</span>
</span><span id="__span-28-3"><a href="#__codelineno-28-3" id="__codelineno-28-3" name="__codelineno-28-3"></a><span class="go">00:          -- -- -- -- -- -- -- -- -- -- -- -- --</span>
</span><span id="__span-28-4"><a href="#__codelineno-28-4" id="__codelineno-28-4" name="__codelineno-28-4"></a><span class="go">10: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --</span>
</span><span id="__span-28-5"><a href="#__codelineno-28-5" id="__codelineno-28-5" name="__codelineno-28-5"></a><span class="go">20: -- -- -- -- UU -- -- -- -- -- -- -- -- -- -- --</span>
</span><span id="__span-28-6"><a href="#__codelineno-28-6" id="__codelineno-28-6" name="__codelineno-28-6"></a><span class="go">30: -- -- -- -- 34 -- -- -- -- -- -- -- -- -- -- --</span>
</span><span id="__span-28-7"><a href="#__codelineno-28-7" id="__codelineno-28-7" name="__codelineno-28-7"></a><span class="go">40: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --</span>
</span><span id="__span-28-8"><a href="#__codelineno-28-8" id="__codelineno-28-8" name="__codelineno-28-8"></a><span class="go">50: 50 -- -- -- -- -- -- -- -- -- -- -- -- -- -- --</span>
</span><span id="__span-28-9"><a href="#__codelineno-28-9" id="__codelineno-28-9" name="__codelineno-28-9"></a><span class="go">60: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --</span>
</span><span id="__span-28-10"><a href="#__codelineno-28-10" id="__codelineno-28-10" name="__codelineno-28-10"></a><span class="go">70: -- -- -- -- -- -- -- --</span>
</span></code></pre></div>
<p>We can see three devices on this internal bus:</p>
<ul>
<li>
<p>One at address <code>0x24</code>, indicated by <code>UU</code>, which means that there is a kernel driver actively driving this device.</p>
</li>
<li>
<p>Two other devices at addresses <code>0x34</code> and <code>0x50</code>. We just know that they are currently not bound to a kernel driver.</p>
</li>
</ul>
<p>Now try to probe <em>I2C1</em>:</p>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-29-1"><a href="#__codelineno-29-1" id="__codelineno-29-1" name="__codelineno-29-1"></a><span class="gp"># </span>i2cdetect<span class="w"> </span>-y<span class="w"> </span>-r<span class="w"> </span><span class="m">1</span>
</span><span id="__span-29-2"><a href="#__codelineno-29-2" id="__codelineno-29-2" name="__codelineno-29-2"></a><span class="go">     0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f</span>
</span><span id="__span-29-3"><a href="#__codelineno-29-3" id="__codelineno-29-3" name="__codelineno-29-3"></a><span class="go">00:          [  469.430509] omap_i2c 4802a000.i2c: timeout waiting for bus ready</span>
</span><span id="__span-29-4"><a href="#__codelineno-29-4" id="__codelineno-29-4" name="__codelineno-29-4"></a><span class="go">    ...</span>
</span></code></pre></div>
<p>You will see that the command will fail to connect to the bus. That's because the corresponding
signals are not exposed yet to the outside connectors through pin muxing.</p>
<p>So, get back to your custom Device Tree and add pin muxing definitions for <em>I2C1</em> (we took them from a device tree from another board with the same CPU: <code>arch/arm/boot/dts/am335x-evm.dts</code>) and refer to these definitions in the <code>i2c1</code> node through the <code>pinctrl-names</code> and <code>pinctrl-0</code> properties:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-30-1"><a href="#__codelineno-30-1" id="__codelineno-30-1" name="__codelineno-30-1"></a><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/../kernel/linux/"</span>
</span><span id="__span-30-2"><a href="#__codelineno-30-2" id="__codelineno-30-2" name="__codelineno-30-2"></a><span class="gp">$ </span>nano<span class="w"> </span>arch/arm/boot/dts/am335x-boneblack-custom.dts
</span></code></pre></div>
<div class="language-c highlight"><span class="filename">arch/arm/boot/dts/am335x-boneblack-custom.dts</span><pre><span></span><code><span id="__span-31-1"><a href="#__codelineno-31-1" id="__codelineno-31-1" name="__codelineno-31-1"></a><span class="o">/</span><span class="n">dts</span><span class="o">-</span><span class="n">v1</span><span class="o">/</span><span class="p">;</span>
</span><span id="__span-31-2"><a href="#__codelineno-31-2" id="__codelineno-31-2" name="__codelineno-31-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">"am335x-boneblack.dts"</span>
</span><span id="__span-31-3"><a href="#__codelineno-31-3" id="__codelineno-31-3" name="__codelineno-31-3"></a>
</span><span id="__span-31-4"><a href="#__codelineno-31-4" id="__codelineno-31-4" name="__codelineno-31-4"></a><span class="o">&amp;</span><span class="n">am33xx_pinmux</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-5"><a href="#__codelineno-31-5" id="__codelineno-31-5" name="__codelineno-31-5"></a><span class="w">        </span><span class="nl">i2c1_pins</span><span class="p">:</span><span class="w"> </span><span class="n">pinmux_i2c1_pins</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-6"><a href="#__codelineno-31-6" id="__codelineno-31-6" name="__codelineno-31-6"></a><span class="w">                </span><span class="n">pinctrl</span><span class="o">-</span><span class="n">single</span><span class="p">,</span><span class="n">pins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span>
</span><span id="__span-31-7"><a href="#__codelineno-31-7" id="__codelineno-31-7" name="__codelineno-31-7"></a><span class="w">                        </span><span class="n">AM33XX_PADCONF</span><span class="p">(</span><span class="n">AM335X_PIN_SPI0_CS0</span><span class="p">,</span><span class="w"> </span><span class="n">PIN_INPUT_PULLUP</span><span class="p">,</span><span class="w"> </span><span class="n">MUX_MODE2</span><span class="p">)</span><span class="w">  </span><span class="cm">/* spi0_cs0.i2c1_scl */</span>
</span><span id="__span-31-8"><a href="#__codelineno-31-8" id="__codelineno-31-8" name="__codelineno-31-8"></a><span class="w">                        </span><span class="n">AM33XX_PADCONF</span><span class="p">(</span><span class="n">AM335X_PIN_SPI0_D1</span><span class="p">,</span><span class="w"> </span><span class="n">PIN_INPUT_PULLUP</span><span class="p">,</span><span class="w"> </span><span class="n">MUX_MODE2</span><span class="p">)</span><span class="w">  </span><span class="cm">/* spi0_d1.i2c1_sda */</span>
</span><span id="__span-31-9"><a href="#__codelineno-31-9" id="__codelineno-31-9" name="__codelineno-31-9"></a><span class="w">                </span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-31-10"><a href="#__codelineno-31-10" id="__codelineno-31-10" name="__codelineno-31-10"></a><span class="w">        </span><span class="p">};</span>
</span><span id="__span-31-11"><a href="#__codelineno-31-11" id="__codelineno-31-11" name="__codelineno-31-11"></a><span class="p">};</span>
</span><span id="__span-31-12"><a href="#__codelineno-31-12" id="__codelineno-31-12" name="__codelineno-31-12"></a>
</span><span id="__span-31-13"><a href="#__codelineno-31-13" id="__codelineno-31-13" name="__codelineno-31-13"></a><span class="o">&amp;</span><span class="n">i2c1</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-14"><a href="#__codelineno-31-14" id="__codelineno-31-14" name="__codelineno-31-14"></a><span class="w">        </span><span class="n">pinctrl</span><span class="o">-</span><span class="n">names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"default"</span><span class="p">;</span>
</span><span id="__span-31-15"><a href="#__codelineno-31-15" id="__codelineno-31-15" name="__codelineno-31-15"></a><span class="w">        </span><span class="n">pinctrl</span><span class="mi">-0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="n">i2c1_pins</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-31-16"><a href="#__codelineno-31-16" id="__codelineno-31-16" name="__codelineno-31-16"></a><span class="w">        </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"okay"</span><span class="p">;</span>
</span><span id="__span-31-17"><a href="#__codelineno-31-17" id="__codelineno-31-17" name="__codelineno-31-17"></a><span class="p">};</span>
</span></code></pre></div>
<p>You can understand the above values thanks to the pin muxing diagram for connector <em>P9</em>, which was extracted from the board <a href="../BBB_SRM.pdf"><em>System Reference Manual</em></a>:</p>
<ul>
<li>
<p><code>AM335X_PIN_SPI0_CS0</code> and <code>AM335X_PIN_SPI0_D1</code> are the offsets of the registers controlling pin muxing for the corresponding pins of the SoC package.</p>
</li>
<li>
<p><code>PIN_INPUT_PULLUP</code> is one of the supported options for these pins. They integrate the pull-up resistors expected for an <em>I2C</em> bus (typically by external resistors).</p>
</li>
<li>
<p><code>MUX_MODE2</code> corresponds to <em>MODE2</em>, to get <em>I2C1_SCL</em> and <em>I2C1_SDA</em> signals on such pins.</p>
</li>
</ul>
<p><img alt="https://elinux.org/images/5/5f/H9Pinout.PNG" src="../H9Pinout.png"/></p>
<p>Recompile your <em>Device Tree</em> and reboot.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-32-1"><a href="#__codelineno-32-1" id="__codelineno-32-1" name="__codelineno-32-1"></a><span class="gp">$ </span>make<span class="w"> </span>dtbs
</span><span id="__span-32-2"><a href="#__codelineno-32-2" id="__codelineno-32-2" name="__codelineno-32-2"></a><span class="hll"><span class="go">  DTC     arch/arm/boot/dts/am335x-boneblack-custom.dtb</span>
</span></span><span id="__span-32-3"><a href="#__codelineno-32-3" id="__codelineno-32-3" name="__codelineno-32-3"></a><span class="gp">$ </span>cp<span class="w"> </span>arch/arm/boot/dts/am335x-boneblack-custom.dtb<span class="w"> </span>/srv/tftp/
</span></code></pre></div>
<p>You should now be able to probe your bus:</p>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-33-1"><a href="#__codelineno-33-1" id="__codelineno-33-1" name="__codelineno-33-1"></a><span class="gp"># </span>i2cdetect<span class="w"> </span>-y<span class="w"> </span>-r<span class="w"> </span><span class="m">1</span>
</span><span id="__span-33-2"><a href="#__codelineno-33-2" id="__codelineno-33-2" name="__codelineno-33-2"></a><span class="go">     0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f</span>
</span><span id="__span-33-3"><a href="#__codelineno-33-3" id="__codelineno-33-3" name="__codelineno-33-3"></a><span class="go">00:          -- -- -- -- -- -- -- -- -- -- -- -- --</span>
</span><span id="__span-33-4"><a href="#__codelineno-33-4" id="__codelineno-33-4" name="__codelineno-33-4"></a><span class="go">10: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --</span>
</span><span id="__span-33-5"><a href="#__codelineno-33-5" id="__codelineno-33-5" name="__codelineno-33-5"></a><span class="go">20: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --</span>
</span><span id="__span-33-6"><a href="#__codelineno-33-6" id="__codelineno-33-6" name="__codelineno-33-6"></a><span class="go">30: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --</span>
</span><span id="__span-33-7"><a href="#__codelineno-33-7" id="__codelineno-33-7" name="__codelineno-33-7"></a><span class="go">40: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --</span>
</span><span id="__span-33-8"><a href="#__codelineno-33-8" id="__codelineno-33-8" name="__codelineno-33-8"></a><span class="go">50: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --</span>
</span><span id="__span-33-9"><a href="#__codelineno-33-9" id="__codelineno-33-9" name="__codelineno-33-9"></a><span class="go">60: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --</span>
</span><span id="__span-33-10"><a href="#__codelineno-33-10" id="__codelineno-33-10" name="__codelineno-33-10"></a><span class="go">70: -- -- -- -- -- -- -- --</span>
</span></code></pre></div>
<p>No device is detected yet, because this bus is just used for external devices. It's time to add one though.</p>
<h3 id="adding-i2c-device"><span class="enumerate-headings-plugin enumerate-heading-plugin">19.7.3</span> Adding I2C device</h3>
<p>Let's connect the <em>Nunchuk</em> to the <em>I2C1</em> bus on the board. To know its pinout, please refer to the <a href="../nunchuk.pdf">excerpt found on the <em>Bootlin</em> website</a>.<br/>
Connections on the <em>Nunchuk</em> depend on the adapter you're using (if any); please refer to its own pinout.</p>
<p><img alt="BBB I2C Nunchuck connections; photo by *Bootlin*" src="../bbb-nunchuck.jpg"/></p>
<p>If you didn't make any mistakes, your new device should be detected at address <code>0x52</code>:</p>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-34-1"><a href="#__codelineno-34-1" id="__codelineno-34-1" name="__codelineno-34-1"></a><span class="gp"># </span>i2cdetect<span class="w"> </span>-y<span class="w"> </span>-r<span class="w"> </span><span class="m">1</span>
</span><span id="__span-34-2"><a href="#__codelineno-34-2" id="__codelineno-34-2" name="__codelineno-34-2"></a><span class="go">     0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f</span>
</span><span id="__span-34-3"><a href="#__codelineno-34-3" id="__codelineno-34-3" name="__codelineno-34-3"></a><span class="go">00:          -- -- -- -- -- -- -- -- -- -- -- -- --</span>
</span><span id="__span-34-4"><a href="#__codelineno-34-4" id="__codelineno-34-4" name="__codelineno-34-4"></a><span class="go">10: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --</span>
</span><span id="__span-34-5"><a href="#__codelineno-34-5" id="__codelineno-34-5" name="__codelineno-34-5"></a><span class="go">20: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --</span>
</span><span id="__span-34-6"><a href="#__codelineno-34-6" id="__codelineno-34-6" name="__codelineno-34-6"></a><span class="go">30: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --</span>
</span><span id="__span-34-7"><a href="#__codelineno-34-7" id="__codelineno-34-7" name="__codelineno-34-7"></a><span class="go">40: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --</span>
</span><span id="__span-34-8"><a href="#__codelineno-34-8" id="__codelineno-34-8" name="__codelineno-34-8"></a><span class="go">50: -- -- 52 -- -- -- -- -- -- -- -- -- -- -- -- --</span>
</span><span id="__span-34-9"><a href="#__codelineno-34-9" id="__codelineno-34-9" name="__codelineno-34-9"></a><span class="go">60: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --</span>
</span><span id="__span-34-10"><a href="#__codelineno-34-10" id="__codelineno-34-10" name="__codelineno-34-10"></a><span class="go">70: -- -- -- -- -- -- -- --</span>
</span></code></pre></div>
<p>Later we're going to compile an out-of-tree kernel module to support this device.</p>
<h2 id="plugging-an-audio-usb-headset"><span class="enumerate-headings-plugin enumerate-heading-plugin">19.8</span> Plugging an audio USB headset</h2>
<p>In the next labs, we are going to play audio using a USB audio headset. Let's see whether our kernel supports such hardware by plugging the USB headset.</p>
<p>Before plugging the device, look at the output of <code>lsusb</code>:</p>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-35-1"><a href="#__codelineno-35-1" id="__codelineno-35-1" name="__codelineno-35-1"></a><span class="gp"># </span>lsusb
</span><span id="__span-35-2"><a href="#__codelineno-35-2" id="__codelineno-35-2" name="__codelineno-35-2"></a><span class="go">Bus 001 Device 001: ID 1d6b:0002</span>
</span></code></pre></div>
<p>Now, when you plug the USB headset, a number of messages should appear on the console, and running <code>lsusb</code> again should show an additional device:</p>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-36-1"><a href="#__codelineno-36-1" id="__codelineno-36-1" name="__codelineno-36-1"></a><span class="gp"># </span>lsusb
</span><span id="__span-36-2"><a href="#__codelineno-36-2" id="__codelineno-36-2" name="__codelineno-36-2"></a><span class="go">Bus 001 Device 001: ID 1d6b:0002</span>
</span><span id="__span-36-3"><a href="#__codelineno-36-3" id="__codelineno-36-3" name="__codelineno-36-3"></a><span class="go">Bus 001 Device 002: ID 046d:0a38</span>
</span></code></pre></div>
<p>The device of <em>vendor ID</em> <code>046d</code> and <em>product ID</em> <code>0a38</code> has appeared.
Of course, this depends on the actual USB audio device that you used.</p>
<p>The device also appears in <code>/sys/bus/usb/devices/</code>, in a directory whose name depends on the topology of the USB bus.
When the device is plugged in the kernel messages show:</p>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-37-1"><a href="#__codelineno-37-1" id="__codelineno-37-1" name="__codelineno-37-1"></a><span class="gp"># </span>dmesg
</span><span id="__span-37-2"><a href="#__codelineno-37-2" id="__codelineno-37-2" name="__codelineno-37-2"></a><span class="go">    ...</span>
</span><span id="__span-37-3"><a href="#__codelineno-37-3" id="__codelineno-37-3" name="__codelineno-37-3"></a><span class="go">usb 1-1: new full-speed USB device number 2 using musb-hdrc</span>
</span><span id="__span-37-4"><a href="#__codelineno-37-4" id="__codelineno-37-4" name="__codelineno-37-4"></a><span class="go">usb 1-1: New USB device found, idVendor=046d, idProduct=0a38, bcdDevice= 1.15</span>
</span><span id="__span-37-5"><a href="#__codelineno-37-5" id="__codelineno-37-5" name="__codelineno-37-5"></a><span class="go">usb 1-1: New USB device strings: Mfr=1, Product=2, SerialNumber=0</span>
</span><span id="__span-37-6"><a href="#__codelineno-37-6" id="__codelineno-37-6" name="__codelineno-37-6"></a><span class="go">usb 1-1: Product: Logitech USB Headset H340</span>
</span><span id="__span-37-7"><a href="#__codelineno-37-7" id="__codelineno-37-7" name="__codelineno-37-7"></a><span class="go">usb 1-1: Manufacturer: Logitech Inc.</span>
</span><span id="__span-37-8"><a href="#__codelineno-37-8" id="__codelineno-37-8" name="__codelineno-37-8"></a><span class="go">    ...</span>
</span></code></pre></div>
<p>So if we go in <code>/sys/bus/usb/devices/1-1/</code>, we get the sysfs representation of this USB device:</p>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-38-1"><a href="#__codelineno-38-1" id="__codelineno-38-1" name="__codelineno-38-1"></a><span class="gp"># </span><span class="nb">cd</span><span class="w"> </span>/sys/bus/usb/devices/1-1/
</span><span id="__span-38-2"><a href="#__codelineno-38-2" id="__codelineno-38-2" name="__codelineno-38-2"></a><span class="gp"># </span>cat<span class="w"> </span>idVendor<span class="w"> </span>idProduct<span class="w"> </span>busnum<span class="w"> </span>devnum<span class="w"> </span>product
</span><span id="__span-38-3"><a href="#__codelineno-38-3" id="__codelineno-38-3" name="__codelineno-38-3"></a><span class="go">046d</span>
</span><span id="__span-38-4"><a href="#__codelineno-38-4" id="__codelineno-38-4" name="__codelineno-38-4"></a><span class="go">0a38</span>
</span><span id="__span-38-5"><a href="#__codelineno-38-5" id="__codelineno-38-5" name="__codelineno-38-5"></a><span class="go">1</span>
</span><span id="__span-38-6"><a href="#__codelineno-38-6" id="__codelineno-38-6" name="__codelineno-38-6"></a><span class="go">2</span>
</span><span id="__span-38-7"><a href="#__codelineno-38-7" id="__codelineno-38-7" name="__codelineno-38-7"></a><span class="go">Logitech USB Headset H340</span>
</span></code></pre></div>
<p>However, while the USB device is detected, we currently do not have any driver for this device, so no actual sound card is detected.</p>
<h2 id="in-tree-kernel-modules"><span class="enumerate-headings-plugin enumerate-heading-plugin">19.9</span> In-tree kernel modules</h2>
<p>Go back to the kernel source directory.</p>
<p>The Linux kernel has a generic driver supporting all USB audio devices supporting the standard <em>USB audio class</em>.
This driver can be enabled using the <code>SND_USB_AUDIO</code> configuration option.
Look for this parameter in the kernel configuration, and you should find that it is already enabled as a <em>module</em>.</p>
<p>So, instead of compiling the corresponding driver as a <em>built-in</em>, that's a good opportunity to practice with <em>kernel modules</em>.<br/>
So, compile your modules:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-39-1"><a href="#__codelineno-39-1" id="__codelineno-39-1" name="__codelineno-39-1"></a><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/../kernel/linux/"</span>
</span><span id="__span-39-2"><a href="#__codelineno-39-2" id="__codelineno-39-2" name="__codelineno-39-2"></a><span class="gp">$ </span>make<span class="w"> </span>modules
</span></code></pre></div>
<p>Then, following details given in the lectures, install the modules in our <em>NFS root filesystem</em>
(<code>$HOME/embedded-linux-bbb-labs/tinysystem/nfsroot/</code>).<br/>
Also make sure to update the kernel image (<code>make zImage</code>), and reboot the board.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-40-1"><a href="#__codelineno-40-1" id="__codelineno-40-1" name="__codelineno-40-1"></a><span class="gp">$ </span><span class="nb">export</span><span class="w"> </span><span class="nv">INSTALL_MOD_PATH</span><span class="o">=</span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/../tinysystem/nfsroot"</span>
</span><span id="__span-40-2"><a href="#__codelineno-40-2" id="__codelineno-40-2" name="__codelineno-40-2"></a><span class="gp">$ </span>make
</span><span id="__span-40-3"><a href="#__codelineno-40-3" id="__codelineno-40-3" name="__codelineno-40-3"></a><span class="gp">$ </span>make<span class="w"> </span>modules_install
</span><span id="__span-40-4"><a href="#__codelineno-40-4" id="__codelineno-40-4" name="__codelineno-40-4"></a><span class="go">    ...</span>
</span><span id="__span-40-5"><a href="#__codelineno-40-5" id="__codelineno-40-5" name="__codelineno-40-5"></a><span class="go">  INSTALL /home/me/embedded-linux-bbb-labs/hardware/../tinysystem/nfsroot/lib/modules/5.15.104/kernel/sound/usb/snd-usbmidi-lib.ko</span>
</span><span id="__span-40-6"><a href="#__codelineno-40-6" id="__codelineno-40-6" name="__codelineno-40-6"></a><span class="go">  DEPMOD  /home/me/embedded-linux-bbb-labs/hardware/../tinysystem/nfsroot/lib/modules/5.15.104</span>
</span><span id="__span-40-7"><a href="#__codelineno-40-7" id="__codelineno-40-7" name="__codelineno-40-7"></a><span class="gp">$ </span>cp<span class="w"> </span>arch/arm/boot/zImage<span class="w"> </span>/srv/tftp/zImage
</span></code></pre></div>
<blockquote>
<p>If using <em>git</em> for the Linux kernel source tree, due to the changes we have made to the kernel source code, the kernel version is now <code>5.15.&lt;x&gt;-dirty</code>, the <code>dirty</code> keyword indicating that the <em>git</em> working tree has uncommitted changes.<br/>
The modules are therefore installed in <code>/lib/modules/5.15.&lt;x&gt;-dirty/</code>, and the version of the running Linux kernel must match this.</p>
</blockquote>
<p>After rebooting, try to load the module that we need (<code>snd-usb-audio</code>).<br/>
By running <code>lsmod</code>, see all the module dependencies that were loaded too..<br/>
You can also see that a new USB device driver in <code>/sys/bus/usb/drivers/snd-usb-audio</code>. This directory shows which USB devices are bound to this driver.</p>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-41-1"><a href="#__codelineno-41-1" id="__codelineno-41-1" name="__codelineno-41-1"></a><span class="gp"># </span>uname<span class="w"> </span>-r
</span><span id="__span-41-2"><a href="#__codelineno-41-2" id="__codelineno-41-2" name="__codelineno-41-2"></a><span class="go">5.15.104-dirty</span>
</span><span id="__span-41-3"><a href="#__codelineno-41-3" id="__codelineno-41-3" name="__codelineno-41-3"></a><span class="gp"># </span>modprobe<span class="w"> </span>snd-usb-audio
</span><span id="__span-41-4"><a href="#__codelineno-41-4" id="__codelineno-41-4" name="__codelineno-41-4"></a><span class="go">mc: Linux media interface: v0.10</span>
</span><span id="__span-41-5"><a href="#__codelineno-41-5" id="__codelineno-41-5" name="__codelineno-41-5"></a><span class="hll"><span class="go">usbcore: registered new interface driver snd-usb-audio</span>
</span></span><span id="__span-41-6"><a href="#__codelineno-41-6" id="__codelineno-41-6" name="__codelineno-41-6"></a><span class="gp"># </span>lsmod
</span><span id="__span-41-7"><a href="#__codelineno-41-7" id="__codelineno-41-7" name="__codelineno-41-7"></a><span class="go">Module                  Size  Used by</span>
</span><span id="__span-41-8"><a href="#__codelineno-41-8" id="__codelineno-41-8" name="__codelineno-41-8"></a><span class="hll"><span class="go">snd_usb_audio         217088  0</span>
</span></span><span id="__span-41-9"><a href="#__codelineno-41-9" id="__codelineno-41-9" name="__codelineno-41-9"></a><span class="go">snd_hwdep              16384  1 snd_usb_audio</span>
</span><span id="__span-41-10"><a href="#__codelineno-41-10" id="__codelineno-41-10" name="__codelineno-41-10"></a><span class="go">snd_usbmidi_lib        28672  1 snd_usb_audio</span>
</span><span id="__span-41-11"><a href="#__codelineno-41-11" id="__codelineno-41-11" name="__codelineno-41-11"></a><span class="go">mc                     36864  1 snd_usb_audio</span>
</span><span id="__span-41-12"><a href="#__codelineno-41-12" id="__codelineno-41-12" name="__codelineno-41-12"></a><span class="go">snd_rawmidi            28672  1 snd_usbmidi_lib</span>
</span><span id="__span-41-13"><a href="#__codelineno-41-13" id="__codelineno-41-13" name="__codelineno-41-13"></a><span class="go">snd_pcm               106496  1 snd_usb_audio</span>
</span><span id="__span-41-14"><a href="#__codelineno-41-14" id="__codelineno-41-14" name="__codelineno-41-14"></a><span class="go">snd_timer              28672  1 snd_pcm</span>
</span><span id="__span-41-15"><a href="#__codelineno-41-15" id="__codelineno-41-15" name="__codelineno-41-15"></a><span class="go">snd                    61440  6 snd_usb_audio,snd_hwdep,snd_usbmidi_lib,snd_rawmidi,snd_pcm,snd_timer</span>
</span><span id="__span-41-16"><a href="#__codelineno-41-16" id="__codelineno-41-16" name="__codelineno-41-16"></a><span class="go">soundcore              16384  1 snd</span>
</span></code></pre></div>
<p>You can check that <code>/proc/asound/</code> now exists (thanks to loading modules for <em>ALSA</em>, the Linux sound subsystem), and that one sound card is available:</p>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-42-1"><a href="#__codelineno-42-1" id="__codelineno-42-1" name="__codelineno-42-1"></a><span class="gp"># </span>ls<span class="w"> </span>-1<span class="w"> </span>/proc/asound/
</span><span id="__span-42-2"><a href="#__codelineno-42-2" id="__codelineno-42-2" name="__codelineno-42-2"></a><span class="hll"><span class="go">H340</span>
</span></span><span id="__span-42-3"><a href="#__codelineno-42-3" id="__codelineno-42-3" name="__codelineno-42-3"></a><span class="hll"><span class="go">card0</span>
</span></span><span id="__span-42-4"><a href="#__codelineno-42-4" id="__codelineno-42-4" name="__codelineno-42-4"></a><span class="go">cards</span>
</span><span id="__span-42-5"><a href="#__codelineno-42-5" id="__codelineno-42-5" name="__codelineno-42-5"></a><span class="go">devices</span>
</span><span id="__span-42-6"><a href="#__codelineno-42-6" id="__codelineno-42-6" name="__codelineno-42-6"></a><span class="go">hwdep</span>
</span><span id="__span-42-7"><a href="#__codelineno-42-7" id="__codelineno-42-7" name="__codelineno-42-7"></a><span class="go">modules</span>
</span><span id="__span-42-8"><a href="#__codelineno-42-8" id="__codelineno-42-8" name="__codelineno-42-8"></a><span class="go">oss</span>
</span><span id="__span-42-9"><a href="#__codelineno-42-9" id="__codelineno-42-9" name="__codelineno-42-9"></a><span class="go">pcm</span>
</span><span id="__span-42-10"><a href="#__codelineno-42-10" id="__codelineno-42-10" name="__codelineno-42-10"></a><span class="go">timers</span>
</span><span id="__span-42-11"><a href="#__codelineno-42-11" id="__codelineno-42-11" name="__codelineno-42-11"></a><span class="go">version</span>
</span><span id="__span-42-12"><a href="#__codelineno-42-12" id="__codelineno-42-12" name="__codelineno-42-12"></a><span class="gp"># </span>cat<span class="w"> </span>/proc/asound/cards
</span><span id="__span-42-13"><a href="#__codelineno-42-13" id="__codelineno-42-13" name="__codelineno-42-13"></a><span class="go"> 0 [H340           ]: USB-Audio - Logitech USB Headset H340</span>
</span><span id="__span-42-14"><a href="#__codelineno-42-14" id="__codelineno-42-14" name="__codelineno-42-14"></a><span class="go">                      Logitech Inc. Logitech USB Headset H340 at usb-musb-hdrc.1-1, full speed</span>
</span></code></pre></div>
<p>Check also the <code>/dev/snd/</code> directory, which should now contain some character device files.
These will be used by the user-space libraries and applications to access the audio devices.</p>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-43-1"><a href="#__codelineno-43-1" id="__codelineno-43-1" name="__codelineno-43-1"></a><span class="gp"># </span>ls<span class="w"> </span>/dev/snd/
</span><span id="__span-43-2"><a href="#__codelineno-43-2" id="__codelineno-43-2" name="__codelineno-43-2"></a><span class="go">controlC0  pcmC0D0c   pcmC0D0p   timer</span>
</span></code></pre></div>
<p>Modify your startup scripts so that the <code>snd-usb-audio</code> module is always loaded at startup.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-44-1"><a href="#__codelineno-44-1" id="__codelineno-44-1" name="__codelineno-44-1"></a><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/../tinysystem/nfsroot/"</span>
</span><span id="__span-44-2"><a href="#__codelineno-44-2" id="__codelineno-44-2" name="__codelineno-44-2"></a><span class="gp">$ </span>cat<span class="w"> </span>&gt;<span class="w"> </span>etc/init.d/rcS<span class="w"> </span>&lt;&lt;<span class="s1">'EOF'</span>
</span><span id="__span-44-3"><a href="#__codelineno-44-3" id="__codelineno-44-3" name="__codelineno-44-3"></a><span class="gp">#</span>!/bin/sh
</span><span id="__span-44-4"><a href="#__codelineno-44-4" id="__codelineno-44-4" name="__codelineno-44-4"></a><span class="go">mount -t proc proc /proc</span>
</span><span id="__span-44-5"><a href="#__codelineno-44-5" id="__codelineno-44-5" name="__codelineno-44-5"></a><span class="go">mount -t sysfs sys /sys</span>
</span><span id="__span-44-6"><a href="#__codelineno-44-6" id="__codelineno-44-6" name="__codelineno-44-6"></a><span class="go">mount -t devtmpfs dev /dev</span>
</span><span id="__span-44-7"><a href="#__codelineno-44-7" id="__codelineno-44-7" name="__codelineno-44-7"></a><span class="hll"><span class="go">/usr/sbin/httpd -h /www/</span>
</span></span><span id="__span-44-8"><a href="#__codelineno-44-8" id="__codelineno-44-8" name="__codelineno-44-8"></a><span class="go">modprobe snd-usb-audio</span>
</span><span id="__span-44-9"><a href="#__codelineno-44-9" id="__codelineno-44-9" name="__codelineno-44-9"></a><span class="go">EOF</span>
</span></code></pre></div>
<p>We cannot test the sound card yet, as we will need to build some software first. Be patient, this is coming soon!</p>
<h2 id="out-of-tree-kernel-modules"><span class="enumerate-headings-plugin enumerate-heading-plugin">19.10</span> Out-of-tree kernel modules</h2>
<p>The next device we want to support is the I2C <em>Nintendo Nunchuk</em>.
There is a driver in the kernel to support it when connected to a <em>Wiimote</em> controller, but there is no such driver to support it as an I2C device.</p>
<p>Fortunately, one is provided in <code>$HOME/embedded-linux-bbb-labs/hardware/data/nunchuk/nunchuk.c</code>.
You can check <a href="https://bootlin.com/training/kernel/"><em>Bootlin</em>'s Linux kernel and driver development course</a> to learn how to implement all sorts of device drivers for Linux.</p>
<p>Go to this directory, and compile the out-of-tree module as follows:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-45-1"><a href="#__codelineno-45-1" id="__codelineno-45-1" name="__codelineno-45-1"></a><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/data/nunchuk/"</span>
</span><span id="__span-45-2"><a href="#__codelineno-45-2" id="__codelineno-45-2" name="__codelineno-45-2"></a><span class="gp">$ </span>make<span class="w"> </span>-C<span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/../kernel/linux"</span><span class="w"> </span><span class="nv">M</span><span class="o">=</span><span class="nv">$PWD</span>
</span><span id="__span-45-3"><a href="#__codelineno-45-3" id="__codelineno-45-3" name="__codelineno-45-3"></a><span class="go">make: Entering directory '/home/me/embedded-linux-bbb-labs/kernel/linux'</span>
</span><span id="__span-45-4"><a href="#__codelineno-45-4" id="__codelineno-45-4" name="__codelineno-45-4"></a><span class="go">  CC [M]  /home/me/embedded-linux-bbb-labs/hardware/data/nunchuk/nunchuk.o</span>
</span><span id="__span-45-5"><a href="#__codelineno-45-5" id="__codelineno-45-5" name="__codelineno-45-5"></a><span class="go">  MODPOST /home/me/embedded-linux-bbb-labs/hardware/data/nunchuk/Module.symvers</span>
</span><span id="__span-45-6"><a href="#__codelineno-45-6" id="__codelineno-45-6" name="__codelineno-45-6"></a><span class="go">  CC [M]  /home/me/embedded-linux-bbb-labs/hardware/data/nunchuk/nunchuk.mod.o</span>
</span><span id="__span-45-7"><a href="#__codelineno-45-7" id="__codelineno-45-7" name="__codelineno-45-7"></a><span class="go">  LD [M]  /home/me/embedded-linux-bbb-labs/hardware/data/nunchuk/nunchuk.ko</span>
</span><span id="__span-45-8"><a href="#__codelineno-45-8" id="__codelineno-45-8" name="__codelineno-45-8"></a><span class="go">make: Leaving directory '/home/me/embedded-linux-bbb-labs/kernel/linux'</span>
</span></code></pre></div>
<p>Here are a few explanations:</p>
<ul>
<li>
<p>The <code>-C</code> option lets make know which <code>Makefile</code> to use, here the toplevel <code>Makefile</code> in the kernel sources.</p>
</li>
<li>
<p><code>M=$PWD</code> tells the kernel <code>Makefile</code> to build external modules from the files in the current directory.</p>
</li>
</ul>
<p>Now, you can install the compiled module in the NFS <em>root</em> filesystem by passing the <code>modules_install</code> target and specifying the target directory through the <code>INSTALL_MOD_PATH</code> variable.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-46-1"><a href="#__codelineno-46-1" id="__codelineno-46-1" name="__codelineno-46-1"></a><span class="gp">$ </span>make<span class="w"> </span>-C<span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/../kernel/linux"</span><span class="w"> </span><span class="nv">M</span><span class="o">=</span><span class="nv">$PWD</span><span class="w"> </span>modules_install
</span><span id="__span-46-2"><a href="#__codelineno-46-2" id="__codelineno-46-2" name="__codelineno-46-2"></a><span class="go">make: Entering directory '/home/me/embedded-linux-bbb-labs/kernel/linux'</span>
</span><span id="__span-46-3"><a href="#__codelineno-46-3" id="__codelineno-46-3" name="__codelineno-46-3"></a><span class="go">  INSTALL /home/me/embedded-linux-bbb-labs/hardware/../tinysystem/nfsroot/lib/modules/5.15.104/extra/nunchuk.ko</span>
</span><span id="__span-46-4"><a href="#__codelineno-46-4" id="__codelineno-46-4" name="__codelineno-46-4"></a><span class="go">  DEPMOD  /home/me/embedded-linux-bbb-labs/hardware/../tinysystem/nfsroot/lib/modules/5.15.104</span>
</span><span id="__span-46-5"><a href="#__codelineno-46-5" id="__codelineno-46-5" name="__codelineno-46-5"></a><span class="go">make: Leaving directory '/home/me/embedded-linux-bbb-labs/kernel/linux'</span>
</span></code></pre></div>
<p>You can see that this installs out-of-tree kernel modules under <code>lib/modules/&lt;version&gt;/extra/</code>.</p>
<p>Back on the target, you can now check that your custom module can be loaded:</p>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-47-1"><a href="#__codelineno-47-1" id="__codelineno-47-1" name="__codelineno-47-1"></a><span class="gp"># </span>modprobe<span class="w"> </span>nunchuk
</span><span id="__span-47-2"><a href="#__codelineno-47-2" id="__codelineno-47-2" name="__codelineno-47-2"></a><span class="go">nunchuk: loading out-of-tree module taints kernel.</span>
</span></code></pre></div>
<p>See <code>kbuild/modules</code> in kernel documentation for details about building out-of-tree kernel modules.</p>
<p>However, run <code>i2cdetect -r 1</code> again. You will see that the <em>Nunchuk</em> is still detected, but still not driven by the kernel. Otherwise, it would be signaled by the <code>UU</code> placeholder.</p>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-48-1"><a href="#__codelineno-48-1" id="__codelineno-48-1" name="__codelineno-48-1"></a><span class="gp"># </span>i2cdetect<span class="w"> </span>-y<span class="w"> </span>-r<span class="w"> </span><span class="m">1</span>
</span><span id="__span-48-2"><a href="#__codelineno-48-2" id="__codelineno-48-2" name="__codelineno-48-2"></a><span class="go">     0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f</span>
</span><span id="__span-48-3"><a href="#__codelineno-48-3" id="__codelineno-48-3" name="__codelineno-48-3"></a><span class="go">00:          -- -- -- -- -- -- -- -- -- -- -- -- --</span>
</span><span id="__span-48-4"><a href="#__codelineno-48-4" id="__codelineno-48-4" name="__codelineno-48-4"></a><span class="go">10: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --</span>
</span><span id="__span-48-5"><a href="#__codelineno-48-5" id="__codelineno-48-5" name="__codelineno-48-5"></a><span class="go">20: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --</span>
</span><span id="__span-48-6"><a href="#__codelineno-48-6" id="__codelineno-48-6" name="__codelineno-48-6"></a><span class="go">30: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --</span>
</span><span id="__span-48-7"><a href="#__codelineno-48-7" id="__codelineno-48-7" name="__codelineno-48-7"></a><span class="go">40: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --</span>
</span><span id="__span-48-8"><a href="#__codelineno-48-8" id="__codelineno-48-8" name="__codelineno-48-8"></a><span class="go">50: -- -- 52 -- -- -- -- -- -- -- -- -- -- -- -- --</span>
</span><span id="__span-48-9"><a href="#__codelineno-48-9" id="__codelineno-48-9" name="__codelineno-48-9"></a><span class="go">60: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --</span>
</span><span id="__span-48-10"><a href="#__codelineno-48-10" id="__codelineno-48-10" name="__codelineno-48-10"></a><span class="go">70: -- -- -- -- -- -- -- --</span>
</span></code></pre></div>
<p>You may also look at the <code>nunchuk.c</code> file and notice a <em>Nunchuk</em> device probed successfully message that you didn't see when loading the module.</p>
<p>That's because the Linux kernel doesn't know about the <em>Nunchuk</em> device yet, even though the driver for this kind of devices is already loaded. Our device also has to be described in the <em>Device Tree</em>.</p>
<p>You can confirm this by having a look at the contents of the <code>/sys/bus/i2c/</code> directory.
It contains two subdirectories: <code>devices</code> and <code>drivers</code>.<br/>
In <code>drivers</code>, there should be a <code>nunchuk</code> subdirectory, but no <em>symbolic link</em> to a device yet.<br/>
In <code>devices</code> you should see some devices, but not the <em>Nunchuk</em> one yet.</p>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-49-1"><a href="#__codelineno-49-1" id="__codelineno-49-1" name="__codelineno-49-1"></a><span class="gp"># </span>ls<span class="w"> </span>-1<span class="w"> </span>/sys/bus/i2c/
</span><span id="__span-49-2"><a href="#__codelineno-49-2" id="__codelineno-49-2" name="__codelineno-49-2"></a><span class="hll"><span class="go">devices</span>
</span></span><span id="__span-49-3"><a href="#__codelineno-49-3" id="__codelineno-49-3" name="__codelineno-49-3"></a><span class="hll"><span class="go">drivers</span>
</span></span><span id="__span-49-4"><a href="#__codelineno-49-4" id="__codelineno-49-4" name="__codelineno-49-4"></a><span class="go">drivers_autoprobe</span>
</span><span id="__span-49-5"><a href="#__codelineno-49-5" id="__codelineno-49-5" name="__codelineno-49-5"></a><span class="go">drivers_probe</span>
</span><span id="__span-49-6"><a href="#__codelineno-49-6" id="__codelineno-49-6" name="__codelineno-49-6"></a><span class="go">uevent</span>
</span><span id="__span-49-7"><a href="#__codelineno-49-7" id="__codelineno-49-7" name="__codelineno-49-7"></a><span class="gp"># </span>ls<span class="w"> </span>-1<span class="w"> </span>/sys/bus/i2c/drivers/
</span><span id="__span-49-8"><a href="#__codelineno-49-8" id="__codelineno-49-8" name="__codelineno-49-8"></a><span class="go">dummy</span>
</span><span id="__span-49-9"><a href="#__codelineno-49-9" id="__codelineno-49-9" name="__codelineno-49-9"></a><span class="go">lp872x</span>
</span><span id="__span-49-10"><a href="#__codelineno-49-10" id="__codelineno-49-10" name="__codelineno-49-10"></a><span class="go">lp873x</span>
</span><span id="__span-49-11"><a href="#__codelineno-49-11" id="__codelineno-49-11" name="__codelineno-49-11"></a><span class="go">lp87565</span>
</span><span id="__span-49-12"><a href="#__codelineno-49-12" id="__codelineno-49-12" name="__codelineno-49-12"></a><span class="go">menelaus</span>
</span><span id="__span-49-13"><a href="#__codelineno-49-13" id="__codelineno-49-13" name="__codelineno-49-13"></a><span class="hll"><span class="go">nunchuk</span>
</span></span><span id="__span-49-14"><a href="#__codelineno-49-14" id="__codelineno-49-14" name="__codelineno-49-14"></a><span class="go">palmas</span>
</span><span id="__span-49-15"><a href="#__codelineno-49-15" id="__codelineno-49-15" name="__codelineno-49-15"></a><span class="go">pcf857x</span>
</span><span id="__span-49-16"><a href="#__codelineno-49-16" id="__codelineno-49-16" name="__codelineno-49-16"></a><span class="go">tps65023</span>
</span><span id="__span-49-17"><a href="#__codelineno-49-17" id="__codelineno-49-17" name="__codelineno-49-17"></a><span class="go">tps65217</span>
</span><span id="__span-49-18"><a href="#__codelineno-49-18" id="__codelineno-49-18" name="__codelineno-49-18"></a><span class="go">tps65218</span>
</span><span id="__span-49-19"><a href="#__codelineno-49-19" id="__codelineno-49-19" name="__codelineno-49-19"></a><span class="go">tps65910</span>
</span><span id="__span-49-20"><a href="#__codelineno-49-20" id="__codelineno-49-20" name="__codelineno-49-20"></a><span class="go">twl</span>
</span><span id="__span-49-21"><a href="#__codelineno-49-21" id="__codelineno-49-21" name="__codelineno-49-21"></a><span class="go">twl6040</span>
</span><span id="__span-49-22"><a href="#__codelineno-49-22" id="__codelineno-49-22" name="__codelineno-49-22"></a><span class="gp"># </span>ls<span class="w"> </span>-1<span class="w"> </span>/sys/bus/i2c/devices/
</span><span id="__span-49-23"><a href="#__codelineno-49-23" id="__codelineno-49-23" name="__codelineno-49-23"></a><span class="go">0-0024</span>
</span><span id="__span-49-24"><a href="#__codelineno-49-24" id="__codelineno-49-24" name="__codelineno-49-24"></a><span class="go">0-0050</span>
</span><span id="__span-49-25"><a href="#__codelineno-49-25" id="__codelineno-49-25" name="__codelineno-49-25"></a><span class="go">0-0070</span>
</span><span id="__span-49-26"><a href="#__codelineno-49-26" id="__codelineno-49-26" name="__codelineno-49-26"></a><span class="go">2-0054</span>
</span><span id="__span-49-27"><a href="#__codelineno-49-27" id="__codelineno-49-27" name="__codelineno-49-27"></a><span class="go">2-0055</span>
</span><span id="__span-49-28"><a href="#__codelineno-49-28" id="__codelineno-49-28" name="__codelineno-49-28"></a><span class="go">2-0056</span>
</span><span id="__span-49-29"><a href="#__codelineno-49-29" id="__codelineno-49-29" name="__codelineno-49-29"></a><span class="go">2-0057</span>
</span><span id="__span-49-30"><a href="#__codelineno-49-30" id="__codelineno-49-30" name="__codelineno-49-30"></a><span class="go">i2c-0</span>
</span><span id="__span-49-31"><a href="#__codelineno-49-31" id="__codelineno-49-31" name="__codelineno-49-31"></a><span class="go">i2c-1</span>
</span><span id="__span-49-32"><a href="#__codelineno-49-32" id="__codelineno-49-32" name="__codelineno-49-32"></a><span class="go">i2c-2</span>
</span></code></pre></div>
<h2 id="declaring-i2c-device"><span class="enumerate-headings-plugin enumerate-heading-plugin">19.11</span> Declaring I2C device</h2>
<p>To allow the kernel to manage our <em>Nunchuk</em> device, let's declare the device in the custom <em>Device Tree</em> for our board. The declaration of the <em>I2C1</em> bus will then look as follows:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-50-1"><a href="#__codelineno-50-1" id="__codelineno-50-1" name="__codelineno-50-1"></a><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/../kernel/linux/"</span>
</span><span id="__span-50-2"><a href="#__codelineno-50-2" id="__codelineno-50-2" name="__codelineno-50-2"></a><span class="gp">$ </span>nano<span class="w"> </span>arch/arm/boot/dts/am335x-boneblack-custom.dts
</span></code></pre></div>
<div class="language-c highlight"><span class="filename">arch/arm/boot/dts/am335x-boneblack-custom.dts - modified i2c1</span><pre><span></span><code><span id="__span-51-1"><a href="#__codelineno-51-1" id="__codelineno-51-1" name="__codelineno-51-1"></a><span class="o">&amp;</span><span class="n">i2c1</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-51-2"><a href="#__codelineno-51-2" id="__codelineno-51-2" name="__codelineno-51-2"></a><span class="w">        </span><span class="n">pinctrl</span><span class="o">-</span><span class="n">names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"default"</span><span class="p">;</span>
</span><span id="__span-51-3"><a href="#__codelineno-51-3" id="__codelineno-51-3" name="__codelineno-51-3"></a><span class="w">        </span><span class="n">pinctrl</span><span class="mi">-0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="n">i2c1_pins</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-51-4"><a href="#__codelineno-51-4" id="__codelineno-51-4" name="__codelineno-51-4"></a><span class="w">        </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"okay"</span><span class="p">;</span>
</span><span id="__span-51-5"><a href="#__codelineno-51-5" id="__codelineno-51-5" name="__codelineno-51-5"></a><span class="w">        </span><span class="n">clock</span><span class="o">-</span><span class="n">frequency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">50000</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-51-6"><a href="#__codelineno-51-6" id="__codelineno-51-6" name="__codelineno-51-6"></a>
</span><span id="__span-51-7"><a href="#__codelineno-51-7" id="__codelineno-51-7" name="__codelineno-51-7"></a><span class="w">        </span><span class="nl">nunchuk</span><span class="p">:</span><span class="w"> </span><span class="n">joystick</span><span class="err">@</span><span class="mi">52</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-51-8"><a href="#__codelineno-51-8" id="__codelineno-51-8" name="__codelineno-51-8"></a><span class="w">                </span><span class="n">compatible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"nintendo,nunchuk"</span><span class="p">;</span>
</span><span id="__span-51-9"><a href="#__codelineno-51-9" id="__codelineno-51-9" name="__codelineno-51-9"></a><span class="w">                </span><span class="n">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x52</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-51-10"><a href="#__codelineno-51-10" id="__codelineno-51-10" name="__codelineno-51-10"></a><span class="w">        </span><span class="p">};</span>
</span><span id="__span-51-11"><a href="#__codelineno-51-11" id="__codelineno-51-11" name="__codelineno-51-11"></a><span class="p">};</span>
</span></code></pre></div>
<p>Here are a few notes:</p>
<ul>
<li>
<p>The <code>clock-frequency</code> property is used to configure the bus to operate at 50 KHz.<br/>
  Although the <em>Nunchuk</em> operates at 100 kHz, our prototyping wiring might degrade the signal, so we prefer to operate with a lower clock frequency.</p>
</li>
<li>
<p>The <em>Nunchuk</em> device is added through a child node in the I2C controller node.</p>
</li>
<li>
<p>For the kernel to probe and drive our device, it's required that the <code>compatible</code> string matches one of the compatible strings supported by the driver.</p>
</li>
<li>
<p>The <code>reg</code> property is the address of the device on the I2C bus. If it doesn't match, the driver will probe the device but won't be able to communicate with it.</p>
</li>
</ul>
<p>Recompile your <em>Device Tree</em> and reboot your kernel with the new binary.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-52-1"><a href="#__codelineno-52-1" id="__codelineno-52-1" name="__codelineno-52-1"></a><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/../kernel/linux/"</span>
</span><span id="__span-52-2"><a href="#__codelineno-52-2" id="__codelineno-52-2" name="__codelineno-52-2"></a><span class="gp">$ </span>make<span class="w"> </span>dtbs
</span><span id="__span-52-3"><a href="#__codelineno-52-3" id="__codelineno-52-3" name="__codelineno-52-3"></a><span class="go">  DTC     arch/arm/boot/dts/am335x-boneblack-custom.dtb</span>
</span><span id="__span-52-4"><a href="#__codelineno-52-4" id="__codelineno-52-4" name="__codelineno-52-4"></a><span class="gp">$ </span>cp<span class="w"> </span>arch/arm/boot/dts/am335x-boneblack-custom.dtb<span class="w"> </span>/srv/tftp/
</span></code></pre></div>
<p>You can now load your module again, and this time, you should see that the <code>nunchuk</code> driver probed the <em>Nunchuk</em> device:</p>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-53-1"><a href="#__codelineno-53-1" id="__codelineno-53-1" name="__codelineno-53-1"></a><span class="gp"># </span>modprobe<span class="w"> </span>-r<span class="w"> </span>nunchuk
</span><span id="__span-53-2"><a href="#__codelineno-53-2" id="__codelineno-53-2" name="__codelineno-53-2"></a><span class="gp"># </span>modprobe<span class="w"> </span>nunchuk
</span><span id="__span-53-3"><a href="#__codelineno-53-3" id="__codelineno-53-3" name="__codelineno-53-3"></a><span class="go">nunchuk: loading out-of-tree module taints kernel.</span>
</span><span id="__span-53-4"><a href="#__codelineno-53-4" id="__codelineno-53-4" name="__codelineno-53-4"></a><span class="go">input: Wii Nunchuk as /devices/platform/ocp/48000000.interconnect/48000000.interconnect:segment@0/4802a000.target-module/4802a000.i2c/i2c-1/1-0052/input/input0</span>
</span><span id="__span-53-5"><a href="#__codelineno-53-5" id="__codelineno-53-5" name="__codelineno-53-5"></a><span class="go">Nunchuk device probed successfully</span>
</span></code></pre></div>
<p>List the contents of <code>/sys/bus/i2c/drivers/nunchuk</code> once again. You should now see a <em>symbolic link</em> corresponding to our new device.</p>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-54-1"><a href="#__codelineno-54-1" id="__codelineno-54-1" name="__codelineno-54-1"></a><span class="gp"># </span>ls<span class="w"> </span>-l<span class="w"> </span>/sys/bus/i2c/drivers/nunchuk/
</span><span id="__span-54-2"><a href="#__codelineno-54-2" id="__codelineno-54-2" name="__codelineno-54-2"></a><span class="go">--w-------    1      4096 Jan  1 00:17 bind</span>
</span><span id="__span-54-3"><a href="#__codelineno-54-3" id="__codelineno-54-3" name="__codelineno-54-3"></a><span class="hll"><span class="go">lrwxrwxrwx    1         0 Jan  1 00:17 module -&gt; ../../../../module/nunchuk</span>
</span></span><span id="__span-54-4"><a href="#__codelineno-54-4" id="__codelineno-54-4" name="__codelineno-54-4"></a><span class="go">--w-------    1      4096 Jan  1 00:17 uevent</span>
</span><span id="__span-54-5"><a href="#__codelineno-54-5" id="__codelineno-54-5" name="__codelineno-54-5"></a><span class="go">--w-------    1      4096 Jan  1 00:17 unbind</span>
</span></code></pre></div>
<p>Also list <code>/sys/bus/i2c/devices/</code> again. You should now see the <em>Nunchuk</em> device, which can be recognized through its <code>0052</code> address.
Follow the <em>symbolic link</em> and you should see a <em>symbolic link</em> back to the <em>Nunchuk</em> driver!</p>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-55-1"><a href="#__codelineno-55-1" id="__codelineno-55-1" name="__codelineno-55-1"></a><span class="gp"># </span>ls<span class="w"> </span>-l<span class="w"> </span>/sys/bus/i2c/devices/
</span><span id="__span-55-2"><a href="#__codelineno-55-2" id="__codelineno-55-2" name="__codelineno-55-2"></a><span class="go">lrwxrwxrwx    1         0 Jan  1 00:14 0-0024 -&gt; ../../../devices/platform/ocp/44c00000.interconnect/44c00000.interconnect:segment@200000/44e0b000.target-module/44e0b000.i2c/i2c-0/0-0024</span>
</span><span id="__span-55-3"><a href="#__codelineno-55-3" id="__codelineno-55-3" name="__codelineno-55-3"></a><span class="go">lrwxrwxrwx    1         0 Jan  1 00:14 0-0050 -&gt; ../../../devices/platform/ocp/44c00000.interconnect/44c00000.interconnect:segment@200000/44e0b000.target-module/44e0b000.i2c/i2c-0/0-0050</span>
</span><span id="__span-55-4"><a href="#__codelineno-55-4" id="__codelineno-55-4" name="__codelineno-55-4"></a><span class="go">lrwxrwxrwx    1         0 Jan  1 00:14 0-0070 -&gt; ../../../devices/platform/ocp/44c00000.interconnect/44c00000.interconnect:segment@200000/44e0b000.target-module/44e0b000.i2c/i2c-0/0-0070</span>
</span><span id="__span-55-5"><a href="#__codelineno-55-5" id="__codelineno-55-5" name="__codelineno-55-5"></a><span class="hll"><span class="go">lrwxrwxrwx    1         0 Jan  1 00:14 1-0052 -&gt; ../../../devices/platform/ocp/48000000.interconnect/48000000.interconnect:segment@0/4802a000.target-module/4802a000.i2c/i2c-1/1-0052</span>
</span></span><span id="__span-55-6"><a href="#__codelineno-55-6" id="__codelineno-55-6" name="__codelineno-55-6"></a><span class="go">lrwxrwxrwx    1         0 Jan  1 00:14 2-0054 -&gt; ../../../devices/platform/ocp/48000000.interconnect/48000000.interconnect:segment@100000/4819c000.target-module/4819c000.i2c/i2c-2/2-0054</span>
</span><span id="__span-55-7"><a href="#__codelineno-55-7" id="__codelineno-55-7" name="__codelineno-55-7"></a><span class="go">lrwxrwxrwx    1         0 Jan  1 00:14 2-0055 -&gt; ../../../devices/platform/ocp/48000000.interconnect/48000000.interconnect:segment@100000/4819c000.target-module/4819c000.i2c/i2c-2/2-0055</span>
</span><span id="__span-55-8"><a href="#__codelineno-55-8" id="__codelineno-55-8" name="__codelineno-55-8"></a><span class="go">lrwxrwxrwx    1         0 Jan  1 00:14 2-0056 -&gt; ../../../devices/platform/ocp/48000000.interconnect/48000000.interconnect:segment@100000/4819c000.target-module/4819c000.i2c/i2c-2/2-0056</span>
</span><span id="__span-55-9"><a href="#__codelineno-55-9" id="__codelineno-55-9" name="__codelineno-55-9"></a><span class="go">lrwxrwxrwx    1         0 Jan  1 00:14 2-0057 -&gt; ../../../devices/platform/ocp/48000000.interconnect/48000000.interconnect:segment@100000/4819c000.target-module/4819c000.i2c/i2c-2/2-0057</span>
</span><span id="__span-55-10"><a href="#__codelineno-55-10" id="__codelineno-55-10" name="__codelineno-55-10"></a><span class="go">lrwxrwxrwx    1         0 Jan  1 00:14 i2c-0 -&gt; ../../../devices/platform/ocp/44c00000.interconnect/44c00000.interconnect:segment@200000/44e0b000.target-module/44e0b000.i2c/i2c-0</span>
</span><span id="__span-55-11"><a href="#__codelineno-55-11" id="__codelineno-55-11" name="__codelineno-55-11"></a><span class="go">lrwxrwxrwx    1         0 Jan  1 00:00 i2c-1 -&gt; ../../../devices/platform/ocp/48000000.interconnect/48000000.interconnect:segment@0/4802a000.target-module/4802a000.i2c/i2c-1</span>
</span><span id="__span-55-12"><a href="#__codelineno-55-12" id="__codelineno-55-12" name="__codelineno-55-12"></a><span class="go">lrwxrwxrwx    1         0 Jan  1 00:14 i2c-2 -&gt; ../../../devices/platform/ocp/48000000.interconnect/48000000.interconnect:segment@100000/4819c000.target-module/4819c000.i2c/i2c-2</span>
</span></code></pre></div>
<p>We are not ready to use this input device yet, but at least we can test that we get bytes when buttons or the joypad are used.
In the below command, use the same number as in the message you got in the console (<code>event0</code> for <code>input0</code> for example):</p>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox - Nunchuk Z pressed then released</span><pre><span></span><code><span id="__span-56-1"><a href="#__codelineno-56-1" id="__codelineno-56-1" name="__codelineno-56-1"></a><span class="gp"># </span>od<span class="w"> </span>-x<span class="w"> </span>/dev/input/event0
</span><span id="__span-56-2"><a href="#__codelineno-56-2" id="__codelineno-56-2" name="__codelineno-56-2"></a><span class="go">0000000     02dd    0000    913f    0008    0001    0135    0001    0000</span>
</span><span id="__span-56-3"><a href="#__codelineno-56-3" id="__codelineno-56-3" name="__codelineno-56-3"></a><span class="go">0000020     02dd    0000    913f    0008    0000    0000    0000    0000</span>
</span><span id="__span-56-4"><a href="#__codelineno-56-4" id="__codelineno-56-4" name="__codelineno-56-4"></a><span class="go">0000040     02dd    0000    17bb    000a    0001    0135    0000    0000</span>
</span><span id="__span-56-5"><a href="#__codelineno-56-5" id="__codelineno-56-5" name="__codelineno-56-5"></a><span class="go">0000060     02dd    0000    17bb    000a    0000    0000    0000    0000</span>
</span></code></pre></div>
<p>We will use the <em>Nunchuk</em> to control audio playback in an upcoming lab.</p>
<h2 id="setting-board-model-name"><span class="enumerate-headings-plugin enumerate-heading-plugin">19.12</span> Setting board model name</h2>
<p>Modify the custom <em>Device Tree</em> file one last time to override the model name for your system.
Set the <code>model</code> property to <code>BeagleBone Black media player</code>.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-57-1"><a href="#__codelineno-57-1" id="__codelineno-57-1" name="__codelineno-57-1"></a><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/../kernel/linux/"</span>
</span><span id="__span-57-2"><a href="#__codelineno-57-2" id="__codelineno-57-2" name="__codelineno-57-2"></a><span class="gp">$ </span>grep<span class="w"> </span><span class="s2">"model"</span><span class="w"> </span>arch/arm/boot/dts/am335x-boneblack*.dts
</span><span id="__span-57-3"><a href="#__codelineno-57-3" id="__codelineno-57-3" name="__codelineno-57-3"></a><span class="hll"><span class="go">arch/arm/boot/dts/am335x-boneblack.dts: model = "TI AM335x BeagleBone Black";</span>
</span></span><span id="__span-57-4"><a href="#__codelineno-57-4" id="__codelineno-57-4" name="__codelineno-57-4"></a><span class="go">arch/arm/boot/dts/am335x-boneblack-wireless.dts:        model = "TI AM335x BeagleBone Black Wireless";</span>
</span><span id="__span-57-5"><a href="#__codelineno-57-5" id="__codelineno-57-5" name="__codelineno-57-5"></a><span class="gp">$ </span>less<span class="w"> </span>arch/arm/boot/dts/am335x-boneblack.dts
</span><span id="__span-57-6"><a href="#__codelineno-57-6" id="__codelineno-57-6" name="__codelineno-57-6"></a><span class="go">    ...</span>
</span><span id="__span-57-7"><a href="#__codelineno-57-7" id="__codelineno-57-7" name="__codelineno-57-7"></a><span class="go">/ {</span>
</span><span id="__span-57-8"><a href="#__codelineno-57-8" id="__codelineno-57-8" name="__codelineno-57-8"></a><span class="hll"><span class="go">        model = "TI AM335x BeagleBone Black";</span>
</span></span><span id="__span-57-9"><a href="#__codelineno-57-9" id="__codelineno-57-9" name="__codelineno-57-9"></a><span class="go">        compatible = "ti,am335x-bone-black", "ti,am335x-bone", "ti,am33xx";</span>
</span><span id="__span-57-10"><a href="#__codelineno-57-10" id="__codelineno-57-10" name="__codelineno-57-10"></a><span class="go">};</span>
</span><span id="__span-57-11"><a href="#__codelineno-57-11" id="__codelineno-57-11" name="__codelineno-57-11"></a><span class="go">    ...</span>
</span><span id="__span-57-12"><a href="#__codelineno-57-12" id="__codelineno-57-12" name="__codelineno-57-12"></a><span class="gp">$ </span>nano<span class="w"> </span>arch/arm/boot/dts/am335x-boneblack-custom.dts
</span><span id="__span-57-13"><a href="#__codelineno-57-13" id="__codelineno-57-13" name="__codelineno-57-13"></a><span class="gp">$ </span>cat<span class="w"> </span>arch/arm/boot/dts/am335x-boneblack-custom.dts
</span><span id="__span-57-14"><a href="#__codelineno-57-14" id="__codelineno-57-14" name="__codelineno-57-14"></a><span class="go">    ...</span>
</span><span id="__span-57-15"><a href="#__codelineno-57-15" id="__codelineno-57-15" name="__codelineno-57-15"></a><span class="hll"><span class="go">/ {</span>
</span></span><span id="__span-57-16"><a href="#__codelineno-57-16" id="__codelineno-57-16" name="__codelineno-57-16"></a><span class="hll"><span class="go">        model = "BeagleBone Black media player";</span>
</span></span><span id="__span-57-17"><a href="#__codelineno-57-17" id="__codelineno-57-17" name="__codelineno-57-17"></a><span class="hll"><span class="go">};</span>
</span></span><span id="__span-57-18"><a href="#__codelineno-57-18" id="__codelineno-57-18" name="__codelineno-57-18"></a><span class="go">    ...</span>
</span><span id="__span-57-19"><a href="#__codelineno-57-19" id="__codelineno-57-19" name="__codelineno-57-19"></a><span class="gp">$ </span>make<span class="w"> </span>dtbs
</span><span id="__span-57-20"><a href="#__codelineno-57-20" id="__codelineno-57-20" name="__codelineno-57-20"></a><span class="go">  DTC     arch/arm/boot/dts/am335x-boneblack-custom.dtb</span>
</span><span id="__span-57-21"><a href="#__codelineno-57-21" id="__codelineno-57-21" name="__codelineno-57-21"></a><span class="gp">$ </span>cp<span class="w"> </span>arch/arm/boot/dts/am335x-boneblack-custom.dtb<span class="w"> </span>/srv/tftp/
</span></code></pre></div>
<p>Recompile the device tree, and reboot the board with it. You should see the new model name in two different places:</p>
<ul>
<li>
<p>In the first kernel messages on the serial console.</p>
</li>
<li>
<p>In <code>/sys/firmware/devicetree/base/model</code>.
  This can be handy for a distribution to identify the device it's running on.<br/>
  By the way, you can explore <code>/sys/firmware/devicetree/</code> and find that every subdirectory corresponds to a <em>DT node</em>, and every file corresponds to a <em>DT property</em>.</p>
</li>
</ul>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-58-1"><a href="#__codelineno-58-1" id="__codelineno-58-1" name="__codelineno-58-1"></a><span class="gp"># </span>cat<span class="w"> </span>/sys/firmware/devicetree/base/model
</span><span id="__span-58-2"><a href="#__codelineno-58-2" id="__codelineno-58-2" name="__codelineno-58-2"></a><span class="go">BeagleBone Black media player</span>
</span></code></pre></div>
<h2 id="committing-kernel-tree-changes"><span class="enumerate-headings-plugin enumerate-heading-plugin">19.13</span> Committing kernel tree changes</h2>
<p>Now that our changes to the kernel sources are over, create a branch for your changes and create a patch for them.<br/>
<strong>Please don't skip this step as we need it for the next labs.</strong></p>
<p>First, if not done yet, you should set your identity and e-mail address in git:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-59-1"><a href="#__codelineno-59-1" id="__codelineno-59-1" name="__codelineno-59-1"></a><span class="gp">$ </span>git<span class="w"> </span>config<span class="w"> </span>--global<span class="w"> </span>user.email<span class="w"> </span><span class="s2">"mail@example.com"</span>
</span><span id="__span-59-2"><a href="#__codelineno-59-2" id="__codelineno-59-2" name="__codelineno-59-2"></a><span class="gp">$ </span>git<span class="w"> </span>config<span class="w"> </span>--global<span class="w"> </span>user.name<span class="w"> </span><span class="s2">"User Name"</span>
</span></code></pre></div>
<p>This is necessary to create a commit with the <code>git commit -s</code> command, as required by the Linux kernel contribution guidelines.</p>
<p>Lets create the branch and the patch now:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-60-1"><a href="#__codelineno-60-1" id="__codelineno-60-1" name="__codelineno-60-1"></a><span class="gp">$ </span>git<span class="w"> </span>status
</span><span id="__span-60-2"><a href="#__codelineno-60-2" id="__codelineno-60-2" name="__codelineno-60-2"></a><span class="hll"><span class="go">On branch embedded-linux-bbb</span>
</span></span><span id="__span-60-3"><a href="#__codelineno-60-3" id="__codelineno-60-3" name="__codelineno-60-3"></a><span class="go">Changes not staged for commit:</span>
</span><span id="__span-60-4"><a href="#__codelineno-60-4" id="__codelineno-60-4" name="__codelineno-60-4"></a><span class="go">  (use "git add &lt;file&gt;..." to update what will be committed)</span>
</span><span id="__span-60-5"><a href="#__codelineno-60-5" id="__codelineno-60-5" name="__codelineno-60-5"></a><span class="go">  (use "git restore &lt;file&gt;..." to discard changes in working directory)</span>
</span><span id="__span-60-6"><a href="#__codelineno-60-6" id="__codelineno-60-6" name="__codelineno-60-6"></a><span class="hll"><span class="go">        modified:   arch/arm/boot/dts/Makefile</span>
</span></span><span id="__span-60-7"><a href="#__codelineno-60-7" id="__codelineno-60-7" name="__codelineno-60-7"></a>
</span><span id="__span-60-8"><a href="#__codelineno-60-8" id="__codelineno-60-8" name="__codelineno-60-8"></a><span class="go">Untracked files:</span>
</span><span id="__span-60-9"><a href="#__codelineno-60-9" id="__codelineno-60-9" name="__codelineno-60-9"></a><span class="go">  (use "git add &lt;file&gt;..." to include in what will be committed)</span>
</span><span id="__span-60-10"><a href="#__codelineno-60-10" id="__codelineno-60-10" name="__codelineno-60-10"></a><span class="hll"><span class="go">        arch/arm/boot/dts/am335x-boneblack-custom.dts</span>
</span></span><span id="__span-60-11"><a href="#__codelineno-60-11" id="__codelineno-60-11" name="__codelineno-60-11"></a>
</span><span id="__span-60-12"><a href="#__codelineno-60-12" id="__codelineno-60-12" name="__codelineno-60-12"></a><span class="go">no changes added to commit (use "git add" and/or "git commit -a")</span>
</span><span id="__span-60-13"><a href="#__codelineno-60-13" id="__codelineno-60-13" name="__codelineno-60-13"></a><span class="gp">$ </span>git<span class="w"> </span>add<span class="w"> </span>arch/arm/boot/dts/am335x-boneblack-custom.dts
</span><span id="__span-60-14"><a href="#__codelineno-60-14" id="__codelineno-60-14" name="__codelineno-60-14"></a><span class="gp">$ </span>git<span class="w"> </span>commit<span class="w"> </span>-as<span class="w"> </span>-m<span class="w"> </span><span class="s2">"Custom DTS for Bootlin lab"</span>
</span><span id="__span-60-15"><a href="#__codelineno-60-15" id="__codelineno-60-15" name="__codelineno-60-15"></a><span class="go">[embedded-linux-bbb bb7e1269527c] Custom DTS for Bootlin lab</span>
</span><span id="__span-60-16"><a href="#__codelineno-60-16" id="__codelineno-60-16" name="__codelineno-60-16"></a><span class="go"> 2 files changed, 28 insertions(+)</span>
</span><span id="__span-60-17"><a href="#__codelineno-60-17" id="__codelineno-60-17" name="__codelineno-60-17"></a><span class="go"> create mode 100644 arch/arm/boot/dts/am335x-boneblack-custom.dts</span>
</span><span id="__span-60-18"><a href="#__codelineno-60-18" id="__codelineno-60-18" name="__codelineno-60-18"></a><span class="gp">$ </span><span class="nv">label</span><span class="o">=</span><span class="s2">"v5.15.104"</span>
</span><span id="__span-60-19"><a href="#__codelineno-60-19" id="__codelineno-60-19" name="__codelineno-60-19"></a><span class="gp">$ </span>git<span class="w"> </span>tag<span class="w"> </span><span class="s2">"</span><span class="nv">$label</span><span class="s2">-nunchuk"</span>
</span></code></pre></div>
<p>We can now create the patch with <code>git format-patch</code>.<br/>
This should generate a <code>0001-Custom-DTS-for-Bootlin-lab.patch</code> file.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-61-1"><a href="#__codelineno-61-1" id="__codelineno-61-1" name="__codelineno-61-1"></a><span class="gp">$ </span><span class="nv">label</span><span class="o">=</span><span class="s2">"v5.15.104"</span>
</span><span id="__span-61-2"><a href="#__codelineno-61-2" id="__codelineno-61-2" name="__codelineno-61-2"></a><span class="gp">$ </span>git<span class="w"> </span>format-patch<span class="w"> </span><span class="nv">$label</span>
</span><span id="__span-61-3"><a href="#__codelineno-61-3" id="__codelineno-61-3" name="__codelineno-61-3"></a><span class="go">0001-Custom-DTS-for-Bootlin-lab.patch</span>
</span><span id="__span-61-4"><a href="#__codelineno-61-4" id="__codelineno-61-4" name="__codelineno-61-4"></a><span class="gp">$ </span>cp<span class="w"> </span><span class="s2">"0001-Custom-DTS-for-Bootlin-lab.patch"</span><span class="w"> </span><span class="nv">$LAB_PATH</span>
</span></code></pre></div>
<p>Creating the branch will impact the versions of the kernel and the modules.<br/>
Compile your kernel and install your modules again and see the version changes through the new base directory for modules.</p>
<p>To save space for the next lab, remove the old directory under <code>lib/modules/</code> containing the dirty modules.</p>
<p>Dont forget to update the kernel your board boots.</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-62-1"><a href="#__codelineno-62-1" id="__codelineno-62-1" name="__codelineno-62-1"></a><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/../kernel/linux/"</span>
</span><span id="__span-62-2"><a href="#__codelineno-62-2" id="__codelineno-62-2" name="__codelineno-62-2"></a><span class="gp">$ </span><span class="nb">export</span><span class="w"> </span><span class="nv">INSTALL_MOD_PATH</span><span class="o">=</span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/../tinysystem/nfsroot"</span>
</span><span id="__span-62-3"><a href="#__codelineno-62-3" id="__codelineno-62-3" name="__codelineno-62-3"></a><span class="gp">$ </span>make
</span><span id="__span-62-4"><a href="#__codelineno-62-4" id="__codelineno-62-4" name="__codelineno-62-4"></a><span class="gp">$ </span>make<span class="w"> </span>modules
</span><span id="__span-62-5"><a href="#__codelineno-62-5" id="__codelineno-62-5" name="__codelineno-62-5"></a><span class="gp">$ </span>make<span class="w"> </span>modules_install
</span><span id="__span-62-6"><a href="#__codelineno-62-6" id="__codelineno-62-6" name="__codelineno-62-6"></a><span class="gp">$ </span>cp<span class="w"> </span>arch/arm/boot/zImage<span class="w"> </span>/srv/tftp/zImage
</span></code></pre></div>
<div class="language-console highlight"><pre><span></span><code><span id="__span-63-1"><a href="#__codelineno-63-1" id="__codelineno-63-1" name="__codelineno-63-1"></a><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/../tinysystem/nfsroot/lib/modules/"</span>
</span><span id="__span-63-2"><a href="#__codelineno-63-2" id="__codelineno-63-2" name="__codelineno-63-2"></a><span class="gp">$ </span>ls<span class="w"> </span>-1
</span><span id="__span-63-3"><a href="#__codelineno-63-3" id="__codelineno-63-3" name="__codelineno-63-3"></a><span class="hll"><span class="go">5.15.104-00001-gbb7e1269527c</span>
</span></span><span id="__span-63-4"><a href="#__codelineno-63-4" id="__codelineno-63-4" name="__codelineno-63-4"></a><span class="go">5.15.104-dirty</span>
</span><span id="__span-63-5"><a href="#__codelineno-63-5" id="__codelineno-63-5" name="__codelineno-63-5"></a><span class="gp">$ </span>rm<span class="w"> </span>-rf<span class="w"> </span><span class="s2">"5.15.104-dirty/"</span>
</span></code></pre></div>
<div class="language-console highlight"><pre><span></span><code><span id="__span-64-1"><a href="#__codelineno-64-1" id="__codelineno-64-1" name="__codelineno-64-1"></a><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/data/nunchuk/"</span>
</span><span id="__span-64-2"><a href="#__codelineno-64-2" id="__codelineno-64-2" name="__codelineno-64-2"></a><span class="gp">$ </span>make<span class="w"> </span>-C<span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/../kernel/linux"</span><span class="w"> </span><span class="nv">M</span><span class="o">=</span><span class="nv">$PWD</span>
</span><span id="__span-64-3"><a href="#__codelineno-64-3" id="__codelineno-64-3" name="__codelineno-64-3"></a><span class="gp">$ </span>make<span class="w"> </span>-C<span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/../kernel/linux"</span><span class="w"> </span><span class="nv">M</span><span class="o">=</span><span class="nv">$PWD</span><span class="w"> </span>modules_install
</span></code></pre></div>
<p>Reboot your board and make sure everything's alright!</p>
<div class="language-console highlight"><span class="filename">picocomBBB - BusyBox</span><pre><span></span><code><span id="__span-65-1"><a href="#__codelineno-65-1" id="__codelineno-65-1" name="__codelineno-65-1"></a><span class="gp"># </span>uname<span class="w"> </span>-r
</span><span id="__span-65-2"><a href="#__codelineno-65-2" id="__codelineno-65-2" name="__codelineno-65-2"></a><span class="go">5.15.104-00001-gbb7e1269527c</span>
</span><span id="__span-65-3"><a href="#__codelineno-65-3" id="__codelineno-65-3" name="__codelineno-65-3"></a><span class="gp"># </span>modprobe<span class="w"> </span>nunchuk
</span><span id="__span-65-4"><a href="#__codelineno-65-4" id="__codelineno-65-4" name="__codelineno-65-4"></a><span class="go">nunchuk: loading out-of-tree module taints kernel.</span>
</span><span id="__span-65-5"><a href="#__codelineno-65-5" id="__codelineno-65-5" name="__codelineno-65-5"></a><span class="go">input: Wii Nunchuk as /devices/platform/ocp/48000000.interconnect/48000000.interconnect:segment@0/4802a000.target-module/4802a000.i2c/i2c-1/1-0052/input/input0</span>
</span><span id="__span-65-6"><a href="#__codelineno-65-6" id="__codelineno-65-6" name="__codelineno-65-6"></a><span class="go">Nunchuk device probed successfully</span>
</span></code></pre></div>
<h2 id="backup-and-restore"><span class="enumerate-headings-plugin enumerate-heading-plugin">19.14</span> Backup and restore</h2>
<div class="language-console highlight"><pre><span></span><code><span id="__span-66-1"><a href="#__codelineno-66-1" id="__codelineno-66-1" name="__codelineno-66-1"></a><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/../tinysystem/nfsroot/"</span>
</span><span id="__span-66-2"><a href="#__codelineno-66-2" id="__codelineno-66-2" name="__codelineno-66-2"></a><span class="gp">$ </span>find<span class="w"> </span>.<span class="w"> </span>-depth<span class="w"> </span>-print0<span class="w"> </span><span class="p">|</span><span class="w"> </span>cpio<span class="w"> </span>-ocv0<span class="w"> </span><span class="p">|</span><span class="w"> </span>xz<span class="w"> </span>&gt;<span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/nfsroot-hardware.cpio.xz"</span>
</span><span id="__span-66-3"><a href="#__codelineno-66-3" id="__codelineno-66-3" name="__codelineno-66-3"></a><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span>/srv/tftp/
</span><span id="__span-66-4"><a href="#__codelineno-66-4" id="__codelineno-66-4" name="__codelineno-66-4"></a><span class="gp">$ </span>tar<span class="w"> </span>cfJv<span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/hardware-tftp.tar.xz"</span><span class="w"> </span>zImage<span class="w"> </span>am335x-boneblack-custom.dtb
</span></code></pre></div>
<h3 id="git-bundle"><span class="enumerate-headings-plugin enumerate-heading-plugin">19.14.1</span> git bundle</h3>
<p>To create a <em>git bundle</em> with just our patch (to have consistent <em>git commit</em> naming):</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-67-1"><a href="#__codelineno-67-1" id="__codelineno-67-1" name="__codelineno-67-1"></a><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/../kernel/linux/"</span>
</span><span id="__span-67-2"><a href="#__codelineno-67-2" id="__codelineno-67-2" name="__codelineno-67-2"></a><span class="gp">$ </span><span class="nv">label</span><span class="o">=</span><span class="s2">"v5.15.104"</span>
</span><span id="__span-67-3"><a href="#__codelineno-67-3" id="__codelineno-67-3" name="__codelineno-67-3"></a><span class="gp">$ </span><span class="nv">bundle</span><span class="o">=</span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/kernel-linux-</span><span class="nv">$label</span><span class="s2">-nunchuk.bundle"</span>
</span><span id="__span-67-4"><a href="#__codelineno-67-4" id="__codelineno-67-4" name="__codelineno-67-4"></a><span class="gp">$ </span>git<span class="w"> </span>bundle<span class="w"> </span>create<span class="w"> </span><span class="nv">$bundle</span><span class="w"> </span><span class="nv">$label</span>..
</span></code></pre></div>
<p>To restore the <em>git bundle</em>:</p>
<div class="language-console highlight"><pre><span></span><code><span id="__span-68-1"><a href="#__codelineno-68-1" id="__codelineno-68-1" name="__codelineno-68-1"></a><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/../kernel/linux/"</span>
</span><span id="__span-68-2"><a href="#__codelineno-68-2" id="__codelineno-68-2" name="__codelineno-68-2"></a><span class="gp">$ </span><span class="nv">label</span><span class="o">=</span><span class="s2">"v5.15.104"</span>
</span><span id="__span-68-3"><a href="#__codelineno-68-3" id="__codelineno-68-3" name="__codelineno-68-3"></a><span class="gp">$ </span><span class="nv">bundle</span><span class="o">=</span><span class="s2">"</span><span class="nv">$LAB_PATH</span><span class="s2">/kernel-linux-</span><span class="nv">$label</span><span class="s2">-nunchuk.bundle"</span>
</span><span id="__span-68-4"><a href="#__codelineno-68-4" id="__codelineno-68-4" name="__codelineno-68-4"></a><span class="gp">$ </span>git<span class="w"> </span>bundle<span class="w"> </span>verify<span class="w"> </span><span class="nv">$bundle</span>
</span><span id="__span-68-5"><a href="#__codelineno-68-5" id="__codelineno-68-5" name="__codelineno-68-5"></a><span class="go">The bundle contains this ref:</span>
</span><span id="__span-68-6"><a href="#__codelineno-68-6" id="__codelineno-68-6" name="__codelineno-68-6"></a><span class="go">bb7e1269527c6b56c1c5b15b1b1a5c05a2f114f2 HEAD</span>
</span><span id="__span-68-7"><a href="#__codelineno-68-7" id="__codelineno-68-7" name="__codelineno-68-7"></a><span class="go">The bundle requires this ref:</span>
</span><span id="__span-68-8"><a href="#__codelineno-68-8" id="__codelineno-68-8" name="__codelineno-68-8"></a><span class="go">115472395b0a9ea522ba0e106d6dfd7a73df8ba6</span>
</span><span id="__span-68-9"><a href="#__codelineno-68-9" id="__codelineno-68-9" name="__codelineno-68-9"></a><span class="go">/home/me/embedded-linux-bbb-labs/hardware/kernel-linux-v5.15.104-nunchuk.bundle is okay</span>
</span><span id="__span-68-10"><a href="#__codelineno-68-10" id="__codelineno-68-10" name="__codelineno-68-10"></a><span class="gp">$ </span>git<span class="w"> </span>checkout<span class="w"> </span>-b<span class="w"> </span>embedded-linux-bbb<span class="w"> </span><span class="nv">$label</span>
</span><span id="__span-68-11"><a href="#__codelineno-68-11" id="__codelineno-68-11" name="__codelineno-68-11"></a><span class="go">    ...</span>
</span><span id="__span-68-12"><a href="#__codelineno-68-12" id="__codelineno-68-12" name="__codelineno-68-12"></a><span class="gp">$ </span>git<span class="w"> </span>bundle<span class="w"> </span>list-heads<span class="w"> </span><span class="nv">$bundle</span>
</span><span id="__span-68-13"><a href="#__codelineno-68-13" id="__codelineno-68-13" name="__codelineno-68-13"></a><span class="go">bb7e1269527c6b56c1c5b15b1b1a5c05a2f114f2 HEAD</span>
</span><span id="__span-68-14"><a href="#__codelineno-68-14" id="__codelineno-68-14" name="__codelineno-68-14"></a><span class="gp">$ </span>git<span class="w"> </span>pull<span class="w"> </span><span class="nv">$bundle</span>
</span></code></pre></div>
<h2 id="licensing"><span class="enumerate-headings-plugin enumerate-heading-plugin">19.15</span> Licensing</h2>
<p>This document is an extension to: <a href="https://bootlin.com/doc/training/embedded-linux-bbb/"><em>Embedded Linux System Development - Practical Labs - BeagleBone Black Variant</em></a>
   2004-2023, <em>Bootlin</em> <a href="https://bootlin.com">https://bootlin.com/</a>, <a href="(https://creativecommons.org/licenses/by-sa/3.0/)"><code>CC-BY-SA-3.0</code></a> license.</p>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
<script src="../../assets/javascripts/bundle.fac441b0.min.js"></script>
</body>
</html>